# Silent-NAS 开发任务清单（v0.7.0 核心）

当前版本: v0.7.0-dev

上一版本: v0.6.0 ✅ 已完成（分布式功能与协议完善）

产品路线图: [ROADMAP.md](ROADMAP.md)

---

## 🎯 版本存储优化（最高优先级）

### 目标
- 存储空间节省: 40%+
- 版本管理效率提升: 50%+
- 冷热数据自动分离
- 跨文件块级去重

### 任务清单

#### 1. 增量存储与差异算法 ✅ 已完成
- [x] 文件级增量存储
  - [x] 方案设计：基于块差异的存储策略
  - [x] 实现版本链式存储
  - [x] 支持随机访问读取
  - [ ] 性能基准测试（vs 完整存储）
- [x] 差异算法实现
  - [x] 滚动哈希算法（Rabin-Karp）
  - [x] 弱哈希 + 强哈希双校验
  - [x] 边界块检测优化
  - [x] 差异块压缩算法（基础实现）
- [x] 存储格式设计
  - [x] 版本元数据结构
  - [x] 块索引格式
  - [x] 差异数据布局
  - [x] 向后兼容策略

**实现位置**: `src/storage_v2/`
**核心文件**:
- `chunker.rs`: 滚动哈希分块器（Rabin-Karp）
- `delta.rs`: 差异生成与应用
- `storage.rs`: 增量存储后端
- `index.rs`: 全局块索引管理

#### 2. 自动压缩与冷热分离 ✅ 已完成
- [x] 压缩策略
  - [x] LZ4/Zstd 压缩算法集成
  - [x] 冷数据自动压缩
  - [x] 压缩比监控指标
  - [x] 压缩性能优化
- [x] 冷热分离
  - [x] 访问频率统计（基于LRU）
  - [x] 冷热数据分层存储
  - [x] 自动迁移策略
  - [x] 存储位置映射表
- [x] 数据生命周期管理
  - [x] TTL 配置支持
  - [x] 版本保留策略
  - [x] 自动清理机制

**实现位置**: `src/storage_v2/`
**核心文件**:
- `compression.rs`: LZ4/Zstd 压缩算法
- `tiering.rs`: 冷热数据分层管理
- `lifecycle.rs`: 数据生命周期管理

**关键指标**:
- 冷数据自动压缩阈值：7天未访问
- 分层容量：热10GB/温100GB/冷无限制
- 自动迁移间隔：1小时
- 清理批大小：100项/次

#### 3. 跨文件块级去重 ✅ 已完成
- [x] 全局块索引
  - [x] 块哈希映射表（文件ID -> 块位置）
  - [x] 内存中热索引
  - [x] 磁盘持久化索引
  - [x] 索引一致性保证
- [x] 去重算法
  - [x] 固定分块 vs 内容定义分块
  - [x] 块重复检测
  - [x] 引用计数管理
  - [x] 块级Copy-on-Write
- [x] 性能优化
  - [x] 索引缓存策略
  - [x] 批量去重操作
  - [x] 并发去重控制
  - [x] 内存使用优化

**实现位置**: `src/storage_v2/`
**核心文件**:
- `dedup.rs`: 跨文件块级去重管理

#### 4. 存储引擎优化 ✅ 已完成
- [x] I/O 优化
  - [x] 顺序写入优化
  - [x] 随机读缓存
  - [x] 预读策略
  - [x] 写放大控制
- [x] 并发控制
  - [x] 多版本并发控制（MVCC）
  - [x] 读写锁分离
  - [x] 写入队列管理
  - [x] 锁竞争优化

**实现位置**: `src/storage_v2/`
**核心文件**:
- `engine.rs`: 存储引擎优化核心

#### 5. 兼容性保障 ✅ 已完成
- [x] 平滑迁移
  - [x] 现有存储格式兼容
  - [x] 在线迁移方案
  - [x] 迁移进度监控
  - [x] 回滚机制
- [x] API 兼容性
  - [x] 现有 API 不变
  - [x] 性能提升透明
  - [x] 新增可选参数

**实现位置**: `src/storage_v2/`
**核心文件**:
- `compatibility.rs`: 兼容性保障核心

---

## 🎯 搜索功能增强

### 目标
- 搜索响应时间: < 100ms
- 全文搜索覆盖率: 95%+
- 搜索结果准确性: 90%+
- 高级过滤支持

### 任务清单

#### 1. 文件内容全文搜索
- [ ] 搜索引擎选型
  - [ ] Tantivy 集成（Rust native）
  - [ ] Elasticsearch 备选方案
  - [ ] 性能对比测试
  - [ ] 存储需求评估
- [ ] 索引构建
  - [ ] 文件内容提取器（PDF/DOC/TXT/HTML等）
  - [ ] 文本分词与标准化
  - [ ] 倒排索引构建
  - [ ] 增量索引更新
- [ ] 搜索API
  - [ ] 全文检索端点
  - [ ] 关键字高亮
  - [ ] 搜索结果排序
  - [ ] 分页支持

#### 2. 高级过滤与搜索建议
- [ ] 过滤条件
  - [ ] 文件类型过滤
  - [ ] 大小范围过滤
  - [ ] 修改时间过滤
  - [ ] 自定义标签过滤
- [ ] 搜索建议
  - [ ] 自动补全
  - [ ] 拼写纠错
  - [ ] 相关搜索推荐
  - [ ] 热门搜索词
- [ ] 搜索历史
  - [ ] 用户搜索记录
  - [ ] 搜索统计
  - [ ] 个性化推荐

#### 3. WebDAV/S3 搜索集成
- [ ] WebDAV 搜索
  - [ ] SEARCH 方法实现（RFC 5323）
  - [ ] 自定义搜索属性
  - [ ] 复杂条件查询
  - [ ] 搜索结果WebDAV格式
- [ ] S3 搜索
  - [ ] S3 Select 兼容
  - [ ] SQL-like 查询语法
  - [ ] 对象标签查询
  - [ ] 元数据查询
- [ ] 统一搜索接口
  - [ ] 跨协议搜索
  - [ ] 搜索结果聚合
  - [ ] 搜索权限控制

#### 4. 性能优化
- [ ] 索引优化
  - [ ] 索引压缩
  - [ ] 索引分片
  - [ ] 索引缓存
  - [ ] 索引更新优化
- [ ] 查询优化
  - [ ] 查询缓存
  - [ ] 查询计划优化
  - [ ] 并行查询
  - [ ] 早停机制

---

## 🎯 性能监控完善

### 目标
- 并发连接支持: 1000+
- 系统吞吐量提升: 50%+
- 资源利用率优化
- 性能基准确立

### 任务清单

#### 1. Prometheus 指标补充
- [ ] 存储指标
  - [ ] 版本存储使用率
  - [ ] 压缩比统计
  - [ ] 去重效率指标
  - [ ] I/O 吞吐量
- [ ] 搜索指标
  - [ ] 索引构建时间
  - [ ] 查询响应时间（P50/P90/P95/P99）
  - [ ] 索引大小
  - [ ] 搜索吞吐量
- [ ] 系统资源
  - [ ] CPU 使用率（按模块）
  - [ ] 内存使用（堆/栈/缓存）
  - [ ] 磁盘 I/O（读写 IOPS）
  - [ ] 网络带宽使用
- [ ] 业务指标
  - [ ] 活跃用户数
  - [ ] 请求成功率
  - [ ] 错误率统计
  - [ ] 热点文件访问

#### 2. 性能基准测试套件
- [ ] 测试框架
  - [ ] 自动化测试脚本
  - [ ] 多种负载模型
  - [ ] 压力测试工具
  - [ ] 性能回归检测
- [ ] 基准测试场景
  - [ ] 存储性能基准（顺序/随机读写）
  - [ ] 搜索性能基准（不同数据规模）
  - [ ] 同步性能基准（多节点）
  - [ ] 并发性能基准（100/500/1000连接）
- [ ] 性能报告
  - [ ] 自动生成性能报告
  - [ ] 性能趋势分析
  - [ ] 瓶颈识别
  - [ ] 优化建议

#### 3. 缓存策略优化
- [ ] 多级缓存
  - [ ] 内存缓存（LRU）
  - [ ] SSD 缓存
  - [ ] 分布式缓存
  - [ ] 缓存一致性
- [ ] 缓存策略
  - [ ] 预加载策略
  - [ ] 缓存淘汰算法
  - [ ] 缓存穿透防护
  - [ ] 缓存雪崩防护
- [ ] 热点数据处理
  - [ ] 热点识别算法
  - [ ] 热点数据预热
  - [ ] 热点数据保护
  - [ ] 热点降级策略

#### 4. 告警与自愈
- [ ] 告警规则
  - [ ] 性能阈值告警
  - [ ] 资源使用告警
  - [ ] 错误率告警
  - [ ] 自定义告警规则
- [ ] 自动恢复
  - [ ] 自动扩缩容
  - [ ] 故障转移
  - [ ] 数据修复
  - [ ] 服务重启

---

## 📊 关键里程碑

### Phase 1: 版本存储优化（v0.7.0-alpha）
- 增量存储实现
- 差异算法完成
- 块级去重上线
- 性能测试验证

### Phase 2: 搜索功能增强（v0.7.0-beta）
- 全文搜索上线
- 高级过滤支持
- WebDAV/S3 集成
- 搜索性能优化

### Phase 3: 性能监控完善（v0.7.0-rc）
- 指标体系完善
- 基准测试完成
- 缓存优化上线
- 性能验收通过

### Phase 4: 发布 v0.7.0（正式版）
- 文档完善
- 性能优化总结
- 发布准备

---

## 📈 验收标准

### 版本存储优化
- [ ] 存储空间节省 ≥ 40%
- [ ] 读取性能下降 ≤ 10%
- [ ] 写入性能下降 ≤ 20%
- [ ] 版本恢复时间 ≤ 5s

### 搜索功能增强
- [ ] 全文搜索响应时间 ≤ 100ms（P95）
- [ ] 索引构建速度 ≥ 100MB/s
- [ ] 搜索结果准确性 ≥ 90%
- [ ] 索引存储开销 ≤ 原始数据30%

### 性能监控完善
- [ ] 并发连接支持 ≥ 1000
- [ ] 系统吞吐量提升 ≥ 50%
- [ ] 指标覆盖度 ≥ 90%
- [ ] 基准测试自动化率 = 100%

---

## 🚀 开发优先级建议

1. **第1周**: 版本存储方案设计与原型
2. **第2-4周**: 增量存储与差异算法实现
3. **第5-6周**: 块级去重实现
4. **第7-8周**: 搜索引擎集成
5. **第9-10周**: 高级搜索功能
6. **第11-12周**: 性能指标完善
7. **第13-14周**: 基准测试与优化
8. **第15-16周**: 系统测试与发布准备

---

**注意**: 本TODO基于v0.7.0规划，具体实现可能根据开发进度调整。详见 [ROADMAP.md](ROADMAP.md) 了解长期规划。
