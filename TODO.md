# Silent-NAS 开发任务清单（仅待完成项）

当前版本: v0.6.0-dev

产品路线图: [ROADMAP.md](ROADMAP.md)

---

## P0 当前迭代目标（v0.6.0 核心）

1) 分布式文件同步（gRPC 跨节点）
- 待完成：
  - 重试与回退：
    - 统一连接/请求/流式传输超时
    - 指数退避 + 抖动策略（设置最大退避与总预算时间）
    - 错误分级：Retriable/Non‑retriable/Fatal 与原因码定义
  - 一致性与校验：
    - 端到端 SHA‑256 校验（分块 MD5 已在服务端校验）
    - 失败补偿重拉：失败队列 + 后台 worker（带退避）
    - 指标：成功率/重试次数/阶段时延/吞吐量上报
  - 自动同步稳定性：
    - 并发/批量/间隔参数可配（支持热更新或定时重载）
    - 同步阶段埋点：连接/状态同步/内容传输
  - 端到端演练：
    - 验收阈值：延迟 < 5s，成功率 > 99.9%
  - 已完成：
    - 三节点拓扑压测脚本（Docker 版本统一）：`scripts/sync_3nodes_benchmark_docker.sh`
    - 端到端 SHA‑256 校验落地：增量/全量拉取均校验，校验通过才保存（事件监听与巡检补拉）
    - 拉取超时/重试/退避配置化：`[sync] http_connect_timeout/http_request_timeout/fetch_max_retries/fetch_base_backoff/fetch_max_backoff`
    - gRPC 重试与上限统一：NodeSyncClient.max_retries 由 `[sync].max_retries` 驱动
    - 指标埋点（初版）：全量/增量同步成功与失败计数与字节数上报
    - 单节点优化：未连接 NATS 时不启用巡检补拉任务；单节点可省略 `[sync]` 配置
  - 文档同步：
    - 运行参数与调试指引、故障注入与排障章节

  - 下一步计划（按优先级推进）：
    1) 失败补偿队列 + 后台 worker（增强）
       - 已完成：失败队列持久化至 <root>/.sync/fail_queue.json（自动加载/保存）
       - 待完善：失败任务持久化字段扩充与清理策略（容量/过期）
    2) 指标埋点与统计（增强）
       - 成功/失败/重试次数/字节数/阶段时延（直方图）
       - 输出 P50/P90/P95/Max；暴露到 /metrics 端点
    3) 参数可配与热更新
       - `sync.{interval, max_concurrency, batch_size, retry_max, timeouts}`
       - 提供定时重载或 SIGHUP 重载配置
    4) 同步阶段 tracing 埋点
       - 连接、状态同步、内容传输阶段划分，携带 file_id
    5) 故障注入与排障指引
       - 环境开关模拟超时/断连/限速；文档化排障流程
    6) 验收回归
       - 使用 `scripts/sync_3nodes_benchmark_docker.sh` 达成 P95<8s、成功率>99.9%

2) WebDAV 协议完善
- 待完成：
  - 锁与并发：共享锁完整语义与冲突矩阵、LOCK Body 解析完善
  - 条件请求：If 头完整表达式（多资源/多令牌/并列条件）
  - 属性模型：PROPPATCH 命名空间解析与属性模型结构化、复杂属性校验
  - 报告扩展：REPORT 报告类型扩展与过滤场景
  - 互通用例：完善 Cyberduck/Nextcloud 用例与结果记录

---

## P1 后续（v0.7.0 候选）

- 版本存储优化：增量存储、差异算法、冷热分离、块级去重
- 搜索功能增强：全文搜索、过滤与建议、协议层搜索集成
- 性能监控完善：指标补充、基准测试套件、缓存策略优化

---

## 后续拓展（Enterprise）Backlog

- 权限与安全：路径级 ACL、用户组与组权限、用户存储配额、完整 RBAC、审计与合规、传输与静态加密
- 多租户与隔离：多租户隔离、共享链接与外部协作
- S3 企业增强：对象标签、对象 ACL、生命周期管理、预签名 URL、CORS 配置

---

## 技术债务

- 搜索索引大小控制与维护策略（与搜索增强关联）
- 错误码与日志规范统一（跨服务一致性）
- 事件监听回退链路复查（HTTP 拉取失败 -> WebDAV 回退的健壮性）
- WebDAV 路径与存储路径的边界与转义规则对齐
