# Silent-NAS 开发任务列表

> 基于 README.md 分析生成 | 更新时间: 2025-10-15

## 📊 当前进度概览

### 已完成 (Phase 1-2) ✅
- ✅ 核心传输层（QUIC/gRPC/HTTP）
- ✅ 文件存储管理（上传/下载/删除/元数据）
- ✅ 事件推送系统（NATS）
- ✅ WebDAV 完整支持
- ✅ S3 兼容 API（核心功能 + 高级特性）
- ✅ HTTP 条件请求与缓存优化
- ✅ 断点续传与分片上传

### 已完成 (Phase 2-3) ✅
- ✅ CRDT 文件同步与冲突合并 (2025-10-15 完成)
- ✅ 文件版本管理系统 (2025-10-15 完成)

### 已完成 (Phase 3) ✅
- ✅ 跨节点同步基础框架 (2025-10-16 完成)

### 已完成 (Phase 3-4) ✅
- ✅ 跨节点同步 gRPC 服务端实现 (2025-10-16 完成)
- ✅ 跨节点同步 gRPC 客户端实现 (2025-10-16 完成)

### 进行中 (Phase 4) 🚧
- ✅ 事件驱动的内容同步（HTTP + WebDAV 回退）
  - [x] 监听 NATS 事件，按 source_http_addr 拉取内容
  - [x] 成功后按 metadata.path 落盘，保持多协议共享同一存储
  - [x] 定期巡检补拉，修正短时失败
  - [x] 增量同步（按块/差异）(2025-10-17 完成)

---

## 🎯 接下来开发的内容（优先级排序）

### 高优先级 (P0) - 核心功能完善

#### 1. 文件版本管理系统 ✅ **已完成 (2025-10-15)**
**目标**: 实现完整的文件版本控制，支持版本回退和历史查询

**任务清单**:
- [x] 设计版本存储结构
  - [x] 版本元数据表（version_id, file_id, created_at, author, size, hash）
  - [x] 版本内容存储策略（全量存储）
  - [x] 版本索引与快速查询（内存 HashMap）
- [x] 实现版本 HTTP API
  - [x] `GET /api/files/{id}/versions` - 列出版本历史
  - [x] `GET /api/files/{id}/versions/{version_id}` - 获取特定版本内容
  - [x] `POST /api/files/{id}/versions/{version_id}/restore` - 恢复到指定版本
  - [x] `DELETE /api/files/{id}/versions/{version_id}` - 删除版本
  - [x] `GET /api/versions/stats` - 版本统计信息
- [x] 配置选项
  - [x] 最大版本数量限制 (默认10)
  - [x] 版本保留时长 (默认30天)
  - [x] 启用/禁用版本管理
- [x] 集成到主服务器
  - [x] 在 main.rs 中初始化版本管理器
  - [x] 注册所有 HTTP API 路由
  - [x] 与文件上传/修改事件集成

**实际工期**: 6小时
**验证方式**: HTTP API 测试通过，完整测试覆盖

**注意**: 基础版本管理已完成，但 S3 和 WebDAV 协议的版本控制扩展尚未实现，见下方任务3

---

#### 2. CRDT 文件同步与冲突合并 ✅ **已完成 (2025-10-15)**
**目标**: 实现基于 CRDT 的多客户端文件同步，自动处理冲突

**任务清单**:
- [x] 集成 silent-crdt 依赖
  - [x] 添加 silent-crdt 到 Cargo.toml
- [x] 实现文件同步模块 (`sync.rs`)
  - [x] 文件状态追踪（LWW-Register）
  - [x] 元数据合并策略
  - [x] 内容冲突检测
  - [x] 自动合并算法
- [x] 冲突处理策略
  - [x] LWW（Last-Write-Wins）基于时间戳
  - [x] 保留冲突副本（.conflict 文件）
  - [x] 用户手动合并接口
- [x] NATS 事件集成
  - [x] 监听文件变更事件
  - [x] 触发 CRDT 同步
  - [x] 广播合并结果
- [x] 冲突解决 API
  - [x] `GET /api/conflicts` - 列出冲突
  - [x] `POST /api/conflicts/{id}/resolve` - 解决冲突
  - [x] `GET /api/sync/status` - 同步状态
  - [ ] 设计文件元数据 CRDT 结构
- [x] 实现文件同步模块 (`sync.rs`)
  - [ ] 文件状态追踪（LWW-Register）
  - [ ] 元数据合并策略
  - [ ] 内容冲突检测
  - [ ] 自动合并算法
- [ ] 冲突处理策略
  - [ ] LWW（Last-Write-Wins）基于时间戳
  - [ ] 保留冲突副本（.conflict 文件）
  - [ ] 用户手动合并接口
- [x] NATS 事件集成
  - [ ] 监听文件变更事件
- [x] 触发 CRDT 同步
  - [ ] 广播合并结果
- [ ] 冲突解决 API
  - [ ] `GET /api/conflicts` - 列出冲突
  - [ ] `POST /api/conflicts/{id}/resolve` - 解决冲突
- [x] `GET /api/sync/status` - 同步状态

**预计工期**: 2-3周
**依赖**: silent-crdt 项目
**验证方式**: 多客户端并发写入同一文件，验证自动合并

---

### 中优先级 (P1) - 功能增强

#### 3. S3/WebDAV 版本控制扩展
**目标**: 为 S3 和 WebDAV 协议添加版本控制支持

**任务清单**:
- [ ] S3 版本控制支持
  - [ ] 实现 `GetBucketVersioning`
  - [ ] 实现 `PutBucketVersioning`
  - [ ] 实现 `ListObjectVersions`
  - [ ] 集成现有的 version.rs 模块
- [ ] WebDAV 版本扩展
  - [ ] 实现 `VERSION-CONTROL` 方法
  - [ ] 实现 `REPORT` 方法
  - [ ] DeltaV 协议支持

**预计工期**: 1周
**依赖**: version.rs 模块 ✅
**验证方式**: AWS CLI 和 WebDAV 客户端测试

---

#### 4. S3 高级功能扩展
**目标**: 完善 S3 兼容性，支持更多高级特性

**任务清单**:
- [ ] 对象标签 (Object Tagging)
  - [ ] `PutObjectTagging`
  - [ ] `GetObjectTagging`
  - [ ] `DeleteObjectTagging`
- [ ] 访问控制列表 (ACL)
  - [ ] `PutBucketAcl`
  - [ ] `GetBucketAcl`
  - [ ] `PutObjectAcl`
  - [ ] `GetObjectAcl`
- [ ] 生命周期管理
  - [ ] `PutBucketLifecycle`
  - [ ] `GetBucketLifecycle`
  - [ ] 自动过期删除任务
- [ ] Presigned URL 支持
  - [ ] 生成临时访问 URL
  - [ ] URL 签名验证
  - [ ] 过期时间控制
- [ ] CORS 配置
  - [ ] `PutBucketCors`
  - [ ] `GetBucketCors`
  - [ ] 跨域请求处理

**预计工期**: 2周
**依赖**: 当前 S3 实现
**验证方式**: AWS CLI 和 boto3 完整测试

---

#### 5. WebDAV 高级功能
**目标**: 完善 WebDAV 协议支持，提升客户端兼容性

**任务清单**:
- [ ] 文件锁定支持
  - [ ] `LOCK` 方法实现
  - [ ] `UNLOCK` 方法实现
  - [ ] 锁定超时管理
  - [ ] 锁定冲突处理
- [ ] 属性扩展
  - [ ] 自定义属性支持
  - [ ] `PROPPATCH` 完善
- [ ] 范围请求优化
  - [ ] 支持 `Range` 头部（断点续传）
  - [ ] 多范围请求支持
- [ ] 大文件优化
  - [ ] 分块上传改进
  - [ ] 上传进度跟踪

**预计工期**: 1周
**依赖**: webdav.rs
**验证方式**: Cyberduck, rclone 完整功能测试

---

#### 6. 元数据索引与搜索
**目标**: 实现文件元数据全文搜索，提升用户体验

**任务清单**:
- [ ] 选择搜索引擎
  - [ ] 评估 Tantivy (Rust 原生)
  - [ ] 或集成 MeiliSearch
- [ ] 索引系统实现
  - [ ] 文件名索引
  - [ ] 文件内容索引（文本文件）
  - [ ] 元数据索引（标签、作者、日期）
  - [ ] 增量索引更新
- [ ] 搜索 API
  - [ ] `GET /api/search?q=keyword` - 全文搜索
  - [ ] `GET /api/search/files?name=xxx` - 文件名搜索
  - [ ] `GET /api/search/content?q=xxx` - 内容搜索
  - [ ] 高级过滤（文件类型、大小、日期范围）
- [ ] WebDAV 搜索支持
  - [ ] `SEARCH` 方法实现
- [ ] S3 对象搜索
  - [ ] 基于标签搜索
  - [ ] 元数据查询

**预计工期**: 2周
**依赖**: 搜索引擎选型
**验证方式**: 大量文件搜索性能测试

---

### 低优先级 (P2) - 优化与增强

#### 7. 性能优化与监控
**任务清单**:
- [ ] 性能基准测试
  - [ ] 上传/下载吞吐量测试
  - [ ] 并发连接压力测试
  - [ ] QUIC vs HTTP 性能对比
- [ ] 缓存优化
  - [ ] 文件内容缓存（LRU）
  - [ ] 元数据缓存
  - [ ] ETag 生成优化
- [ ] 监控与指标
  - [ ] Prometheus metrics 导出
  - [ ] 文件操作统计
  - [ ] 性能指标收集
  - [ ] 健康检查增强
- [ ] 日志优化
  - [ ] 结构化日志
  - [ ] 日志级别动态调整
  - [ ] 审计日志

**预计工期**: 1周
**验证方式**: Grafana 可视化监控

---

#### 8. 认证与授权增强
**任务清单**:
- [ ] 多用户支持
  - [ ] 用户注册/登录
  - [ ] JWT Token 认证
  - [ ] 用户配额管理
- [ ] 权限细粒度控制
  - [ ] 基于路径的 ACL
  - [ ] 用户组管理
  - [ ] 共享链接（只读/读写）
- [ ] S3 认证完善
  - [ ] AWS Signature V4 验证
  - [ ] 多租户支持
- [ ] WebDAV 认证
  - [ ] Basic Auth
  - [ ] Digest Auth

**预计工期**: 2周

---

### 未来规划 (Phase 4-5) - 分布式功能

#### 9. 跨节点文件同步 ✅ **基础框架完成 (2025-10-16)**
**目标**: 实现多节点之间的文件自动同步

**任务清单**:
- [x] 节点发现机制
  - [x] 服务注册与发现
  - [x] 节点健康检查
  - [x] 心跳检测
- [x] 文件同步协议设计
  - [x] gRPC 协议定义
  - [x] 同步状态数据结构
  - [ ] 增量同步算法实现
  - [ ] 同步队列管理
- [x] 一致性保证
  - [x] 最终一致性模型
  - [x] 向量时钟追踪
  - [x] CRDT 冲突解决
- [x] 同步配置
  - [x] 自动同步调度
  - [x] 同步统计
  - [ ] 选择性同步（白名单/黑名单）

**已完成**: 基础框架、节点管理、协议定义
**待完成**: gRPC 服务实现、文件内容传输
**实际工期**: 4小时（基础框架）
**依赖**: CRDT 同步模块 ✅

---

#### 10. 分布式存储与副本
**目标**: 实现数据分片和多副本容错

**任务清单**:
- [ ] 数据分片策略
  - [ ] 一致性哈希
  - [ ] 分片元数据管理
- [ ] 副本管理
  - [ ] 多副本存储
- [ ] 副本同步（分布式分散存储，后续）
  - [ ] 副本恢复
- [ ] 容错机制
  - [ ] 节点故障检测
  - [ ] 自动故障转移
  - [ ] 数据恢复

**预计工期**: 4-6周
**依赖**: 跨节点同步

---

#### 11. NFS/SMB 协议支持
**目标**: 支持传统网络文件系统协议

**任务清单**:
- [ ] NFS 服务端实现
  - [ ] NFSv3 协议支持
  - [ ] Mount 服务
- [ ] SMB 服务端实现
  - [ ] SMB 2/3 协议支持
  - [ ] CIFS 兼容
- [ ] 协议转换层
  - [ ] 统一文件系统接口
  - [ ] 权限映射

**预计工期**: 4-6周
**复杂度**: 高

---

## 📅 开发路线图

### Q1 2025 (当前)
- [x] S3 核心功能完善（✅ 已完成）
- [x] S3 高级特性（Multipart, Range, 条件请求）（✅ 已完成）
- [x] 文件版本管理系统 (P0)（✅ 已完成 2025-10-15）
- [x] CRDT 文件同步 (P0)（✅ 已完成 2025-10-15）
- [x] 增量同步 (P0)（✅ 已完成 2025-10-17）

### Q2 2025
- [ ] S3 高级功能扩展 (P1)
- [ ] WebDAV 高级功能 (P1)
- [ ] 元数据索引与搜索 (P1)
- [ ] 性能优化与监控 (P2)

### Q3 2025
- [ ] 认证与授权增强 (P2)
- [ ] 跨节点文件同步 (Phase 4)
- [ ] 分布式存储准备

### Q4 2025
- [ ] 分布式存储与副本 (Phase 4)
- [ ] NFS/SMB 协议探索 (Phase 5)

---

## 🔧 技术债务

### 需要重构的模块
- [ ] `storage.rs` - 增加接口抽象，支持多种后端
- [ ] `auth.rs` - 从简单的 Role-based 升级到完整的 RBAC
- [ ] 配置管理 - 支持热加载和动态配置

### 需要添加的测试
- [ ] S3 集成测试自动化
- [ ] WebDAV 协议兼容性测试套件
- [ ] 性能回归测试
- [ ] 并发安全测试

### 文档完善
- [ ] API 文档（OpenAPI/Swagger）
- [ ] 部署文档
- [ ] 性能调优指南
- [ ] 故障排查手册

---

## 📝 开发建议

### 当前阶段重点
根据 README 分析，当前项目处于 **Phase 2-3 过渡阶段**，建议优先完成：

1. **文件版本管理** - 这是用户最关心的功能，也是多客户端协作的基础
2. **CRDT 文件同步** - 核心技术验证目标，Silent Odyssey 项目的关键部分
3. **S3/WebDAV 功能完善** - 提升生态兼容性，吸引更多用户测试

### 技术选型建议
- **搜索引擎**: 推荐 Tantivy（纯 Rust，性能好，易集成）
- **CRDT 库**: 使用 silent-crdt 项目（项目内部）
- **缓存**: 使用 moka（Rust 高性能缓存库）
- **监控**: Prometheus + Grafana

### 开发顺序建议
```
版本管理 (2周)
    ↓
CRDT同步 (3周)
    ↓
S3高级功能 (2周)
    ↓
元数据搜索 (2周)
    ↓
性能优化 (1周)
    ↓
跨节点同步 (4周)
```

---

## 🎯 里程碑

### Milestone 1: 单节点功能完善 (✅ 已完成)
- 所有核心协议实现
- 基础文件操作
- 事件推送

### Milestone 2: 版本控制与同步 (当前目标)
- 文件版本管理
- CRDT 冲突合并
- 多客户端协作

### Milestone 3: 生态完善 (Q2 2025)
- S3/WebDAV 高级功能
- 元数据搜索
- 性能监控

### Milestone 4: 分布式部署 (Q3-Q4 2025)
- 跨节点同步
- 分布式存储
- 高可用

---

**更新记录**:
- 2025-10-15: 基于 README.md 分析创建初始版本
- 根据已完成的 S3 功能更新状态
