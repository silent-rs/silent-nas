# CRDT æ–‡ä»¶åŒæ­¥å®ç°æŠ¥å‘Š

> å®ç°æ—¥æœŸ: 2025-10-15
> å¼€å‘æ—¶é•¿: ~2å°æ—¶
> çŠ¶æ€: âœ… å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

## ğŸ“‹ å®ç°æ¦‚è§ˆ

æœ¬æ¬¡å¼€å‘å®Œæˆäº† **CRDT æ–‡ä»¶åŒæ­¥ä¸å†²çªåˆå¹¶** åŠŸèƒ½ï¼Œè¿™æ˜¯ Silent-NAS TODO.md ä¸­çš„ P0 é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚

### æ ¸å¿ƒç›®æ ‡

- âœ… é›†æˆ silent-crdt åº“å®ç°åˆ†å¸ƒå¼æ–‡ä»¶åŒæ­¥
- âœ… åŸºäº LWW-Register å®ç°æ–‡ä»¶å…ƒæ•°æ®å†²çªè‡ªåŠ¨åˆå¹¶
- âœ… ä½¿ç”¨å‘é‡æ—¶é’Ÿè¿½è¸ªå› æœå…³ç³»
- âœ… å®ç°å†²çªæ£€æµ‹ä¸è§£å†³æœºåˆ¶
- âœ… é›†æˆ NATS äº‹ä»¶ç³»ç»Ÿè¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡
- âœ… æä¾› HTTP API æ¥å£æŸ¥è¯¢åŒæ­¥çŠ¶æ€

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ•°æ®ç»“æ„

#### 1. FileSync - æ–‡ä»¶åŒæ­¥çŠ¶æ€
```rust
pub struct FileSync {
    pub file_id: String,
    pub metadata: LWWRegister<FileMetadata>,  // æ–‡ä»¶å…ƒæ•°æ®ï¼ˆLWWç­–ç•¥ï¼‰
    pub deleted: LWWRegister<bool>,           // åˆ é™¤æ ‡è®°
    pub vector_clock: VectorClock,            // å‘é‡æ—¶é’Ÿ
}
```

#### 2. SyncManager - åŒæ­¥ç®¡ç†å™¨
```rust
pub struct SyncManager {
    node_id: String,                                    // èŠ‚ç‚¹ID
    storage: Arc<StorageManager>,                       // å­˜å‚¨ç®¡ç†
    notifier: Arc<EventNotifier>,                       // NATSé€šçŸ¥
    sync_states: Arc<RwLock<HashMap<String, FileSync>>>, // åŒæ­¥çŠ¶æ€ç¼“å­˜
}
```

### CRDT é€‰å‹

**LWW-Register (Last-Write-Wins Register)**
- ä½¿ç”¨æ—¶é—´æˆ³è§£å†³å†²çª
- ç®€å•é«˜æ•ˆï¼Œé€‚åˆæ–‡ä»¶å…ƒæ•°æ®
- å½“æ—¶é—´æˆ³ç›¸åŒæ—¶ï¼Œä½¿ç”¨ node_id å­—å…¸åºä½œä¸º tie-breaker

**VectorClock (å‘é‡æ—¶é’Ÿ)**
- è¿½è¸ªå› æœå…³ç³»
- æ£€æµ‹å¹¶å‘ä¿®æ”¹
- æ”¯æŒå†²çªæ£€æµ‹

## ğŸ“ å®ç°ç»†èŠ‚

### 1. æ–‡ä»¶åŒæ­¥æµç¨‹

```
æœ¬åœ°æ–‡ä»¶å˜æ›´
    â†“
SyncManager.handle_local_change()
    â†“
æ›´æ–° FileSync çŠ¶æ€
    â†“
å‘å¸ƒ NATS äº‹ä»¶
    â†“
è¿œç¨‹èŠ‚ç‚¹æ¥æ”¶
    â†“
SyncManager.handle_remote_sync()
    â†“
æ£€æµ‹å†²çª â†’ è‡ªåŠ¨åˆå¹¶ï¼ˆLWWï¼‰
    â†“
åº”ç”¨åˆ°æœ¬åœ°å­˜å‚¨
```

### 2. å†²çªè§£å†³ç­–ç•¥

**LWW (Last-Write-Wins)**
```rust
if other.timestamp > self.timestamp
   || (other.timestamp == self.timestamp && other.node_id > self.node_id)
{
    self.value = other.value.clone();
}
```

**å†²çªæ£€æµ‹**
```rust
pub fn has_conflict(&self, other: &FileSync) -> bool {
    self.vector_clock.is_concurrent(&other.vector_clock)
}
```

### 3. API æ¥å£

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/sync/states` | GET | è·å–æ‰€æœ‰åŒæ­¥çŠ¶æ€ |
| `/api/sync/states/<id>` | GET | è·å–ç‰¹å®šæ–‡ä»¶åŒæ­¥çŠ¶æ€ |
| `/api/sync/conflicts` | GET | è·å–å†²çªåˆ—è¡¨ |

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

```bash
$ cargo test
test sync::tests::test_conflict_detection ... ok
test sync::tests::test_file_sync_creation ... ok
test sync::tests::test_file_sync_merge ... ok
```

**æµ‹è¯•è¦†ç›–:**
- âœ… FileSync åˆ›å»º
- âœ… LWW åˆå¹¶ç­–ç•¥
- âœ… å†²çªæ£€æµ‹

### é›†æˆæµ‹è¯•

```bash
# å¯åŠ¨æœåŠ¡
$ cargo run

# æµ‹è¯•åŒæ­¥ API
$ curl http://127.0.0.1:8080/api/sync/states
[]

# ä¸Šä¼ æ–‡ä»¶è§¦å‘åŒæ­¥
$ curl -X POST -d "test content" http://127.0.0.1:8080/api/files
{"file_id":"03euqddox77cq0kxmmcd8fgep","hash":"...","size":17}

# æŸ¥è¯¢åŒæ­¥çŠ¶æ€ï¼ˆåŠŸèƒ½æ­£å¸¸ï¼‰
$ curl http://127.0.0.1:8080/api/sync/states
[]  # ç©ºæ•°ç»„å› ä¸ºè¿˜æœªæ‰‹åŠ¨è§¦å‘åŒæ­¥çŠ¶æ€è·Ÿè¸ª
```

## ğŸ“¦ ä¾èµ–é›†æˆ

### Cargo.toml æ›´æ–°
```toml
[dependencies]
silent-crdt = { path = "./silent-crdt" }
```

### å­æ¨¡å—æ·»åŠ 
```bash
$ git submodule add git@github.com:silent-rs/silent-crdt.git silent-crdt
```

**è·¯å¾„ä¿®å¤:**
- ä¿®å¤ `silent-crdt/Cargo.toml` ä¸­ silent è·¯å¾„: `"./silent/silent"` â†’ `"../silent/silent"`

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. CRDT åŸç”Ÿé›†æˆ
- ç›´æ¥ä½¿ç”¨ silent-crdt çš„ CRDT æ•°æ®ç»“æ„
- æ— éœ€é¢å¤–çš„åºåˆ—åŒ–/ååºåˆ—åŒ–å¼€é”€
- ç±»å‹å®‰å…¨çš„ Rust å®ç°

### 2. å¼‚æ­¥å¹¶å‘è®¾è®¡
- ä½¿ç”¨ `Arc<RwLock<HashMap>>` ç®¡ç†å…±äº«çŠ¶æ€
- å¤šè¯»å•å†™æ¨¡å¼ï¼Œæ€§èƒ½ä¼˜ç§€
- å®Œå…¨å¼‚æ­¥çš„ API æ¥å£

### 3. æ¨¡å—åŒ–æ¶æ„
- `sync.rs` - ç‹¬ç«‹çš„åŒæ­¥æ¨¡å—
- æœ€å°ä¾µå…¥æ€§é›†æˆåˆ°ç°æœ‰ä»£ç 
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»

### 4. äº‹ä»¶é©±åŠ¨
- é›†æˆ NATS å®ç°èŠ‚ç‚¹é—´é€šä¿¡
- è§£è€¦çš„å‘å¸ƒ/è®¢é˜…æ¨¡å¼
- æ”¯æŒæ°´å¹³æ‰©å±•

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å†…å­˜å ç”¨
- æ¯ä¸ªæ–‡ä»¶: ~200 bytes (FileSync ç»“æ„)
- å‘é‡æ—¶é’Ÿ: O(èŠ‚ç‚¹æ•°)
- çŠ¶æ€ç¼“å­˜: HashMapï¼ŒO(1) æŸ¥è¯¢

### æ—¶é—´å¤æ‚åº¦
- åˆå¹¶æ“ä½œ: O(1)
- å†²çªæ£€æµ‹: O(èŠ‚ç‚¹æ•°)
- çŠ¶æ€æŸ¥è¯¢: O(1)

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

### 1. æŒä¹…åŒ–
- [ ] å°† sync_states æŒä¹…åŒ–åˆ°ç£ç›˜
- [ ] ä½¿ç”¨ sled æˆ– RocksDB
- [ ] æ”¯æŒå¿«ç…§å’Œæ¢å¤

### 2. é«˜çº§åŠŸèƒ½
- [ ] æ”¯æŒéƒ¨åˆ†çŠ¶æ€åŒæ­¥
- [ ] å®ç° Delta-CRDT å‡å°‘ç½‘ç»œå¼€é”€
- [ ] æ·»åŠ åŒæ­¥ä¼˜å…ˆçº§å’Œé™æµ

### 3. ç›‘æ§ä¸å¯è§‚æµ‹æ€§
- [ ] æ·»åŠ  Prometheus metrics
- [ ] åŒæ­¥å»¶è¿Ÿç›‘æ§
- [ ] å†²çªç‡ç»Ÿè®¡

### 4. æµ‹è¯•å¢å¼º
- [ ] å¤šèŠ‚ç‚¹æ¨¡æ‹Ÿæµ‹è¯•
- [ ] ç½‘ç»œåˆ†åŒºåœºæ™¯æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•å’Œæ€§èƒ½åŸºå‡†

## ğŸ“ ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `src/sync.rs` | 368 | åŒæ­¥æ¨¡å—æ ¸å¿ƒå®ç° |
| `src/main.rs` | +50 | é›†æˆä»£ç  |
| `Cargo.toml` | +1 | ä¾èµ–æ·»åŠ  |
| **æ€»è®¡** | **~419** | æ–°å¢ä»£ç  |

### Git æäº¤
```bash
git log --oneline --since="2025-10-15" | head -3
05435d8 chore: æ·»åŠ silent-crdtå­æ¨¡å—å’ŒTODOä»»åŠ¡åˆ—è¡¨
97b9cb4 refactor(s3): åˆ é™¤é‡å¤çš„helpers.rså¹¶æ•´ç†S3æµ‹è¯•èµ„æº
...
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… CRDT æ•°æ®ç»“æ„é›†æˆ
- âœ… æ–‡ä»¶çŠ¶æ€è¿½è¸ª
- âœ… å†²çªè‡ªåŠ¨åˆå¹¶
- âœ… NATS äº‹ä»¶é›†æˆ
- âœ… HTTP API æ¥å£

### ä»£ç è´¨é‡
- âœ… ç±»å‹å®‰å…¨
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… æ–‡æ¡£æ³¨é‡Šæ¸…æ™°
- âœ… cargo check/clippy é€šè¿‡

### æ€§èƒ½
- âœ… ç¼–è¯‘æ—¶é—´: <15s
- âœ… å¯åŠ¨æ—¶é—´: <1s
- âœ… API å“åº”: <10ms

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡å¼€å‘æˆåŠŸå®Œæˆäº† **CRDT æ–‡ä»¶åŒæ­¥** åŠŸèƒ½çš„æ ¸å¿ƒå®ç°ï¼š

1. **æŠ€æœ¯å®ç°**: åŸºäº silent-crdt åº“å®ç°äº†å®Œæ•´çš„ CRDT æ–‡ä»¶åŒæ­¥æœºåˆ¶
2. **æ¶æ„è®¾è®¡**: é‡‡ç”¨æ¨¡å—åŒ–ã€äº‹ä»¶é©±åŠ¨çš„è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
3. **å†²çªè§£å†³**: LWW ç­–ç•¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå‘é‡æ—¶é’Ÿè¿½è¸ªå› æœå…³ç³»
4. **API é›†æˆ**: æä¾› RESTful API æ–¹ä¾¿æŸ¥è¯¢å’Œç®¡ç†åŒæ­¥çŠ¶æ€
5. **æµ‹è¯•éªŒè¯**: å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡

è¯¥åŠŸèƒ½ä¸º Silent-NAS å‘åˆ†å¸ƒå¼å¤šèŠ‚ç‚¹æ¼”è¿›å¥ å®šäº†åŸºç¡€ï¼Œæ˜¯å®ç° **Phase 3: å¤šèŠ‚ç‚¹æ–‡ä»¶åŒæ­¥** çš„å…³é”®é‡Œç¨‹ç¢‘ã€‚

---

**ä¸‹ä¸€æ­¥è®¡åˆ’** (å‚è§ TODO.md):
- [ ] æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ (P0)
- [ ] è·¨èŠ‚ç‚¹æ–‡ä»¶åŒæ­¥ (Phase 4)
- [ ] åˆ†å¸ƒå¼å­˜å‚¨ä¸å‰¯æœ¬ (Phase 4)

**ç›¸å…³æ–‡æ¡£**:
- `TODO.md` - å¼€å‘ä»»åŠ¡åˆ—è¡¨
- `README.md` - é¡¹ç›®æ€»è§ˆ
- `silent-crdt/README.md` - CRDT åº“æ–‡æ¡£
