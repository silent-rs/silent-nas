# 分布式同步需求整理（可靠性与一致性校验）

目标：提升跨节点同步的端到端一致性与稳定性，确保文件传输后目标节点数据正确落盘并可验证；出现失败时具备可观测与可恢复能力。

## 范围（P0）
- 端到端校验：使用 SHA-256 对完整文件进行校验；与分块 MD5 互补。
- 失败补偿：当端到端校验失败或请求错误时，进行重试与回退；支持指数退避与抖动。
- 观测指标：记录同步成功率、重试次数、阶段时延、吞吐量；用于达成延迟与成功率目标。
- 参数化：并发、批量、间隔、最大重试、超时等可配置。

## 非目标（本阶段不做）
- 差异/增量传输与去重
- 多副本一致性协议（v0.8+）

## 约束
- ID 一律使用 `scru128`
- 时间统一使用 `chrono::Local::now().naive_local()`
- 接口与对外行为保持兼容；在不修改 proto 的前提下优先实现

## 实现要点
- 发送端完成流式传输后，通过 FileService 获取目标端元数据并比对 `hash`（SHA-256）
- 失败则按指数退避重试，超过上限则计入失败并进入补偿（后续可持久化队列）
- 指标埋点：成功/失败数、bytes、重试次数、阶段时延

## 错误分级
- 可重试：`Unavailable`、`DeadlineExceeded`、`ResourceExhausted`、`Aborted`、`Unknown`、`Internal`
- 不可重试：参数错误、鉴权失败、数据不可恢复错误

## 验收标准（调整）
- 三节点拓扑，N=200 个文件更新（推荐 5 分钟窗口），收敛延迟 P95 < 5s
- 端到端校验成功率 >= 99.9%
- 指标可在监控中观察到并用于排障
