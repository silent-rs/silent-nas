# Silent-NAS 需求整理文档

关联文档：ROADMAP.md | TODO.md | README.md

—

## 范围与目标

- 版本范围：v0.6.0-dev（当前迭代）
- 核心目标：
  - 分布式文件同步（跨节点 gRPC + CRDT 合并）
  - WebDAV 协议完善（锁、版本、属性）
- 非目标（后续拓展）：企业级权限、S3 企业增强、多租户、RBAC、审计与合规、加密等

—

## 术语与约束

- ID 规范：使用 `scru128` 生成全局唯一 ID
- 时间规范：如需时间字段，统一使用 `chrono::Local::now().naive_local()`
- 框架：Rust，Web 框架采用 Silent
- 兼容性目标：WebDAV 95%+ 客户端兼容

—

## 功能需求（v0.6.0 核心）

1) 分布式文件同步
- 跨节点 gRPC 传输：实现 `send_file()`、`request_file()`，支持断点续传、重试与超时
- 冲突处理：采用 CRDT 合并策略，保证最终一致性；记录冲突事件与合并结果
- 同步拓扑：至少支持 3 节点多向同步；节点加入/离线时的队列与补偿机制
- 一致性校验：哈希校验、版本校验；失败自动重试与告警
- 可观测性：指标（传输速率、队列长度、冲突次数、重试次数、最终延迟）与日志

2) WebDAV 协议完善
- 锁管理：实现 `LOCK/UNLOCK`，支持独占/共享策略，锁超时与续约
- 版本控制：DeltaV 基础能力（版本创建/查询/回滚的最小闭环）
- 属性扩展：`PROPFIND/PROPPATCH` 支持扩展属性读写
- 兼容性：对 Cyberduck、Nextcloud 等主流客户端进行互通验证

—

## 候选需求（v0.7.0）

- 版本存储优化：增量存储、差异算法、冷热分离、块级去重
- 搜索增强：全文搜索、过滤与建议、协议层搜索集成
- 性能监控完善：Prometheus 指标补充、基准测试、缓存策略优化

—

## 后续拓展（Enterprise，非本迭代）

- 权限与安全：路径级 ACL、用户组与组权限、配额、完整 RBAC、审计与合规、数据加密
- 多租户：租户隔离、共享链接/外部协作
- S3 企业增强：对象标签、对象 ACL、生命周期、预签名 URL、CORS 配置

—

## 非功能需求

- 性能：多节点同步端到端延迟 < 5 秒；并发连接 1000+
- 可观测性：完善的指标、结构化日志、关键路径追踪
- 兼容性：WebDAV 客户端 95%+ 互通；S3 保持核心能力稳定
- 可维护性：错误码与日志规范统一；模块边界清晰（sync/webdav）

—

## 验收标准（DoD）

- 同步：三节点端到端同步稳定，冲突合并正确，失败可恢复
- WebDAV：锁/版本/属性在主流客户端可用并通过互通用例
- 指标：同步与 WebDAV 关键指标完整暴露，日志可追踪
- 文档：README/RUNNING 更新必要用法；TODO 与 ROADMAP 一致

—

## 影响面与接口变更

- sync 子系统：新增/完善 gRPC 接口；状态机与重试策略
- webdav 子系统：新增 LOCK/UNLOCK、DeltaV、属性扩展处理流程
- 元数据：必要时增加版本/锁定元信息（以 scru128 作为主键）

—

## 开放问题

- DeltaV 最小闭环的版本粒度与元数据设计细节
- 冲突合并策略在二进制大文件的适配策略
- 断点续传在非对称网络下的窗口与超时参数

—

## 参考

- ROADMAP.md：版本规划与拓展方向
- TODO.md：当前迭代的任务拆分与优先级
