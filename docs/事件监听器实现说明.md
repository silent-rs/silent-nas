# 事件监听器实现说明

> 日期: 2025-10-16
> 版本: v0.3.1
> 问题: WebDAV 上传文件后没有触发跨节点同步

---

## 🎯 问题描述

虽然在 WebDAV PUT 处理中调用了 `SyncManager.handle_local_change()` 和 `broadcast_change()`，但其他节点**没有监听器接收 NATS 事件**，导致同步失败。

### 问题日志

```
silent-nas-node1  | 2025-10-16T07:43:08.604179Z  INFO silent_nas::sync: 创建文件同步状态: 03euwpqruwehf8uyck283m99i
```

✅ 节点1创建了同步状态
❌ 节点2、节点3没有任何反应

---

## 🔧 解决方案

### 1. 新增事件监听器模块

**文件**: `src/event_listener.rs`

```rust
use crate::error::Result;
use crate::models::FileEvent;
use crate::sync::{FileSync, SyncManager};
use futures_util::StreamExt;
use std::sync::Arc;
use tracing::{debug, error, info, warn};

pub struct EventListener {
    sync_manager: Arc<SyncManager>,
    nats_client: async_nats::Client,
    topic_prefix: String,
}

impl EventListener {
    pub fn new(
        sync_manager: Arc<SyncManager>,
        nats_client: async_nats::Client,
        topic_prefix: String,
    ) -> Self {
        Self {
            sync_manager,
            nats_client,
            topic_prefix,
        }
    }

    /// 启动事件监听（订阅 NATS 主题）
    pub async fn start(self) -> Result<()> {
        let topic_pattern = format!("{}.*", self.topic_prefix);
        let mut subscriber = self.nats_client
            .subscribe(topic_pattern.clone())
            .await?;

        info!("开始监听主题: {}", topic_pattern);

        while let Some(message) = subscriber.next().await {
            if let Err(e) = self.handle_event(&message.payload).await {
                error!("处理事件失败: {}", e);
            }
        }

        Ok(())
    }

    /// 处理接收到的事件
    async fn handle_event(&self, payload: &[u8]) -> Result<()> {
        let event: FileEvent = serde_json::from_slice(payload)?;

        if let Some(metadata) = event.metadata {
            let file_sync = FileSync::new(
                event.file_id.clone(),
                metadata,
                self.sync_manager.node_id(),
            );

            self.sync_manager.handle_remote_sync(file_sync).await?;
            info!("✅ 成功处理远程文件同步: {}", event.file_id);
        }

        Ok(())
    }
}
```

### 2. 在 main.rs 中启动监听器

**文件**: `src/main.rs`

```rust
// 启动事件监听器（监听其他节点的文件变更）
let event_listener = EventListener::new(
    sync_manager.clone(),
    notifier.get_client(),
    config.nats.topic_prefix.clone(),
);
tokio::spawn(async move {
    if let Err(e) = event_listener.start().await {
        error!("事件监听器错误: {}", e);
    }
});
```

### 3. 暴露 EventNotifier 的 NATS 客户端

**文件**: `src/notify.rs`

```rust
impl EventNotifier {
    /// 获取 NATS 客户端（用于事件监听器）
    pub fn get_client(&self) -> Client {
        self.client.clone()
    }

    /// 获取主题前缀
    pub fn get_topic_prefix(&self) -> &str {
        &self.topic_prefix
    }
}
```

### 4. 添加依赖

**文件**: `Cargo.toml`

```toml
futures-util = "0.3"  # 用于 StreamExt trait
```

---

## 🔄 完整的同步流程

### 节点1 上传文件

```
WebDAV PUT
  ↓
1. fs::write() 保存文件
  ↓
2. SyncManager.handle_local_change()
   └─> 创建 FileSync (CRDT 状态)
  ↓
3. SyncManager.broadcast_change()
   └─> 发布 NATS 事件: nas.files.created
```

### 节点2、节点3 接收事件

```
NATS 订阅: nas.files.*
  ↓
EventListener.handle_event()
  ↓
1. 解析 FileEvent
  ↓
2. 创建 FileSync 状态
  ↓
3. SyncManager.handle_remote_sync()
   └─> 合并 CRDT 状态
   └─> 应用到本地存储
  ↓
✅ 文件元数据已同步
```

---

## 📝 修改的文件

1. ✅ **新增**: `src/event_listener.rs` - NATS 事件监听器
2. ✅ **修改**: `src/main.rs` - 启动监听器、添加导入
3. ✅ **修改**: `src/notify.rs` - 暴露 NATS 客户端
4. ✅ **修改**: `Cargo.toml` - 添加 futures-util 依赖
5. ✅ **修改**: `src/webdav.rs` - 修复导入问题

---

## 🚀 启动日志（预期）

```
节点1:
INFO silent_nas: 同步管理器已初始化: node_id=03euwpqruwehf8uyck283m99i
INFO silent_nas::event_listener: 启动事件监听器: node_id=03euwpqruwehf8uyck283m99i
INFO silent_nas::event_listener: 开始监听主题: nas.files.*

节点2:
INFO silent_nas: 同步管理器已初始化: node_id=03euwpqruwehf8uyck283m99j
INFO silent_nas::event_listener: 启动事件监听器: node_id=03euwpqruwehf8uyck283m99j
INFO silent_nas::event_listener: 开始监听主题: nas.files.*

[用户上传文件到节点1]

节点1:
INFO silent_nas::sync: 创建文件同步状态: 03euxxx
INFO silent_nas::sync: 广播文件变更: 03euxxx

节点2:
INFO silent_nas::event_listener: ✅ 成功处理远程文件同步: 03euxxx

节点3:
INFO silent_nas::event_listener: ✅ 成功处理远程文件同步: 03euxxx
```

---

## ⚠️ 当前限制

### 已实现
- ✅ NATS 事件监听
- ✅ 元数据同步
- ✅ CRDT 状态合并

### 待实现
- ⏳ 文件内容传输（通过 QUIC）
- ⏳ 自动下载缺失的文件
- ⏳ 增量同步优化

---

## 🧪 测试步骤

```bash
# 1. 启动集群
cd docker && docker-compose up

# 2. 上传文件到节点1
curl -T test.txt http://localhost:8081/webdav/test.txt

# 3. 检查节点2日志
docker logs silent-nas-node2 2>&1 | grep "成功处理远程文件同步"

# 4. 检查节点3日志
docker logs silent-nas-node3 2>&1 | grep "成功处理远程文件同步"
```

---

## 📊 代码统计

- **新增代码**: ~100 行
- **修改代码**: ~30 行
- **影响文件**: 5 个
- **编译状态**: ✅ 通过

---

**完成时间**: 2025-10-16
**版本**: v0.3.1
**状态**: ✅ 已实现并编译通过
