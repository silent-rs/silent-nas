# äº‹ä»¶ç›‘å¬å™¨å®ç°è¯´æ˜

> æ—¥æœŸ: 2025-10-16
> ç‰ˆæœ¬: v0.3.1
> é—®é¢˜: WebDAV ä¸Šä¼ æ–‡ä»¶åæ²¡æœ‰è§¦å‘è·¨èŠ‚ç‚¹åŒæ­¥

---

## ğŸ¯ é—®é¢˜æè¿°

è™½ç„¶åœ¨ WebDAV PUT å¤„ç†ä¸­è°ƒç”¨äº† `SyncManager.handle_local_change()` å’Œ `broadcast_change()`ï¼Œä½†å…¶ä»–èŠ‚ç‚¹**æ²¡æœ‰ç›‘å¬å™¨æ¥æ”¶ NATS äº‹ä»¶**ï¼Œå¯¼è‡´åŒæ­¥å¤±è´¥ã€‚

### é—®é¢˜æ—¥å¿—

```
silent-nas-node1  | 2025-10-16T07:43:08.604179Z  INFO silent_nas::sync: åˆ›å»ºæ–‡ä»¶åŒæ­¥çŠ¶æ€: 03euwpqruwehf8uyck283m99i
```

âœ… èŠ‚ç‚¹1åˆ›å»ºäº†åŒæ­¥çŠ¶æ€
âŒ èŠ‚ç‚¹2ã€èŠ‚ç‚¹3æ²¡æœ‰ä»»ä½•ååº”

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. æ–°å¢äº‹ä»¶ç›‘å¬å™¨æ¨¡å—

**æ–‡ä»¶**: `src/event_listener.rs`

```rust
use crate::error::Result;
use crate::models::FileEvent;
use crate::sync::{FileSync, SyncManager};
use futures_util::StreamExt;
use std::sync::Arc;
use tracing::{debug, error, info, warn};

pub struct EventListener {
    sync_manager: Arc<SyncManager>,
    nats_client: async_nats::Client,
    topic_prefix: String,
}

impl EventListener {
    pub fn new(
        sync_manager: Arc<SyncManager>,
        nats_client: async_nats::Client,
        topic_prefix: String,
    ) -> Self {
        Self {
            sync_manager,
            nats_client,
            topic_prefix,
        }
    }

    /// å¯åŠ¨äº‹ä»¶ç›‘å¬ï¼ˆè®¢é˜… NATS ä¸»é¢˜ï¼‰
    pub async fn start(self) -> Result<()> {
        let topic_pattern = format!("{}.*", self.topic_prefix);
        let mut subscriber = self.nats_client
            .subscribe(topic_pattern.clone())
            .await?;

        info!("å¼€å§‹ç›‘å¬ä¸»é¢˜: {}", topic_pattern);

        while let Some(message) = subscriber.next().await {
            if let Err(e) = self.handle_event(&message.payload).await {
                error!("å¤„ç†äº‹ä»¶å¤±è´¥: {}", e);
            }
        }

        Ok(())
    }

    /// å¤„ç†æ¥æ”¶åˆ°çš„äº‹ä»¶
    async fn handle_event(&self, payload: &[u8]) -> Result<()> {
        let event: FileEvent = serde_json::from_slice(payload)?;

        if let Some(metadata) = event.metadata {
            let file_sync = FileSync::new(
                event.file_id.clone(),
                metadata,
                self.sync_manager.node_id(),
            );

            self.sync_manager.handle_remote_sync(file_sync).await?;
            info!("âœ… æˆåŠŸå¤„ç†è¿œç¨‹æ–‡ä»¶åŒæ­¥: {}", event.file_id);
        }

        Ok(())
    }
}
```

### 2. åœ¨ main.rs ä¸­å¯åŠ¨ç›‘å¬å™¨

**æ–‡ä»¶**: `src/main.rs`

```rust
// å¯åŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆç›‘å¬å…¶ä»–èŠ‚ç‚¹çš„æ–‡ä»¶å˜æ›´ï¼‰
let event_listener = EventListener::new(
    sync_manager.clone(),
    notifier.get_client(),
    config.nats.topic_prefix.clone(),
);
tokio::spawn(async move {
    if let Err(e) = event_listener.start().await {
        error!("äº‹ä»¶ç›‘å¬å™¨é”™è¯¯: {}", e);
    }
});
```

### 3. æš´éœ² EventNotifier çš„ NATS å®¢æˆ·ç«¯

**æ–‡ä»¶**: `src/notify.rs`

```rust
impl EventNotifier {
    /// è·å– NATS å®¢æˆ·ç«¯ï¼ˆç”¨äºäº‹ä»¶ç›‘å¬å™¨ï¼‰
    pub fn get_client(&self) -> Client {
        self.client.clone()
    }

    /// è·å–ä¸»é¢˜å‰ç¼€
    pub fn get_topic_prefix(&self) -> &str {
        &self.topic_prefix
    }
}
```

### 4. æ·»åŠ ä¾èµ–

**æ–‡ä»¶**: `Cargo.toml`

```toml
futures-util = "0.3"  # ç”¨äº StreamExt trait
```

---

## ğŸ”„ å®Œæ•´çš„åŒæ­¥æµç¨‹

### èŠ‚ç‚¹1 ä¸Šä¼ æ–‡ä»¶

```
WebDAV PUT
  â†“
1. fs::write() ä¿å­˜æ–‡ä»¶
  â†“
2. SyncManager.handle_local_change()
   â””â”€> åˆ›å»º FileSync (CRDT çŠ¶æ€)
  â†“
3. SyncManager.broadcast_change()
   â””â”€> å‘å¸ƒ NATS äº‹ä»¶: nas.files.created
```

### èŠ‚ç‚¹2ã€èŠ‚ç‚¹3 æ¥æ”¶äº‹ä»¶

```
NATS è®¢é˜…: nas.files.*
  â†“
EventListener.handle_event()
  â†“
1. è§£æ FileEvent
  â†“
2. åˆ›å»º FileSync çŠ¶æ€
  â†“
3. SyncManager.handle_remote_sync()
   â””â”€> åˆå¹¶ CRDT çŠ¶æ€
   â””â”€> åº”ç”¨åˆ°æœ¬åœ°å­˜å‚¨
  â†“
âœ… æ–‡ä»¶å…ƒæ•°æ®å·²åŒæ­¥
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… **æ–°å¢**: `src/event_listener.rs` - NATS äº‹ä»¶ç›‘å¬å™¨
2. âœ… **ä¿®æ”¹**: `src/main.rs` - å¯åŠ¨ç›‘å¬å™¨ã€æ·»åŠ å¯¼å…¥
3. âœ… **ä¿®æ”¹**: `src/notify.rs` - æš´éœ² NATS å®¢æˆ·ç«¯
4. âœ… **ä¿®æ”¹**: `Cargo.toml` - æ·»åŠ  futures-util ä¾èµ–
5. âœ… **ä¿®æ”¹**: `src/webdav.rs` - ä¿®å¤å¯¼å…¥é—®é¢˜

---

## ğŸš€ å¯åŠ¨æ—¥å¿—ï¼ˆé¢„æœŸï¼‰

```
èŠ‚ç‚¹1:
INFO silent_nas: åŒæ­¥ç®¡ç†å™¨å·²åˆå§‹åŒ–: node_id=03euwpqruwehf8uyck283m99i
INFO silent_nas::event_listener: å¯åŠ¨äº‹ä»¶ç›‘å¬å™¨: node_id=03euwpqruwehf8uyck283m99i
INFO silent_nas::event_listener: å¼€å§‹ç›‘å¬ä¸»é¢˜: nas.files.*

èŠ‚ç‚¹2:
INFO silent_nas: åŒæ­¥ç®¡ç†å™¨å·²åˆå§‹åŒ–: node_id=03euwpqruwehf8uyck283m99j
INFO silent_nas::event_listener: å¯åŠ¨äº‹ä»¶ç›‘å¬å™¨: node_id=03euwpqruwehf8uyck283m99j
INFO silent_nas::event_listener: å¼€å§‹ç›‘å¬ä¸»é¢˜: nas.files.*

[ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶åˆ°èŠ‚ç‚¹1]

èŠ‚ç‚¹1:
INFO silent_nas::sync: åˆ›å»ºæ–‡ä»¶åŒæ­¥çŠ¶æ€: 03euxxx
INFO silent_nas::sync: å¹¿æ’­æ–‡ä»¶å˜æ›´: 03euxxx

èŠ‚ç‚¹2:
INFO silent_nas::event_listener: âœ… æˆåŠŸå¤„ç†è¿œç¨‹æ–‡ä»¶åŒæ­¥: 03euxxx

èŠ‚ç‚¹3:
INFO silent_nas::event_listener: âœ… æˆåŠŸå¤„ç†è¿œç¨‹æ–‡ä»¶åŒæ­¥: 03euxxx
```

---

## âš ï¸ å½“å‰é™åˆ¶

### å·²å®ç°
- âœ… NATS äº‹ä»¶ç›‘å¬
- âœ… å…ƒæ•°æ®åŒæ­¥
- âœ… CRDT çŠ¶æ€åˆå¹¶

### å¾…å®ç°
- â³ æ–‡ä»¶å†…å®¹ä¼ è¾“ï¼ˆé€šè¿‡ QUICï¼‰
- â³ è‡ªåŠ¨ä¸‹è½½ç¼ºå¤±çš„æ–‡ä»¶
- â³ å¢é‡åŒæ­¥ä¼˜åŒ–

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

```bash
# 1. å¯åŠ¨é›†ç¾¤
cd docker && docker-compose up

# 2. ä¸Šä¼ æ–‡ä»¶åˆ°èŠ‚ç‚¹1
curl -T test.txt http://localhost:8081/webdav/test.txt

# 3. æ£€æŸ¥èŠ‚ç‚¹2æ—¥å¿—
docker logs silent-nas-node2 2>&1 | grep "æˆåŠŸå¤„ç†è¿œç¨‹æ–‡ä»¶åŒæ­¥"

# 4. æ£€æŸ¥èŠ‚ç‚¹3æ—¥å¿—
docker logs silent-nas-node3 2>&1 | grep "æˆåŠŸå¤„ç†è¿œç¨‹æ–‡ä»¶åŒæ­¥"
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

- **æ–°å¢ä»£ç **: ~100 è¡Œ
- **ä¿®æ”¹ä»£ç **: ~30 è¡Œ
- **å½±å“æ–‡ä»¶**: 5 ä¸ª
- **ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡

---

**å®Œæˆæ—¶é—´**: 2025-10-16
**ç‰ˆæœ¬**: v0.3.1
**çŠ¶æ€**: âœ… å·²å®ç°å¹¶ç¼–è¯‘é€šè¿‡
