# Silent-NAS 分布式部署指南

> 版本: v0.3.0
> 更新时间: 2025-10-16
> 适用场景: 多节点分布式 NAS 集群

## 📋 目录

1. [部署架构](#部署架构)
2. [前置要求](#前置要求)
3. [快速开始](#快速开始)
4. [详细部署步骤](#详细部署步骤)
5. [配置说明](#配置说明)
6. [监控和管理](#监控和管理)
7. [故障排查](#故障排查)
8. [最佳实践](#最佳实践)

---

## 🏗️ 部署架构

### 典型的 3 节点集群

```
                    ┌─────────────┐
                    │   Client    │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐      ┌────▼─────┐      ┌────▼─────┐
   │  Node 1  │◄────►│  Node 2  │◄────►│  Node 3  │
   │ (Master) │      │  (Peer)  │      │  (Peer)  │
   └──────────┘      └──────────┘      └──────────┘
        │                  │                  │
   [Storage 1]        [Storage 2]        [Storage 3]
```

### 节点角色说明

**种子节点 (Seed Node)**
- 作为集群的启动点
- 维护已知节点列表
- 可以有多个种子节点

**普通节点 (Peer Node)**
- 连接到种子节点加入集群
- 与其他节点保持心跳
- 自动同步文件状态

---

## 🔧 前置要求

### 硬件要求

**最低配置** (每节点)
- CPU: 2 核心
- 内存: 4GB RAM
- 存储: 100GB+ 可用空间
- 网络: 100Mbps+

**推荐配置** (每节点)
- CPU: 4+ 核心
- 内存: 8GB+ RAM
- 存储: 1TB+ SSD
- 网络: 1Gbps+

### 软件要求

- **操作系统**: Linux / macOS / Windows
- **Rust**: 1.70+
- **依赖服务**:
  - NATS Server 2.9+ (消息队列)
  - 可选: Docker (容器化部署)

### 网络要求

- 节点间需要能够互相访问
- 开放端口:
  - `9000`: gRPC 同步服务
  - `8080`: HTTP API
  - `8081`: WebDAV
  - `9001`: S3 API

---

## 🚀 快速开始

### 方式一: 本地测试集群 (3 节点)

```bash
# 1. 克隆项目
git clone https://github.com/silent-rs/silent-nas.git
cd silent-nas

# 2. 启动 NATS 服务器
docker run -d --name nats -p 4222:4222 nats:latest

# 3. 启动节点 1 (种子节点)
cargo run --release -- \
  --node-id node-1 \
  --listen 127.0.0.1:9000 \
  --http-port 8080 \
  --storage-path ./storage1

# 4. 启动节点 2 (新终端)
cargo run --release -- \
  --node-id node-2 \
  --listen 127.0.0.1:9001 \
  --http-port 8081 \
  --storage-path ./storage2 \
  --seed-nodes 127.0.0.1:9000

# 5. 启动节点 3 (新终端)
cargo run --release -- \
  --node-id node-3 \
  --listen 127.0.0.1:9002 \
  --http-port 8082 \
  --storage-path ./storage3 \
  --seed-nodes 127.0.0.1:9000
```

### 方式二: Docker Compose 部署

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  nats:
    image: nats:2.9
    ports:
      - "4222:4222"
    networks:
      - nas-network

  node1:
    build: .
    environment:
      - NODE_ID=node-1
      - LISTEN_ADDR=0.0.0.0:9000
      - HTTP_PORT=8080
      - NATS_URL=nats://nats:4222
      - STORAGE_PATH=/data
      - SEED_NODES=
    ports:
      - "9000:9000"
      - "8080:8080"
    volumes:
      - node1-data:/data
    networks:
      - nas-network
    depends_on:
      - nats

  node2:
    build: .
    environment:
      - NODE_ID=node-2
      - LISTEN_ADDR=0.0.0.0:9000
      - HTTP_PORT=8080
      - NATS_URL=nats://nats:4222
      - STORAGE_PATH=/data
      - SEED_NODES=node1:9000
    ports:
      - "9001:9000"
      - "8081:8080"
    volumes:
      - node2-data:/data
    networks:
      - nas-network
    depends_on:
      - nats
      - node1

  node3:
    build: .
    environment:
      - NODE_ID=node-3
      - LISTEN_ADDR=0.0.0.0:9000
      - HTTP_PORT=8080
      - NATS_URL=nats://nats:4222
      - STORAGE_PATH=/data
      - SEED_NODES=node1:9000
    ports:
      - "9002:9000"
      - "8082:8080"
    volumes:
      - node3-data:/data
    networks:
      - nas-network
    depends_on:
      - nats
      - node1

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  nas-network:
    driver: bridge
```

启动集群:

```bash
docker-compose up -d
```

---

## 📝 详细部署步骤

### 步骤 1: 准备配置文件

为每个节点创建配置文件 `config.toml`:

**节点 1 (种子节点) - config-node1.toml**

```toml
[node]
node_id = "node-1"
listen_addr = "0.0.0.0:9000"
seed_nodes = []  # 种子节点不需要配置其他节点

[node.discovery]
heartbeat_interval = 10  # 心跳间隔(秒)
node_timeout = 30        # 节点超时(秒)

[sync]
auto_sync = true
sync_interval = 60           # 同步间隔(秒)
max_files_per_sync = 100     # 每次最大同步文件数
max_retries = 3              # 最大重试次数

[storage]
root_path = "/data/storage1"
chunk_size = 10485760  # 10MB

[http]
host = "0.0.0.0"
port = 8080

[nats]
url = "nats://localhost:4222"
topic_prefix = "nas"

[version]
enabled = true
max_versions = 10
retention_days = 30
```

**节点 2 - config-node2.toml**

```toml
[node]
node_id = "node-2"
listen_addr = "0.0.0.0:9000"
seed_nodes = ["192.168.1.10:9000"]  # 节点1的地址

[node.discovery]
heartbeat_interval = 10
node_timeout = 30

[sync]
auto_sync = true
sync_interval = 60
max_files_per_sync = 100
max_retries = 3

[storage]
root_path = "/data/storage2"
chunk_size = 10485760

[http]
host = "0.0.0.0"
port = 8080

[nats]
url = "nats://192.168.1.10:4222"
topic_prefix = "nas"

[version]
enabled = true
max_versions = 10
retention_days = 30
```

**节点 3 - config-node3.toml**

```toml
[node]
node_id = "node-3"
listen_addr = "0.0.0.0:9000"
seed_nodes = ["192.168.1.10:9000"]  # 节点1的地址

# ... 其他配置类似节点2
```

### 步骤 2: 部署 NATS 服务器

NATS 用于节点间的事件通知。

**使用 Docker:**

```bash
docker run -d \
  --name nats-server \
  -p 4222:4222 \
  -p 8222:8222 \
  nats:2.9 \
  --http_port 8222
```

**使用二进制:**

```bash
# 下载
wget https://github.com/nats-io/nats-server/releases/download/v2.9.0/nats-server-v2.9.0-linux-amd64.tar.gz
tar -xzf nats-server-v2.9.0-linux-amd64.tar.gz

# 启动
./nats-server -p 4222 -m 8222
```

### 步骤 3: 编译 Silent-NAS

```bash
# 克隆代码
git clone https://github.com/silent-rs/silent-nas.git
cd silent-nas

# 编译 release 版本
cargo build --release

# 二进制文件位于
# target/release/silent-nas
```

### 步骤 4: 启动种子节点 (节点1)

```bash
# 在节点1机器上
./target/release/silent-nas \
  --config config-node1.toml \
  > node1.log 2>&1 &

# 查看日志
tail -f node1.log
```

等待看到:
```
INFO Silent-NAS 服务器启动中...
INFO QUIC 文件传输服务器启动: 0.0.0.0:9000
INFO HTTP 服务器启动: http://0.0.0.0:8080
```

### 步骤 5: 启动其他节点

```bash
# 在节点2机器上
./target/release/silent-nas \
  --config config-node2.toml \
  > node2.log 2>&1 &

# 在节点3机器上
./target/release/silent-nas \
  --config config-node3.toml \
  > node3.log 2>&1 &
```

### 步骤 6: 验证集群状态

```bash
# 查询节点1的集群状态
curl http://192.168.1.10:8080/api/nodes

# 预期输出:
# {
#   "nodes": [
#     {"node_id": "node-1", "address": "192.168.1.10:9000", "status": "online"},
#     {"node_id": "node-2", "address": "192.168.1.11:9000", "status": "online"},
#     {"node_id": "node-3", "address": "192.168.1.12:9000", "status": "online"}
#   ]
# }

# 查询同步状态
curl http://192.168.1.10:8080/api/sync/status

# 上传测试文件
curl -X POST -F "file=@test.txt" \
  http://192.168.1.10:8080/api/files/upload

# 在其他节点查询（应该已同步）
curl http://192.168.1.11:8080/api/files/list
```

---

## ⚙️ 配置说明

### 节点配置

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `node_id` | 节点唯一标识 | 自动生成 | "node-1" |
| `listen_addr` | gRPC 监听地址 | "127.0.0.1:9000" | "0.0.0.0:9000" |
| `seed_nodes` | 种子节点列表 | [] | ["192.168.1.10:9000"] |
| `heartbeat_interval` | 心跳间隔(秒) | 10 | 10 |
| `node_timeout` | 节点超时(秒) | 30 | 30 |

### 同步配置

| 参数 | 说明 | 默认值 | 推荐值 |
|------|------|--------|--------|
| `auto_sync` | 启用自动同步 | true | true |
| `sync_interval` | 同步间隔(秒) | 60 | 30-300 |
| `max_files_per_sync` | 每次最大同步数 | 100 | 50-500 |
| `max_retries` | 最大重试次数 | 3 | 3-5 |

### 存储配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `root_path` | 存储根目录 | "./storage" |
| `chunk_size` | 分块大小 | 10MB |

---

## 📊 监控和管理

### 健康检查

```bash
# HTTP 健康检查
curl http://localhost:8080/health

# 响应:
# {
#   "status": "healthy",
#   "node_id": "node-1",
#   "uptime": 3600,
#   "connected_nodes": 2
# }
```

### 节点管理 API

```bash
# 列出所有节点
curl http://localhost:8080/api/nodes

# 获取节点详情
curl http://localhost:8080/api/nodes/node-1

# 移除节点
curl -X DELETE http://localhost:8080/api/nodes/node-2
```

### 同步状态监控

```bash
# 获取同步统计
curl http://localhost:8080/api/sync/status

# 响应:
# {
#   "total_files": 1000,
#   "synced_files": 950,
#   "pending_files": 50,
#   "last_sync_time": "2025-10-16T11:30:00Z",
#   "error_count": 2
# }

# 触发手动同步
curl -X POST http://localhost:8080/api/sync/trigger
```

### 日志监控

推荐使用结构化日志工具:

```bash
# 使用 journalctl (systemd)
journalctl -u silent-nas -f

# 或查看日志文件
tail -f /var/log/silent-nas/node1.log

# 过滤错误日志
grep ERROR /var/log/silent-nas/node1.log
```

---

## 🔍 故障排查

### 常见问题

#### 1. 节点无法连接

**症状**: 节点日志显示 "连接到种子节点失败"

**排查步骤**:
```bash
# 1. 检查网络连通性
ping 192.168.1.10

# 2. 检查端口是否开放
telnet 192.168.1.10 9000

# 3. 检查防火墙
sudo firewall-cmd --list-ports

# 4. 检查节点进程
ps aux | grep silent-nas
```

**解决方案**:
- 开放防火墙端口: `sudo firewall-cmd --add-port=9000/tcp --permanent`
- 检查配置文件中的 seed_nodes 地址是否正确
- 确保种子节点已启动

#### 2. 文件同步失败

**症状**: 文件上传到节点1，但节点2看不到

**排查步骤**:
```bash
# 1. 检查同步状态
curl http://localhost:8080/api/sync/status

# 2. 检查节点连接
curl http://localhost:8080/api/nodes

# 3. 查看同步日志
grep "sync" /var/log/silent-nas/node1.log
```

**解决方案**:
- 检查 `auto_sync` 是否启用
- 手动触发同步: `curl -X POST http://localhost:8080/api/sync/trigger`
- 检查网络带宽和延迟

#### 3. NATS 连接失败

**症状**: 日志显示 "连接 NATS 失败"

**排查步骤**:
```bash
# 1. 检查 NATS 服务状态
docker ps | grep nats

# 2. 测试 NATS 连接
telnet localhost 4222

# 3. 查看 NATS 日志
docker logs nats-server
```

**解决方案**:
- 启动 NATS: `docker start nats-server`
- 检查配置文件中的 NATS URL
- 确保 NATS 端口 4222 可访问

#### 4. 节点心跳超时

**症状**: 节点频繁掉线

**排查步骤**:
```bash
# 查看心跳日志
grep "heartbeat" /var/log/silent-nas/node1.log

# 查看网络延迟
ping -c 10 192.168.1.11
```

**解决方案**:
- 增加 `node_timeout` 值 (如 60秒)
- 检查网络稳定性
- 降低 `heartbeat_interval` (如 5秒)

---

## 💡 最佳实践

### 1. 集群规模建议

- **小型集群**: 3-5 个节点
- **中型集群**: 5-10 个节点
- **大型集群**: 10-50 个节点

每增加一个节点，确保网络带宽充足。

### 2. 种子节点配置

- 至少配置 2-3 个种子节点
- 种子节点应该是稳定的节点
- 新节点配置多个种子节点地址

```toml
[node]
seed_nodes = [
    "192.168.1.10:9000",  # 种子节点1
    "192.168.1.11:9000",  # 种子节点2
    "192.168.1.12:9000"   # 种子节点3
]
```

### 3. 存储规划

- 每个节点使用独立的存储路径
- 使用 SSD 提升性能
- 定期备份重要数据
- 监控磁盘使用率

### 4. 网络优化

- 使用千兆网络
- 节点间使用专用网络
- 启用 TCP BBR 拥塞控制

```bash
# 启用 BBR
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p
```

### 5. 安全配置

- 使用 TLS 加密 gRPC 通信
- 配置防火墙规则
- 启用认证和授权
- 定期更新依赖

### 6. 监控告警

推荐监控指标:
- 节点在线状态
- 文件同步延迟
- 磁盘使用率
- 网络带宽
- CPU 和内存使用率

### 7. 备份策略

```bash
# 定期备份配置文件
tar -czf config-backup-$(date +%Y%m%d).tar.gz config/

# 备份数据库（如果使用）
pg_dump nas_db > backup-$(date +%Y%m%d).sql

# 备份存储数据
rsync -av /data/storage/ /backup/storage/
```

---

## 🎯 生产环境部署清单

- [ ] 硬件资源准备充足
- [ ] 网络规划完成 (IP、端口)
- [ ] NATS 服务器部署并测试
- [ ] 配置文件准备完成
- [ ] 防火墙规则配置
- [ ] 监控系统部署
- [ ] 日志收集配置
- [ ] 备份策略制定
- [ ] 灾难恢复计划
- [ ] 文档和运维手册准备

---

## 📚 相关文档

- [跨节点同步实现报告](./跨节点同步实现报告.md)
- [开发总结](./开发总结-2025-10-16.md)
- [API 文档](./API文档.md)
- [故障排查手册](./故障排查手册.md)

---

## 🆘 获取帮助

- GitHub Issues: https://github.com/silent-rs/silent-nas/issues
- 社区论坛: https://discuss.silent-rs.org
- 邮件: support@silent-rs.org

---

**最后更新**: 2025-10-16
**文档版本**: v1.0
**适用版本**: Silent-NAS v0.3.0+
