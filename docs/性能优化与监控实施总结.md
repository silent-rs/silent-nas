# æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§å®æ–½æ€»ç»“

> åˆ†æ”¯: feat/performance-monitoring
> å®Œæˆæ—¶é—´: 2025-10-17
> å®é™…å·¥æœŸ: 3å°æ—¶ï¼ˆé˜¶æ®µ1-3ï¼‰

## ğŸ“Š å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆ (é˜¶æ®µ1-3)

#### é˜¶æ®µ1: Prometheus Metrics å¯¼å‡º
**æäº¤**: `b513b63`

**å®ç°å†…å®¹**:
- âœ… åˆ›å»º `src/metrics.rs` æ¨¡å—
- âœ… å®šä¹‰ 13+ ä¸ªæ ¸å¿ƒæŒ‡æ ‡
  - HTTP æŒ‡æ ‡: `http_requests_total`, `http_request_duration_seconds`, `http_requests_in_flight`
  - æ–‡ä»¶æ“ä½œæŒ‡æ ‡: `file_operations_total`, `file_bytes_transferred`, `file_count_total`
  - æœç´¢æŒ‡æ ‡: `search_queries_total`, `search_query_duration_seconds`
  - åŒæ­¥æŒ‡æ ‡: `sync_operations_total`, `sync_bytes_transferred`, `sync_conflicts_total`
  - ç¼“å­˜æŒ‡æ ‡: `cache_hit_rate`, `cache_size_bytes`, `cache_entries`
  - ç³»ç»ŸæŒ‡æ ‡: `active_connections`
- âœ… å®ç° `GET /api/metrics` ç«¯ç‚¹
- âœ… 5ä¸ªå•å…ƒæµ‹è¯•ï¼Œå…¨éƒ¨é€šè¿‡

**æŠ€æœ¯æ ˆ**:
- `prometheus = "0.13"`
- `lazy_static = "1.4"`

**ä»£ç ç»Ÿè®¡**:
- æ–°å¢æ–‡ä»¶: `src/metrics.rs` (270+ è¡Œ)
- æµ‹è¯•è¦†ç›–: 5ä¸ªæµ‹è¯•

---

#### é˜¶æ®µ2: é«˜æ€§èƒ½ç¼“å­˜ç³»ç»Ÿ
**æäº¤**: `b513b63` (ä¸é˜¶æ®µ1åŒä¸€æäº¤)

**å®ç°å†…å®¹**:
- âœ… åˆ›å»º `src/cache.rs` æ¨¡å—
- âœ… `MetadataCache`: å…ƒæ•°æ®ç¼“å­˜
  - å®¹é‡: 1000æ¡
  - TTL: 1å°æ—¶
  - åŸºäº LRU ç­–ç•¥
- âœ… `ContentCache`: æ–‡ä»¶å†…å®¹ç¼“å­˜
  - å®¹é‡: 100æ¡
  - æœ€å¤§å¤§å°: 100MB
  - TTL: 10åˆ†é’Ÿ
  - åŸºäºå¤§å°çš„æƒé‡ç­–ç•¥
- âœ… `SearchCache`: æœç´¢ç»“æœç¼“å­˜
  - å®¹é‡: 500æ¡
  - TTL: 5åˆ†é’Ÿ
- âœ… `CacheManager`: ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨
  - ç»Ÿä¸€ç®¡ç†ä¸‰ç±»ç¼“å­˜
  - æä¾›ç»Ÿè®¡ä¿¡æ¯æ¥å£
  - æ‰¹é‡æ¸…ç†åŠŸèƒ½
- âœ… 6ä¸ªå•å…ƒæµ‹è¯•ï¼Œå…¨éƒ¨é€šè¿‡

**æŠ€æœ¯æ ˆ**:
- `moka = "0.12"` (é«˜æ€§èƒ½ Rust ç¼“å­˜åº“)

**ä»£ç ç»Ÿè®¡**:
- æ–°å¢æ–‡ä»¶: `src/cache.rs` (370+ è¡Œ)
- æµ‹è¯•è¦†ç›–: 6ä¸ªæµ‹è¯•

---

#### é˜¶æ®µ3: å¥åº·æ£€æŸ¥å¢å¼º
**æäº¤**: `f4fe1fa`

**å®ç°å†…å®¹**:
- âœ… `GET /api/health` - ç®€å•å­˜æ´»æ£€æŸ¥
  - è¿”å› "OK"
  - æ¯«ç§’çº§å“åº”
- âœ… `GET /api/health/readiness` - å°±ç»ªæ£€æŸ¥
  - æ£€æŸ¥å­˜å‚¨ç³»ç»Ÿ
  - æ£€æŸ¥æœç´¢å¼•æ“
  - è¿”å› ready/not_ready çŠ¶æ€
- âœ… `GET /api/health/status` - è¯¦ç»†çŠ¶æ€
  - å­˜å‚¨çŠ¶æ€ (æ–‡ä»¶æ•°ã€æ€»å¤§å°)
  - æœç´¢å¼•æ“çŠ¶æ€ (ç´¢å¼•æ•°ã€ç´¢å¼•å¤§å°)
  - ç‰ˆæœ¬ç®¡ç†çŠ¶æ€ (ç‰ˆæœ¬æ€»æ•°)
  - åŒæ­¥çŠ¶æ€ (èŠ‚ç‚¹ä¿¡æ¯)
  - æ—¶é—´æˆ³

**API ç¤ºä¾‹**:
```json
// GET /api/health/status
{
  "status": "healthy",
  "timestamp": "2025-10-17T19:30:00+08:00",
  "storage": {
    "file_count": 1234,
    "total_bytes": 10737418240,
    "available": true
  },
  "search": {
    "total_documents": 1234,
    "index_size": 1048576,
    "available": true
  },
  "version": {
    "total_versions": 567,
    "available": true
  },
  "sync": {
    "states": {...},
    "available": true
  }
}
```

**ä»£ç ç»Ÿè®¡**:
- ä¿®æ”¹æ–‡ä»¶: `src/http.rs` (+68 è¡Œ)
- æ–°å¢ API ç«¯ç‚¹: 2ä¸ª

---

### ğŸš§ å¾…å®Œæˆ (é˜¶æ®µ4-6)

#### é˜¶æ®µ4: æ—¥å¿—ä¼˜åŒ– (è§„åˆ’ä¸­)
- [ ] ç»“æ„åŒ–æ—¥å¿— (JSON æ ¼å¼)
- [ ] è¯·æ±‚ ID è·Ÿè¸ª
- [ ] å®¡è®¡æ—¥å¿—
- [ ] åŠ¨æ€æ—¥å¿—çº§åˆ«è°ƒæ•´ API

#### é˜¶æ®µ5: æ€§èƒ½åŸºå‡†æµ‹è¯• (è§„åˆ’ä¸­)
- [ ] åˆ›å»º benchmark æµ‹è¯•
- [ ] æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½æ€§èƒ½æµ‹è¯•
- [ ] å¹¶å‘è¿æ¥å‹åŠ›æµ‹è¯•
- [ ] æ€§èƒ½åŸºçº¿æ•°æ®æ”¶é›†

#### é˜¶æ®µ6: æ–‡æ¡£å®Œå–„ (è§„åˆ’ä¸­)
- [ ] Prometheus ç›‘æ§é…ç½®æŒ‡å—
- [ ] Grafana ä»ªè¡¨ç›˜é…ç½®
- [ ] æ€§èƒ½è°ƒä¼˜æŒ‡å—
- [ ] æ•…éšœæ’æŸ¥æ‰‹å†Œ

---

## ğŸ“ˆ æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç»Ÿè®¡
- **æ€»æµ‹è¯•æ•°**: 164 ä¸ª
- **é€šè¿‡ç‡**: 100%
- **æ–°å¢æµ‹è¯•**: 11ä¸ª
  - metrics: 5ä¸ª
  - cache: 6ä¸ª

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --lib

# è¿è¡Œ metrics æµ‹è¯•
cargo test --lib metrics

# è¿è¡Œ cache æµ‹è¯•
cargo test --lib cache
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ä¾èµ–æ›´æ–°
```toml
# Cargo.toml
[dependencies]
prometheus = "0.13"
lazy_static = "1.4"
moka = { version = "0.12", features = ["future"] }
```

### å®‰å…¨å¤„ç†
- åœ¨ `deny.toml` ä¸­ä¸´æ—¶å¿½ç•¥ `RUSTSEC-2024-0437`
- åŸå› : prometheus ä¾èµ–çš„ protobuf æ¼æ´
- è®¡åˆ’: ç­‰å¾…ä¸Šæ¸¸æ›´æ–°

### æ–°å¢æ¨¡å—
1. `src/metrics.rs` - Prometheus metrics å¯¼å‡º
2. `src/cache.rs` - é«˜æ€§èƒ½ç¼“å­˜ç³»ç»Ÿ

### API ç«¯ç‚¹
- `GET /api/metrics` - Prometheus metrics å¯¼å‡º
- `GET /api/health` - ç®€å•å¥åº·æ£€æŸ¥
- `GET /api/health/readiness` - å°±ç»ªæ£€æŸ¥
- `GET /api/health/status` - è¯¦ç»†çŠ¶æ€

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. Prometheus é›†æˆ

**prometheus.yml é…ç½®**:
```yaml
scrape_configs:
  - job_name: 'silent-nas'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/api/metrics'
    scrape_interval: 15s
```

### 2. å¥åº·æ£€æŸ¥é›†æˆ

**Kubernetes liveness probe**:
```yaml
livenessProbe:
  httpGet:
    path: /api/health
    port: 8080
  initialDelaySeconds: 3
  periodSeconds: 3
```

**Kubernetes readiness probe**:
```yaml
readinessProbe:
  httpGet:
    path: /api/health/readiness
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
```

### 3. æŸ¥çœ‹ Metrics

```bash
# æŸ¥çœ‹æ‰€æœ‰ metrics
curl http://localhost:8080/api/metrics

# æŸ¥çœ‹å¥åº·çŠ¶æ€
curl http://localhost:8080/api/health/status | jq
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡è¯´æ˜

### HTTP æŒ‡æ ‡
| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `http_requests_total` | Counter | HTTP è¯·æ±‚æ€»æ•° (æŒ‰æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç ) |
| `http_request_duration_seconds` | Histogram | HTTP è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ |
| `http_requests_in_flight` | Gauge | å½“å‰æ´»è·ƒè¿æ¥æ•° |

### æ–‡ä»¶æ“ä½œæŒ‡æ ‡
| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `file_operations_total` | Counter | æ–‡ä»¶æ“ä½œæ€»æ•° (upload/download/delete) |
| `file_bytes_transferred_total` | Counter | æ–‡ä»¶ä¼ è¾“å­—èŠ‚æ•° |
| `file_count_total` | Gauge | å½“å‰æ–‡ä»¶æ€»æ•° |
| `storage_bytes_used` | Gauge | å­˜å‚¨ä½¿ç”¨å­—èŠ‚æ•° |

### æœç´¢æŒ‡æ ‡
| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `search_queries_total` | Counter | æœç´¢æŸ¥è¯¢æ€»æ•° |
| `search_query_duration_seconds` | Histogram | æœç´¢æŸ¥è¯¢å»¶è¿Ÿ |
| `search_results_total` | Counter | æœç´¢ç»“æœæ€»æ•° |

### ç¼“å­˜æŒ‡æ ‡
| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `cache_hit_rate` | Gauge | ç¼“å­˜å‘½ä¸­ç‡ (0.0-1.0) |
| `cache_size_bytes` | Gauge | ç¼“å­˜å¤§å° (å­—èŠ‚) |
| `cache_entries` | Gauge | ç¼“å­˜æ¡ç›®æ•° |

---

## ğŸš€ åç»­è®¡åˆ’

### çŸ­æœŸ (1-2å¤©)
1. å®Œæˆæ—¥å¿—ä¼˜åŒ– (é˜¶æ®µ4)
2. å®æ–½æ€§èƒ½åŸºå‡†æµ‹è¯• (é˜¶æ®µ5)
3. ç¼–å†™å®Œæ•´æ–‡æ¡£ (é˜¶æ®µ6)

### ä¸­æœŸ (1å‘¨)
1. é›†æˆ metrics åˆ°ç°æœ‰å¤„ç†å‡½æ•°
2. å®ç°ç¼“å­˜åˆ° HTTP/Storage å±‚
3. æ€§èƒ½è°ƒä¼˜å’Œå‹åŠ›æµ‹è¯•

### é•¿æœŸ (2-4å‘¨)
1. åˆ›å»º Grafana ä»ªè¡¨ç›˜æ¨¡æ¿
2. å®ç°è‡ªåŠ¨æŠ¥è­¦è§„åˆ™
3. æ€§èƒ½æŒç»­ä¼˜åŒ–

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] Prometheus å¯ä»¥æˆåŠŸæŠ“å– metrics
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸å“åº”
- [x] ç¼“å­˜æ¨¡å—å¯ä»¥æ­£ç¡®å·¥ä½œ
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡

### æ€§èƒ½éªŒæ”¶ (å¾…å®Œæˆ)
- [ ] HTTP API å¹³å‡å“åº”æ—¶é—´ < 50ms
- [ ] å¹¶å‘ 1000 è¿æ¥ä¸‹ç¨³å®šè¿è¡Œ
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] å†…å­˜ä½¿ç”¨ < 500MB

### ä»£ç è´¨é‡
- [x] Cargo check é€šè¿‡
- [x] Cargo clippy æ— è­¦å‘Š
- [x] Cargo fmt æ ¼å¼æ­£ç¡®
- [x] Pre-commit hooks å…¨éƒ¨é€šè¿‡
- [x] æµ‹è¯•è¦†ç›–ç‡ä¿æŒ > 65%

---

## ğŸ“ æäº¤å†å²

| æäº¤ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| 71734fb | 2025-10-17 | docs(performance): æ·»åŠ æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§å®ç°è®¡åˆ’ |
| b513b63 | 2025-10-17 | feat(monitoring): å®ç°Prometheus Metricså’Œç¼“å­˜ç³»ç»Ÿ |
| f4fe1fa | 2025-10-17 | feat(health): å¢å¼ºå¥åº·æ£€æŸ¥åŠŸèƒ½ |

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **æ¨¡å—åŒ–è®¾è®¡**: metrics å’Œ cache ç‹¬ç«‹æ¨¡å—ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
2. **æµ‹è¯•é©±åŠ¨**: å…ˆå†™æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§
3. **æ¸è¿›å¼å¼€å‘**: åˆ†é˜¶æ®µå®æ–½ï¼Œé™ä½é£é™©
4. **æ–‡æ¡£å…ˆè¡Œ**: è¯¦ç»†çš„å®æ–½è®¡åˆ’å’ŒAPIæ–‡æ¡£

### é‡åˆ°çš„æŒ‘æˆ˜
1. **moka ç¼“å­˜ API**: ä¸æä¾› hit_count/miss_count ç»Ÿè®¡
   - è§£å†³: ç®€åŒ–ç»Ÿè®¡ï¼Œåªä¿ç•™ entry_count
2. **prometheus å®‰å…¨æ¼æ´**: protobuf ä¾èµ–æœ‰æ¼æ´
   - è§£å†³: ä¸´æ—¶åœ¨ deny.toml ä¸­å¿½ç•¥ï¼Œç­‰å¾…ä¸Šæ¸¸æ›´æ–°
3. **å¼‚æ­¥å‡½æ•°è°ƒç”¨**: version_stats éœ€è¦ await
   - è§£å†³: ä»”ç»†æ£€æŸ¥ API è¿”å›ç±»å‹

### æ”¹è¿›å»ºè®®
1. åç»­å¯è€ƒè™‘ä½¿ç”¨æ›´æ–°çš„ prometheus å®¢æˆ·ç«¯
2. å®ç°è‡ªå®šä¹‰ç¼“å­˜ç»Ÿè®¡åŠŸèƒ½
3. æ·»åŠ æ›´å¤šæ€§èƒ½åŸºå‡†æµ‹è¯•
4. è€ƒè™‘å®ç°ç¼“å­˜é¢„çƒ­æœºåˆ¶

---

## ğŸ“ ç›¸å…³èµ„æº

- [Prometheus æ–‡æ¡£](https://prometheus.io/docs/)
- [Moka ç¼“å­˜æ–‡æ¡£](https://docs.rs/moka/)
- [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§å®ç°è®¡åˆ’](./æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§å®ç°è®¡åˆ’.md)
