# 性能优化与监控实现计划

> 分支: feat/performance-monitoring
> 开始时间: 2025-10-17
> 预计工期: 1周

## 目标

实现完整的性能监控和优化系统，为生产部署做准备。

## 任务列表

### 阶段 1: Prometheus Metrics 导出 (优先级: P0)

#### 1.1 添加依赖
```toml
prometheus = "0.13"
lazy_static = "1.4"
```

#### 1.2 实现 Metrics 模块 (src/metrics.rs)
- [ ] 定义核心指标
  - [ ] HTTP 请求计数器 (按方法、路径、状态码)
  - [ ] HTTP 请求延迟直方图
  - [ ] 文件操作计数器 (上传/下载/删除)
  - [ ] 文件传输字节数
  - [ ] 当前活跃连接数
  - [ ] 存储使用情况 (文件数、总大小)
  - [ ] 搜索查询计数和延迟
  - [ ] 同步操作统计
- [ ] Metrics 导出端点
  - [ ] `GET /metrics` - Prometheus 格式

#### 1.3 集成到现有模块
- [ ] HTTP 处理器中间件
- [ ] 存储操作包装
- [ ] 搜索引擎统计
- [ ] 同步管理器统计

### 阶段 2: 缓存优化 (优先级: P1)

#### 2.1 添加依赖
```toml
moka = { version = "0.12", features = ["future"] }
```

#### 2.2 实现缓存模块 (src/cache.rs)
- [ ] 文件元数据缓存 (LRU, 1000条)
- [ ] 文件内容缓存 (LRU, 100MB)
- [ ] 搜索结果缓存 (TTL: 5分钟)
- [ ] ETag 缓存

#### 2.3 集成缓存
- [ ] StorageManager 集成元数据缓存
- [ ] HTTP 响应集成内容缓存
- [ ] SearchEngine 集成查询缓存

### 阶段 3: 性能基准测试 (优先级: P1)

#### 3.1 创建基准测试 (benches/)
- [ ] 文件上传性能
- [ ] 文件下载性能
- [ ] 元数据查询性能
- [ ] 搜索查询性能
- [ ] 并发连接测试

#### 3.2 性能测试工具
```bash
# Makefile 添加测试命令
bench:
    cargo bench

stress-test:
    # 使用 wrk 或 hey 进行压力测试
```

### 阶段 4: 日志优化 (优先级: P2)

#### 4.1 结构化日志
- [ ] 使用 `tracing-subscriber` JSON 格式
- [ ] 添加请求 ID 跟踪
- [ ] 添加用户 ID 跟踪 (如果有认证)
- [ ] 性能指标日志

#### 4.2 审计日志
- [ ] 文件操作审计 (创建/修改/删除)
- [ ] 用户操作审计
- [ ] 敏感操作日志 (配置变更等)

#### 4.3 日志级别动态调整
- [ ] `POST /admin/log-level` - 动态调整日志级别

### 阶段 5: 健康检查增强 (优先级: P2)

#### 5.1 详细健康检查
- [ ] `GET /health/liveness` - 存活检查
- [ ] `GET /health/readiness` - 就绪检查
- [ ] `GET /health/status` - 详细状态
  - 存储状态 (可用空间、文件数)
  - NATS 连接状态
  - 搜索引擎状态
  - 同步状态

### 阶段 6: 性能优化 (优先级: P1)

#### 6.1 文件传输优化
- [ ] 零拷贝优化 (使用 tokio sendfile)
- [ ] 压缩支持 (gzip, brotli)
- [ ] 连接池优化

#### 6.2 数据库优化 (如果使用)
- [ ] 索引优化
- [ ] 查询优化
- [ ] 连接池配置

## 实现顺序

```
Day 1-2: Prometheus Metrics
  ├─ 创建 metrics.rs 模块
  ├─ 定义核心指标
  ├─ 实现 /metrics 端点
  └─ 集成到现有模块

Day 3: 缓存优化
  ├─ 创建 cache.rs 模块
  ├─ 实现 LRU 缓存
  └─ 集成到 Storage 和 HTTP

Day 4: 性能测试
  ├─ 创建 benchmark 测试
  ├─ 编写压力测试脚本
  └─ 收集性能基线数据

Day 5: 日志优化
  ├─ 结构化日志配置
  ├─ 审计日志实现
  └─ 动态日志级别

Day 6-7: 优化与文档
  ├─ 性能优化实施
  ├─ 健康检查增强
  └─ 文档编写
```

## 验收标准

### 功能验收
- [ ] Prometheus 可以成功抓取 metrics
- [ ] 缓存命中率 > 80% (元数据)
- [ ] 健康检查响应时间 < 10ms
- [ ] 日志正确输出 JSON 格式

### 性能验收
- [ ] 文件下载速度提升 20%+ (缓存命中时)
- [ ] HTTP API 平均响应时间 < 50ms
- [ ] 并发 1000 连接下稳定运行
- [ ] 内存使用合理 (< 500MB 正常负载)

### 代码质量
- [ ] 所有测试通过
- [ ] Clippy 无警告
- [ ] 代码覆盖率保持 > 65%

## 技术选型

- **Metrics**: `prometheus` crate (官方 Rust 客户端)
- **缓存**: `moka` (高性能 Rust 缓存库，支持 TTL 和 LRU)
- **日志**: `tracing` + `tracing-subscriber` (已使用)
- **基准测试**: `criterion` (Rust 标准基准测试库)
- **压力测试**: `wrk` 或 `hey` (外部工具)

## 监控指标设计

### HTTP 指标
```
http_requests_total{method, path, status}
http_request_duration_seconds{method, path}
http_requests_in_flight
```

### 文件操作指标
```
file_operations_total{operation}  # upload, download, delete
file_bytes_transferred_total{direction}  # sent, received
file_count_total
storage_bytes_used
```

### 搜索指标
```
search_queries_total
search_query_duration_seconds
search_results_total
```

### 同步指标
```
sync_operations_total{type}  # full, incremental
sync_bytes_transferred_total
sync_conflicts_total
```

### 系统指标
```
active_connections
cache_hit_rate{cache_type}
cache_size_bytes{cache_type}
```

## 参考资料

- [Prometheus Best Practices](https://prometheus.io/docs/practices/)
- [Moka Cache Documentation](https://docs.rs/moka/)
- [Tracing Documentation](https://docs.rs/tracing/)
- [Criterion Benchmarking](https://docs.rs/criterion/)
