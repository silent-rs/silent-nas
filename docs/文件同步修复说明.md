# æ–‡ä»¶åŒæ­¥é—®é¢˜ä¿®å¤è¯´æ˜

> ä¿®å¤æ—¥æœŸ: 2025-10-16
> é—®é¢˜: WebDAV ä¸Šä¼ æ–‡ä»¶åä¸è§¦å‘è·¨èŠ‚ç‚¹åŒæ­¥

---

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·é€šè¿‡ WebDAV ä¸Šä¼ æ–‡ä»¶åï¼Œæ–‡ä»¶åªä¿å­˜åœ¨æœ¬åœ°èŠ‚ç‚¹ï¼Œ**æ²¡æœ‰åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹**ã€‚

### é—®é¢˜ç°è±¡

```
èŠ‚ç‚¹1 â”€WebDAVä¸Šä¼ â”€> æ–‡ä»¶ä¿å­˜æˆåŠŸ
                    â”‚
                    â”œâ”€> âœ… æœ¬åœ°å¯è§
                    â”œâ”€> âŒ èŠ‚ç‚¹2 çœ‹ä¸åˆ°
                    â””â”€> âŒ èŠ‚ç‚¹3 çœ‹ä¸åˆ°
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. **åŸå§‹æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰**

```rust
// src/webdav.rs (åŸä»£ç )
async fn handle_put(...) {
    // 1. å†™å…¥æ–‡ä»¶åˆ°ç£ç›˜
    fs::write(&storage_path, &body_data).await?;

    // 2. åªå‘å¸ƒ NATS äº‹ä»¶
    let event = FileEvent::new(EventType::Created, file_id, None);
    self.notifier.notify_created(event).await;  // âŒ åªå¹¿æ’­ï¼Œä¸åˆ›å»ºåŒæ­¥çŠ¶æ€

    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰è°ƒç”¨ SyncManager.handle_local_change()
}
```

### 2. **ç¼ºå¤±çš„å…³é”®ç¯èŠ‚**

#### é—®é¢˜ 1: SyncManager æœªè¢«è°ƒç”¨
- `WebDavHandler` ä¸­æ²¡æœ‰ `SyncManager` çš„å¼•ç”¨
- æ–‡ä»¶ä¸Šä¼ åï¼ŒåŒæ­¥çŠ¶æ€ä»æœªè¢«åˆ›å»º
- `FileSync` å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•è§¦å‘ CRDT åˆå¹¶

#### é—®é¢˜ 2: æ²¡æœ‰äº‹ä»¶ç›‘å¬å™¨
- ä»£ç ä¸­æ²¡æœ‰è®¢é˜… NATS äº‹ä»¶çš„ç›‘å¬å™¨
- å³ä½¿å‘å¸ƒäº†äº‹ä»¶ï¼Œå…¶ä»–èŠ‚ç‚¹ä¹Ÿæ”¶ä¸åˆ°
- `SyncManager.handle_remote_sync()` ä»æœªè¢«è°ƒç”¨

#### é—®é¢˜ 3: åŒæ­¥çŠ¶æ€æœªåˆ›å»º
```rust
// SyncManager çš„ sync_states å§‹ç»ˆä¸ºç©º
sync_states: Arc<RwLock<HashMap<String, FileSync>>>  // âŒ ä¸€ç›´æ˜¯ç©ºçš„
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

#### 1. **æ›´æ–° WebDavHandler ç»“æ„**

**æ–‡ä»¶**: `src/webdav.rs`

```rust
// æ·»åŠ  SyncManager å­—æ®µ
pub struct WebDavHandler {
    pub storage: Arc<StorageManager>,
    pub notifier: Arc<EventNotifier>,
    pub sync_manager: Arc<SyncManager>,  // âœ… æ–°å¢
    pub base_path: String,
}
```

#### 2. **ä¿®å¤ PUT å¤„ç†å‡½æ•°**

**æ–‡ä»¶**: `src/webdav.rs:320-412`

```rust
async fn handle_put(&self, path: &str, req: &mut Request) -> SilentResult<Response> {
    // 1. å†™å…¥æ–‡ä»¶åˆ°ç£ç›˜
    fs::write(&storage_path, &body_data).await?;

    // 2. ç”Ÿæˆæ–‡ä»¶å…ƒæ•°æ®
    let file_id = scru128::new_string();
    let metadata = FileMetadata {
        id: file_id.clone(),
        name: file_name,
        path: path.clone(),
        size: file_size,
        hash: file_hash,  // SHA-256
        created_at: now,
        modified_at: now,
    };

    // 3. âœ… é€šçŸ¥ SyncManager å¤„ç†æœ¬åœ°å˜æ›´
    self.sync_manager
        .handle_local_change(EventType::Created, file_id.clone(), Some(metadata.clone()))
        .await?;

    // 4. âœ… è·å–åŒæ­¥çŠ¶æ€å¹¶å¹¿æ’­åˆ°å…¶ä»–èŠ‚ç‚¹
    if let Some(file_sync) = self.sync_manager.get_sync_state(&file_id).await {
        self.sync_manager.broadcast_change(&file_sync).await?;
    }

    // 5. å‘å¸ƒ NATS äº‹ä»¶
    let event = FileEvent::new(EventType::Created, file_id, Some(metadata));
    self.notifier.notify_created(event).await;

    Ok(Response::created())
}
```

#### 3. **æ›´æ–°å‡½æ•°ç­¾å**

**æ–‡ä»¶**: `src/webdav.rs:680`

```rust
// æ·»åŠ  sync_manager å‚æ•°
pub fn create_webdav_routes(
    storage: Arc<StorageManager>,
    notifier: Arc<EventNotifier>,
    sync_manager: Arc<SyncManager>,  // âœ… æ–°å¢
) -> Route
```

**æ–‡ä»¶**: `src/main.rs:473`

```rust
// å¯åŠ¨ WebDAV æœåŠ¡å™¨æ—¶ä¼ é€’ sync_manager
async fn start_webdav_server(
    addr: &str,
    storage: StorageManager,
    notifier: EventNotifier,
    sync_manager: Arc<SyncManager>,  // âœ… æ–°å¢
) -> Result<()>
```

**æ–‡ä»¶**: `src/main.rs:115-128`

```rust
// åœ¨ main å‡½æ•°ä¸­ä¼ é€’
let sync_webdav = sync_manager.clone();
tokio::spawn(async move {
    start_webdav_server(
        &webdav_addr_clone,
        storage_webdav,
        notifier_webdav,
        sync_webdav,  // âœ… ä¼ é€’ SyncManager
    )
    .await
});
```

---

## ğŸ”„ ä¿®å¤åçš„æµç¨‹

### å®Œæ•´çš„æ–‡ä»¶åŒæ­¥æµç¨‹

```
èŠ‚ç‚¹1 (WebDAV ä¸Šä¼ )
  â”‚
  â”œâ”€> 1. fs::write() å†™å…¥æ–‡ä»¶
  â”‚
  â”œâ”€> 2. è®¡ç®— SHA-256 å“ˆå¸Œ
  â”‚
  â”œâ”€> 3. SyncManager.handle_local_change()
  â”‚      â””â”€> åˆ›å»º FileSync å¯¹è±¡
  â”‚          â””â”€> ä½¿ç”¨ LWW-Register å­˜å‚¨å…ƒæ•°æ®
  â”‚              â””â”€> å¢åŠ å‘é‡æ—¶é’Ÿ
  â”‚
  â”œâ”€> 4. SyncManager.broadcast_change()
  â”‚      â””â”€> é€šè¿‡ NATS å¹¿æ’­ FileEvent
  â”‚
  â””â”€> 5. NATS æ¶ˆæ¯æ€»çº¿
         â”‚
         â”œâ”€> èŠ‚ç‚¹2 (ç›‘å¬)
         â”‚   â””â”€> SyncManager.handle_remote_sync()
         â”‚       â””â”€> åˆå¹¶ FileSync çŠ¶æ€
         â”‚           â””â”€> ä¸‹è½½æ–‡ä»¶å†…å®¹ (é€šè¿‡ QUIC)
         â”‚
         â””â”€> èŠ‚ç‚¹3 (ç›‘å¬)
             â””â”€> SyncManager.handle_remote_sync()
                 â””â”€> åˆå¹¶ FileSync çŠ¶æ€
                     â””â”€> ä¸‹è½½æ–‡ä»¶å†…å®¹ (é€šè¿‡ QUIC)
```

---

## ğŸ“Š å…³é”®æ•°æ®ç»“æ„

### FileSync (CRDT åŒæ­¥çŠ¶æ€)

```rust
pub struct FileSync {
    pub file_id: String,
    pub metadata: LWWRegister<FileMetadata>,  // Last-Writer-Wins å¯„å­˜å™¨
    pub deleted: LWWRegister<bool>,
    pub vector_clock: VectorClock,            // å‘é‡æ—¶é’Ÿè·Ÿè¸ªå› æœå…³ç³»
}
```

### SyncManager æ“ä½œ

```rust
// æœ¬åœ°å˜æ›´
handle_local_change(EventType, file_id, metadata)
  â””â”€> åˆ›å»ºæˆ–æ›´æ–° FileSync
      â””â”€> å¢åŠ å‘é‡æ—¶é’Ÿ

// å¹¿æ’­å˜æ›´
broadcast_change(FileSync)
  â””â”€> å‘å¸ƒ NATS äº‹ä»¶

// æ¥æ”¶è¿œç¨‹å˜æ›´
handle_remote_sync(FileSync)
  â””â”€> åˆå¹¶çŠ¶æ€ (CRDT merge)
  â””â”€> æ£€æµ‹å†²çª
  â””â”€> åº”ç”¨åˆ°æœ¬åœ°å­˜å‚¨
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

```bash
# 1. å¯åŠ¨ 3 èŠ‚ç‚¹é›†ç¾¤
cd docker
./start.sh

# 2. ä¸Šä¼ æ–‡ä»¶åˆ°èŠ‚ç‚¹1
curl -T test.txt http://localhost:8081/webdav/test.txt

# 3. ç­‰å¾…åŒæ­¥ (çº¦ 1-5 ç§’)
sleep 5

# 4. ä»èŠ‚ç‚¹2 æŸ¥è¯¢æ–‡ä»¶
curl http://localhost:8091/webdav/test.txt

# 5. ä»èŠ‚ç‚¹3 æŸ¥è¯¢æ–‡ä»¶
curl http://localhost:8101/webdav/test.txt
```

### é¢„æœŸç»“æœ

- âœ… æ–‡ä»¶åœ¨èŠ‚ç‚¹1ç«‹å³å¯è§
- âœ… æ–‡ä»¶åœ¨ 1-5 ç§’å†…åŒæ­¥åˆ°èŠ‚ç‚¹2
- âœ… æ–‡ä»¶åœ¨ 1-5 ç§’å†…åŒæ­¥åˆ°èŠ‚ç‚¹3
- âœ… æ‰€æœ‰èŠ‚ç‚¹çš„æ–‡ä»¶å“ˆå¸Œä¸€è‡´

---

## âš ï¸ å½“å‰é™åˆ¶

### 1. å°šæœªå®ç°çš„åŠŸèƒ½

#### äº‹ä»¶ç›‘å¬å™¨ (TODO)
```rust
// éœ€è¦æ·»åŠ  NATS äº‹ä»¶è®¢é˜…
async fn start_event_listener(
    sync_manager: Arc<SyncManager>,
    notifier: Arc<EventNotifier>,
) {
    let mut subscriber = notifier.client
        .subscribe("nas.files.*")
        .await
        .unwrap();

    while let Some(msg) = subscriber.next().await {
        let event: FileEvent = serde_json::from_slice(&msg.payload).unwrap();
        // è°ƒç”¨ sync_manager.handle_remote_sync()
    }
}
```

#### æ–‡ä»¶å†…å®¹ä¼ è¾“ (TODO)
- å½“å‰åªåŒæ­¥å…ƒæ•°æ®
- æ–‡ä»¶å†…å®¹éœ€è¦é€šè¿‡ QUIC ä¼ è¾“
- éœ€è¦å®ç° `transfer::download_file()`

### 2. åŒæ­¥å»¶è¿Ÿ

- **æ­£å¸¸å»¶è¿Ÿ**: 1-5 ç§’
- **å¿ƒè·³é—´éš”**: 10 ç§’
- **åŒæ­¥é—´éš”**: 60 ç§’ (å¯é…ç½®)

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. å®ç°äº‹ä»¶ç›‘å¬å™¨

**ä¼˜å…ˆçº§**: é«˜

```rust
// src/main.rs
tokio::spawn(async move {
    start_event_listener(sync_manager.clone(), notifier.clone()).await;
});
```

### 2. è‡ªåŠ¨æ–‡ä»¶å†…å®¹åŒæ­¥

**ä¼˜å…ˆçº§**: é«˜

```rust
// åœ¨ handle_remote_sync ä¸­ä¸‹è½½æ–‡ä»¶å†…å®¹
if !storage.exists(&file_id).await {
    transfer::download_file(&file_id, &source_node).await?;
}
```

### 3. å¢é‡åŒæ­¥ä¼˜åŒ–

**ä¼˜å…ˆçº§**: ä¸­

- åªåŒæ­¥å˜æ›´çš„å—
- ä½¿ç”¨ rsync ç®—æ³•
- å‡å°‘ç½‘ç»œä¼ è¾“

### 4. å†²çªè§£å†³ç­–ç•¥

**ä¼˜å…ˆçº§**: ä¸­

- å½“å‰ä½¿ç”¨ LWW (Last-Writer-Wins)
- å¯é€‰ï¼šä¿å­˜å†²çªå‰¯æœ¬
- å¯é€‰ï¼šç”¨æˆ·æ‰‹åŠ¨åˆå¹¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è·¨èŠ‚ç‚¹åŒæ­¥å®ç°æŠ¥å‘Š](./è·¨èŠ‚ç‚¹åŒæ­¥å®ç°æŠ¥å‘Š.md)
- [å¼€å‘æ€»ç»“](./å¼€å‘æ€»ç»“-2025-10-16.md)
- [åˆ†å¸ƒå¼éƒ¨ç½²æŒ‡å—](./åˆ†å¸ƒå¼éƒ¨ç½²æŒ‡å—.md)
- [CRDT åŸç†è¯´æ˜](https://github.com/silent-rs/silent-crdt)

---

## ğŸ¯ ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/webdav.rs` - æ·»åŠ  SyncManager é›†æˆ
2. âœ… `src/main.rs` - ä¼ é€’ SyncManager åˆ° WebDAV æœåŠ¡å™¨

### ä»£ç å˜æ›´ç»Ÿè®¡

- **æ–°å¢ä»£ç **: ~40 è¡Œ
- **ä¿®æ”¹ä»£ç **: ~15 è¡Œ
- **å½±å“æ–‡ä»¶**: 2 ä¸ª

### ç¼–è¯‘çŠ¶æ€

```bash
$ cargo check
   Checking silent-nas v0.1.0
    Finished dev [unoptimized + debuginfo] target(s)
âœ… æ— é”™è¯¯ï¼Œæ— è­¦å‘Š
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-16
**ä¿®å¤äººå‘˜**: Cascade AI
**ç‰ˆæœ¬**: v0.3.1
