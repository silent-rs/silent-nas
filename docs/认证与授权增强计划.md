# è®¤è¯ä¸æˆæƒå¢å¼ºå¼€å‘è®¡åˆ’

> åˆ†æ”¯: feat/authentication-enhancement
> ä¼˜å…ˆçº§: ğŸ”´ æœ€é«˜
> é¢„è®¡æ—¶é—´: 2å‘¨
> å¼€å§‹æ—¥æœŸ: 2025-10-17

---

## ğŸ“‹ ç›®æ ‡

å®ç°å®Œæ•´çš„å¤šç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†ç³»ç»Ÿï¼Œä¸ºSilent-NASæä¾›ä¼ä¸šçº§çš„å®‰å…¨ä¿éšœã€‚

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### é˜¶æ®µ1: JWT Token è®¤è¯ (3-4å¤©)

#### 1.1 ç”¨æˆ·æ¨¡å‹
```rust
pub struct User {
    pub id: String,
    pub username: String,
    pub email: String,
    pub password_hash: String,
    pub role: UserRole,
    pub status: UserStatus,
    pub created_at: DateTime<Local>,
    pub updated_at: DateTime<Local>,
}

pub enum UserRole {
    Admin,
    User,
    ReadOnly,
}

pub enum UserStatus {
    Active,
    Suspended,
    Deleted,
}
```

#### 1.2 JWT å®ç°
- [ ] JWT Token ç”Ÿæˆå’ŒéªŒè¯
- [ ] Token åˆ·æ–°æœºåˆ¶
- [ ] Token é»‘åå•ï¼ˆç”¨äºç™»å‡ºï¼‰
- [ ] é…ç½® Token è¿‡æœŸæ—¶é—´

#### 1.3 è®¤è¯ç«¯ç‚¹
- [ ] POST /api/auth/register - ç”¨æˆ·æ³¨å†Œ
- [ ] POST /api/auth/login - ç”¨æˆ·ç™»å½•
- [ ] POST /api/auth/logout - ç”¨æˆ·ç™»å‡º
- [ ] POST /api/auth/refresh - åˆ·æ–°Token
- [ ] GET /api/auth/me - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- [ ] PUT /api/auth/password - ä¿®æ”¹å¯†ç 

#### 1.4 å¯†ç å®‰å…¨
- [ ] ä½¿ç”¨ argon2 æˆ– bcrypt è¿›è¡Œå¯†ç å“ˆå¸Œ
- [ ] å¯†ç å¼ºåº¦éªŒè¯
- [ ] å¯†ç é‡ç½®åŠŸèƒ½ï¼ˆé‚®ä»¶/ç®¡ç†å‘˜ï¼‰

---

### é˜¶æ®µ2: ç”¨æˆ·ç®¡ç† (2-3å¤©)

#### 2.1 ç”¨æˆ·CRUD
- [ ] GET /api/users - åˆ—å‡ºç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
- [ ] GET /api/users/<id> - è·å–ç”¨æˆ·è¯¦æƒ…
- [ ] PUT /api/users/<id> - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- [ ] DELETE /api/users/<id> - åˆ é™¤ç”¨æˆ·
- [ ] PUT /api/users/<id>/status - ä¿®æ”¹ç”¨æˆ·çŠ¶æ€

#### 2.2 ç”¨æˆ·å­˜å‚¨
- [ ] ç”¨æˆ·æ•°æ®å­˜å‚¨ï¼ˆsledæˆ–PostgreSQLï¼‰
- [ ] ç´¢å¼•ï¼šusername, email
- [ ] æ•°æ®è¿ç§»æ”¯æŒ

---

### é˜¶æ®µ3: æƒé™ç³»ç»Ÿ (3-4å¤©)

#### 3.1 RBAC æƒé™æ¨¡å‹
```rust
pub struct Permission {
    pub resource: String,     // files, versions, search, etc.
    pub action: Action,       // read, write, delete, admin
}

pub enum Action {
    Read,
    Write,
    Delete,
    Admin,
}

pub struct Role {
    pub name: String,
    pub permissions: Vec<Permission>,
}
```

#### 3.2 æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- [ ] åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
- [ ] é›†æˆåˆ°ç°æœ‰ HTTP ç«¯ç‚¹
- [ ] æ”¯æŒèµ„æºçº§æƒé™æ£€æŸ¥

#### 3.3 é¢„å®šä¹‰è§’è‰²
- [ ] **Admin**: å®Œå…¨æ§åˆ¶æƒé™
- [ ] **User**: æ­£å¸¸ç”¨æˆ·æƒé™ï¼ˆè¯»å†™è‡ªå·±çš„æ–‡ä»¶ï¼‰
- [ ] **ReadOnly**: åªè¯»æƒé™

#### 3.4 ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰
- [ ] æ–‡ä»¶çº§åˆ«çš„ACL
- [ ] å…±äº«æƒé™ç®¡ç†
- [ ] ç»§æ‰¿çˆ¶ç›®å½•æƒé™

---

### é˜¶æ®µ4: é…é¢ç®¡ç† (2-3å¤©)

#### 4.1 é…é¢ç³»ç»Ÿ
```rust
pub struct UserQuota {
    pub user_id: String,
    pub max_storage: u64,      // å­—èŠ‚
    pub used_storage: u64,     // å­—èŠ‚
    pub max_files: Option<usize>,
    pub max_versions: Option<usize>,
}
```

#### 4.2 é…é¢æ£€æŸ¥
- [ ] ä¸Šä¼ æ—¶æ£€æŸ¥å­˜å‚¨é…é¢
- [ ] æ–‡ä»¶æ•°é‡é™åˆ¶
- [ ] ç‰ˆæœ¬æ•°é‡é™åˆ¶
- [ ] é…é¢ä½¿ç”¨ç»Ÿè®¡

#### 4.3 é…é¢ç®¡ç† API
- [ ] GET /api/quotas/<user_id> - è·å–é…é¢ä¿¡æ¯
- [ ] PUT /api/quotas/<user_id> - æ›´æ–°é…é¢ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] GET /api/quotas/<user_id>/usage - é…é¢ä½¿ç”¨è¯¦æƒ…

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### ä¾èµ–åº“
```toml
[dependencies]
# JWT
jsonwebtoken = "9.3"

# å¯†ç å“ˆå¸Œ
argon2 = "0.5"

# æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
sqlx = { version = "0.7", features = ["runtime-tokio-rustls", "postgres"], optional = true }

# æˆ–ç»§ç»­ä½¿ç”¨ sled
sled = "0.34"

# éªŒè¯
validator = { version = "0.16", features = ["derive"] }

# é‚®ä»¶ï¼ˆå¯†ç é‡ç½®ï¼‰
lettre = "0.11"
```

### æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

#### æ–¹æ¡ˆA: Sledï¼ˆæ¨è - å¿«é€Ÿå®ç°ï¼‰
- ä¼˜åŠ¿ï¼šæ— å¤–éƒ¨ä¾èµ–ã€ç®€å•å¿«é€Ÿ
- åŠ£åŠ¿ï¼šä¸é€‚åˆè¶…å¤§è§„æ¨¡éƒ¨ç½²

#### æ–¹æ¡ˆB: PostgreSQLï¼ˆæ¨è - ä¼ä¸šçº§ï¼‰
- ä¼˜åŠ¿ï¼šæˆç†Ÿç¨³å®šã€æ”¯æŒå¤æ‚æŸ¥è¯¢
- åŠ£åŠ¿ï¼šéœ€è¦å¤–éƒ¨æ•°æ®åº“

#### æ–¹æ¡ˆC: æ··åˆæ–¹æ¡ˆ
- ç”¨æˆ·æ•°æ®ï¼šPostgreSQL
- Tokené»‘åå•ï¼šRedis/Sledï¼ˆå†…å­˜ï¼‰

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id VARCHAR(27) PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

### æƒé™è¡¨ (permissions)
```sql
CREATE TABLE permissions (
    id VARCHAR(27) PRIMARY KEY,
    user_id VARCHAR(27) REFERENCES users(id),
    resource VARCHAR(100) NOT NULL,
    action VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    UNIQUE(user_id, resource, action)
);

CREATE INDEX idx_permissions_user ON permissions(user_id);
```

### é…é¢è¡¨ (quotas)
```sql
CREATE TABLE quotas (
    user_id VARCHAR(27) PRIMARY KEY REFERENCES users(id),
    max_storage BIGINT NOT NULL,
    used_storage BIGINT NOT NULL DEFAULT 0,
    max_files INTEGER,
    max_versions INTEGER,
    updated_at TIMESTAMP NOT NULL
);
```

### Tokené»‘åå• (token_blacklist)
```sql
CREATE TABLE token_blacklist (
    jti VARCHAR(255) PRIMARY KEY,
    expires_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_token_expires ON token_blacklist(expires_at);
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. å¯†ç å®‰å…¨
- âœ… ä½¿ç”¨ Argon2 å“ˆå¸Œç®—æ³•
- âœ… å¯†ç æœ€å°é•¿åº¦: 8å­—ç¬¦
- âœ… è¦æ±‚åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
- âœ… é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰

### 2. Token å®‰å…¨
- âœ… JWTç­¾åå¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡
- âœ… Tokenè¿‡æœŸæ—¶é—´: 1å°æ—¶
- âœ… Refresh Tokenè¿‡æœŸæ—¶é—´: 7å¤©
- âœ… Tokené»‘åå•æœºåˆ¶

### 3. API å®‰å…¨
- âœ… æ‰€æœ‰æ•æ„Ÿç«¯ç‚¹éœ€è¦è®¤è¯
- âœ… HTTPS ä¼ è¾“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… CORS é…ç½®
- âœ… Rate Limiting

### 4. å®¡è®¡æ—¥å¿—
- âœ… è®°å½•æ‰€æœ‰è®¤è¯æ“ä½œ
- âœ… è®°å½•æƒé™æ£€æŸ¥å¤±è´¥
- âœ… è®°å½•é…é¢è¶…é™å°è¯•

---

## ğŸ“ API è®¾è®¡

### è®¤è¯ç«¯ç‚¹

#### POST /api/auth/register
```json
è¯·æ±‚:
{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecureP@ss123"
}

å“åº”:
{
  "user_id": "01HQWXYZ...",
  "username": "john_doe",
  "email": "john@example.com",
  "role": "User",
  "created_at": "2025-10-17T20:00:00+08:00"
}
```

#### POST /api/auth/login
```json
è¯·æ±‚:
{
  "username": "john_doe",
  "password": "SecureP@ss123"
}

å“åº”:
{
  "access_token": "eyJhbGc...",
  "refresh_token": "eyJhbGc...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "01HQWXYZ...",
    "username": "john_doe",
    "role": "User"
  }
}
```

#### GET /api/auth/me
```json
Headers:
Authorization: Bearer eyJhbGc...

å“åº”:
{
  "id": "01HQWXYZ...",
  "username": "john_doe",
  "email": "john@example.com",
  "role": "User",
  "status": "Active",
  "quota": {
    "max_storage": 10737418240,
    "used_storage": 1073741824,
    "remaining": 9663676416
  }
}
```

---

## âœ… æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] å¯†ç å“ˆå¸Œå’ŒéªŒè¯
- [ ] JWT Token ç”Ÿæˆå’ŒéªŒè¯
- [ ] æƒé™æ£€æŸ¥é€»è¾‘
- [ ] é…é¢è®¡ç®—å’Œæ£€æŸ¥

### é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·æ³¨å†Œæµç¨‹
- [ ] ç™»å½•/ç™»å‡ºæµç¨‹
- [ ] Token åˆ·æ–°æµç¨‹
- [ ] æƒé™éªŒè¯æµç¨‹
- [ ] é…é¢é™åˆ¶æµ‹è¯•

### ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å®Œæ•´çš„ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ
- [ ] å¤šç”¨æˆ·åä½œåœºæ™¯
- [ ] æƒé™è¾¹ç•Œæµ‹è¯•

---

## ğŸ“ˆ å®æ–½æ­¥éª¤

### Week 1
**Day 1-2**: åŸºç¡€è®¾æ–½
- [ ] åˆ›å»º `feat/authentication-enhancement` åˆ†æ”¯
- [ ] è®¾ç½®æ•°æ®åº“ï¼ˆSledæˆ–PostgreSQLï¼‰
- [ ] ç”¨æˆ·æ¨¡å‹å’Œå­˜å‚¨å±‚

**Day 3-4**: JWT è®¤è¯
- [ ] JWT ç”Ÿæˆå’ŒéªŒè¯
- [ ] æ³¨å†Œ/ç™»å½•ç«¯ç‚¹
- [ ] Token åˆ·æ–°æœºåˆ¶

**Day 5**: ä¸­é—´ä»¶é›†æˆ
- [ ] è®¤è¯ä¸­é—´ä»¶
- [ ] é›†æˆåˆ°ç°æœ‰ç«¯ç‚¹
- [ ] åŸºç¡€æµ‹è¯•

### Week 2
**Day 6-7**: æƒé™ç³»ç»Ÿ
- [ ] RBAC æ¨¡å‹å®ç°
- [ ] æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- [ ] ACL å®ç°

**Day 8-9**: é…é¢ç®¡ç†
- [ ] é…é¢ç³»ç»Ÿå®ç°
- [ ] é…é¢æ£€æŸ¥é›†æˆ
- [ ] é…é¢ç®¡ç† API

**Day 10**: æµ‹è¯•å’Œæ–‡æ¡£
- [ ] å®Œå–„æµ‹è¯•è¦†ç›–
- [ ] ç¼–å†™ API æ–‡æ¡£
- [ ] ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ”„ è¿ç§»è®¡åˆ’

### ç°æœ‰æ•°æ®è¿ç§»
1. åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
2. å°†ç°æœ‰æ–‡ä»¶å…³è”åˆ°é»˜è®¤ç”¨æˆ·
3. è®¾ç½®é»˜è®¤é…é¢
4. å¯é€‰ï¼šæ‰¹é‡å¯¼å…¥ç”¨æˆ·

### å‘åå…¼å®¹
- æä¾›"æ— è®¤è¯æ¨¡å¼"é…ç½®é€‰é¡¹
- æ¸è¿›å¼å¯ç”¨è®¤è¯åŠŸèƒ½
- è¿ç§»å·¥å…·å’Œè„šæœ¬

---

## ğŸ“š ç›¸å…³èµ„æº

- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Argon2 Password Hashing](https://github.com/P-H-C/phc-winner-argon2)
- [RBAC Design Patterns](https://csrc.nist.gov/projects/role-based-access-control)

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

- [ ] æ‰€æœ‰è®¤è¯ç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- [ ] æƒé™ç³»ç»Ÿæ­£ç¡®é˜»æ­¢æœªæˆæƒè®¿é—®
- [ ] é…é¢é™åˆ¶æœ‰æ•ˆ
- [ ] 100+ ä¸ªæµ‹è¯•é€šè¿‡
- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] å®‰å…¨å®¡æŸ¥é€šè¿‡

---

**é¢„è®¡å®Œæˆæ—¶é—´**: 2å‘¨
**ä¸‹æ¬¡å®¡æŸ¥**: æ¯3å¤©
**è”ç³»äºº**: å¼€å‘å›¢é˜Ÿ
