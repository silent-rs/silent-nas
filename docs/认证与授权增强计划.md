# 认证与授权增强开发计划

> 分支: feat/authentication-enhancement
> 优先级: 🔴 最高
> 预计时间: 2周
> 开始日期: 2025-10-17

---

## 📋 目标

实现完整的多用户认证和权限管理系统，为Silent-NAS提供企业级的安全保障。

---

## 🎯 功能需求

### 阶段1: JWT Token 认证 (3-4天)

#### 1.1 用户模型
```rust
pub struct User {
    pub id: String,
    pub username: String,
    pub email: String,
    pub password_hash: String,
    pub role: UserRole,
    pub status: UserStatus,
    pub created_at: DateTime<Local>,
    pub updated_at: DateTime<Local>,
}

pub enum UserRole {
    Admin,
    User,
    ReadOnly,
}

pub enum UserStatus {
    Active,
    Suspended,
    Deleted,
}
```

#### 1.2 JWT 实现
- [ ] JWT Token 生成和验证
- [ ] Token 刷新机制
- [ ] Token 黑名单（用于登出）
- [ ] 配置 Token 过期时间

#### 1.3 认证端点
- [ ] POST /api/auth/register - 用户注册
- [ ] POST /api/auth/login - 用户登录
- [ ] POST /api/auth/logout - 用户登出
- [ ] POST /api/auth/refresh - 刷新Token
- [ ] GET /api/auth/me - 获取当前用户信息
- [ ] PUT /api/auth/password - 修改密码

#### 1.4 密码安全
- [ ] 使用 argon2 或 bcrypt 进行密码哈希
- [ ] 密码强度验证
- [ ] 密码重置功能（邮件/管理员）

---

### 阶段2: 用户管理 (2-3天)

#### 2.1 用户CRUD
- [ ] GET /api/users - 列出用户（仅管理员）
- [ ] GET /api/users/<id> - 获取用户详情
- [ ] PUT /api/users/<id> - 更新用户信息
- [ ] DELETE /api/users/<id> - 删除用户
- [ ] PUT /api/users/<id>/status - 修改用户状态

#### 2.2 用户存储
- [ ] 用户数据存储（sled或PostgreSQL）
- [ ] 索引：username, email
- [ ] 数据迁移支持

---

### 阶段3: 权限系统 (3-4天)

#### 3.1 RBAC 权限模型
```rust
pub struct Permission {
    pub resource: String,     // files, versions, search, etc.
    pub action: Action,       // read, write, delete, admin
}

pub enum Action {
    Read,
    Write,
    Delete,
    Admin,
}

pub struct Role {
    pub name: String,
    pub permissions: Vec<Permission>,
}
```

#### 3.2 权限检查中间件
- [ ] 创建权限验证中间件
- [ ] 集成到现有 HTTP 端点
- [ ] 支持资源级权限检查

#### 3.3 预定义角色
- [ ] **Admin**: 完全控制权限
- [ ] **User**: 正常用户权限（读写自己的文件）
- [ ] **ReadOnly**: 只读权限

#### 3.4 ACL（访问控制列表）
- [ ] 文件级别的ACL
- [ ] 共享权限管理
- [ ] 继承父目录权限

---

### 阶段4: 配额管理 (2-3天)

#### 4.1 配额系统
```rust
pub struct UserQuota {
    pub user_id: String,
    pub max_storage: u64,      // 字节
    pub used_storage: u64,     // 字节
    pub max_files: Option<usize>,
    pub max_versions: Option<usize>,
}
```

#### 4.2 配额检查
- [ ] 上传时检查存储配额
- [ ] 文件数量限制
- [ ] 版本数量限制
- [ ] 配额使用统计

#### 4.3 配额管理 API
- [ ] GET /api/quotas/<user_id> - 获取配额信息
- [ ] PUT /api/quotas/<user_id> - 更新配额（管理员）
- [ ] GET /api/quotas/<user_id>/usage - 配额使用详情

---

## 🔧 技术方案

### 依赖库
```toml
[dependencies]
# JWT
jsonwebtoken = "9.3"

# 密码哈希
argon2 = "0.5"

# 数据库（可选）
sqlx = { version = "0.7", features = ["runtime-tokio-rustls", "postgres"], optional = true }

# 或继续使用 sled
sled = "0.34"

# 验证
validator = { version = "0.16", features = ["derive"] }

# 邮件（密码重置）
lettre = "0.11"
```

### 数据存储方案

#### 方案A: Sled（推荐 - 快速实现）
- 优势：无外部依赖、简单快速
- 劣势：不适合超大规模部署

#### 方案B: PostgreSQL（推荐 - 企业级）
- 优势：成熟稳定、支持复杂查询
- 劣势：需要外部数据库

#### 方案C: 混合方案
- 用户数据：PostgreSQL
- Token黑名单：Redis/Sled（内存）

---

## 📊 数据库设计

### 用户表 (users)
```sql
CREATE TABLE users (
    id VARCHAR(27) PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

### 权限表 (permissions)
```sql
CREATE TABLE permissions (
    id VARCHAR(27) PRIMARY KEY,
    user_id VARCHAR(27) REFERENCES users(id),
    resource VARCHAR(100) NOT NULL,
    action VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    UNIQUE(user_id, resource, action)
);

CREATE INDEX idx_permissions_user ON permissions(user_id);
```

### 配额表 (quotas)
```sql
CREATE TABLE quotas (
    user_id VARCHAR(27) PRIMARY KEY REFERENCES users(id),
    max_storage BIGINT NOT NULL,
    used_storage BIGINT NOT NULL DEFAULT 0,
    max_files INTEGER,
    max_versions INTEGER,
    updated_at TIMESTAMP NOT NULL
);
```

### Token黑名单 (token_blacklist)
```sql
CREATE TABLE token_blacklist (
    jti VARCHAR(255) PRIMARY KEY,
    expires_at TIMESTAMP NOT NULL
);

CREATE INDEX idx_token_expires ON token_blacklist(expires_at);
```

---

## 🔐 安全考虑

### 1. 密码安全
- ✅ 使用 Argon2 哈希算法
- ✅ 密码最小长度: 8字符
- ✅ 要求包含大小写字母、数字和特殊字符
- ✅ 限制登录尝试次数（防暴力破解）

### 2. Token 安全
- ✅ JWT签名密钥存储在环境变量
- ✅ Token过期时间: 1小时
- ✅ Refresh Token过期时间: 7天
- ✅ Token黑名单机制

### 3. API 安全
- ✅ 所有敏感端点需要认证
- ✅ HTTPS 传输（生产环境）
- ✅ CORS 配置
- ✅ Rate Limiting

### 4. 审计日志
- ✅ 记录所有认证操作
- ✅ 记录权限检查失败
- ✅ 记录配额超限尝试

---

## 📝 API 设计

### 认证端点

#### POST /api/auth/register
```json
请求:
{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecureP@ss123"
}

响应:
{
  "user_id": "01HQWXYZ...",
  "username": "john_doe",
  "email": "john@example.com",
  "role": "User",
  "created_at": "2025-10-17T20:00:00+08:00"
}
```

#### POST /api/auth/login
```json
请求:
{
  "username": "john_doe",
  "password": "SecureP@ss123"
}

响应:
{
  "access_token": "eyJhbGc...",
  "refresh_token": "eyJhbGc...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "01HQWXYZ...",
    "username": "john_doe",
    "role": "User"
  }
}
```

#### GET /api/auth/me
```json
Headers:
Authorization: Bearer eyJhbGc...

响应:
{
  "id": "01HQWXYZ...",
  "username": "john_doe",
  "email": "john@example.com",
  "role": "User",
  "status": "Active",
  "quota": {
    "max_storage": 10737418240,
    "used_storage": 1073741824,
    "remaining": 9663676416
  }
}
```

---

## ✅ 测试计划

### 单元测试
- [ ] 密码哈希和验证
- [ ] JWT Token 生成和验证
- [ ] 权限检查逻辑
- [ ] 配额计算和检查

### 集成测试
- [ ] 用户注册流程
- [ ] 登录/登出流程
- [ ] Token 刷新流程
- [ ] 权限验证流程
- [ ] 配额限制测试

### 端到端测试
- [ ] 完整的用户生命周期
- [ ] 多用户协作场景
- [ ] 权限边界测试

---

## 📈 实施步骤

### Week 1
**Day 1-2**: 基础设施
- [ ] 创建 `feat/authentication-enhancement` 分支
- [ ] 设置数据库（Sled或PostgreSQL）
- [ ] 用户模型和存储层

**Day 3-4**: JWT 认证
- [ ] JWT 生成和验证
- [ ] 注册/登录端点
- [ ] Token 刷新机制

**Day 5**: 中间件集成
- [ ] 认证中间件
- [ ] 集成到现有端点
- [ ] 基础测试

### Week 2
**Day 6-7**: 权限系统
- [ ] RBAC 模型实现
- [ ] 权限检查中间件
- [ ] ACL 实现

**Day 8-9**: 配额管理
- [ ] 配额系统实现
- [ ] 配额检查集成
- [ ] 配额管理 API

**Day 10**: 测试和文档
- [ ] 完善测试覆盖
- [ ] 编写 API 文档
- [ ] 使用示例

---

## 🔄 迁移计划

### 现有数据迁移
1. 创建默认管理员账户
2. 将现有文件关联到默认用户
3. 设置默认配额
4. 可选：批量导入用户

### 向后兼容
- 提供"无认证模式"配置选项
- 渐进式启用认证功能
- 迁移工具和脚本

---

## 📚 相关资源

- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Argon2 Password Hashing](https://github.com/P-H-C/phc-winner-argon2)
- [RBAC Design Patterns](https://csrc.nist.gov/projects/role-based-access-control)

---

## 🎯 成功标准

- [ ] 所有认证端点正常工作
- [ ] 权限系统正确阻止未授权访问
- [ ] 配额限制有效
- [ ] 100+ 个测试通过
- [ ] API 文档完整
- [ ] 安全审查通过

---

**预计完成时间**: 2周
**下次审查**: 每3天
**联系人**: 开发团队
