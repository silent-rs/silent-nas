# 认证功能使用指南

## 概述

Silent NAS 提供了完整的 JWT 认证功能，支持用户注册、登录、密码管理等核心功能。认证功能是可选的，可通过环境变量启用。

## 功能特性

- ✅ JWT Token 认证（访问令牌1小时，刷新令牌7天）
- ✅ Argon2 密码哈希（行业标准安全算法）
- ✅ 用户角色系统（Admin/User/ReadOnly）
- ✅ 用户状态管理（Active/Suspended/Deleted）
- ✅ Sled 嵌入式数据库存储
- ✅ 密码强度验证
- ✅ 自动初始化默认管理员

## 启用认证功能

### 1. 环境变量配置

```bash
# 启用认证功能
export ENABLE_AUTH=1

# 配置数据库路径（可选，默认为 ./data/auth.db）
export AUTH_DB_PATH=./data/auth.db

# JWT密钥（可选，默认自动生成）
export JWT_SECRET=your-secret-key-here
```

### 2. 启动服务器

```bash
# 启动服务器，认证功能将自动启用
cargo run
```

### 3. 默认管理员账户

首次启动时，系统会自动创建默认管理员账户：

- **用户名**: `admin`
- **密码**: `Admin123!@#`
- **角色**: Admin

⚠️ **重要**: 请在首次登录后立即修改默认密码！

## API 端点

### 1. 用户注册

**POST** `/api/auth/register`

注册新用户账户。

**请求体**:
```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "SecurePass123!",
  "display_name": "Test User"
}
```

**响应** (201 Created):
```json
{
  "id": "01JABCD1234567890ABCDEFGH",
  "username": "testuser",
  "email": "test@example.com",
  "display_name": "Test User",
  "role": "User",
  "status": "Active",
  "created_at": 1697529600
}
```

**密码要求**:
- 最少8个字符
- 至少包含1个大写字母
- 至少包含1个小写字母
- 至少包含1个数字
- 可以包含特殊字符（推荐）

### 2. 用户登录

**POST** `/api/auth/login`

使用用户名和密码登录。

**请求体**:
```json
{
  "username": "testuser",
  "password": "SecurePass123!"
}
```

**响应** (200 OK):
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "01JABCD1234567890ABCDEFGH",
    "username": "testuser",
    "email": "test@example.com",
    "display_name": "Test User",
    "role": "User",
    "status": "Active",
    "created_at": 1697529600
  }
}
```

### 3. 刷新Token

**POST** `/api/auth/refresh`

使用刷新令牌获取新的访问令牌。

**请求体**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**响应** (200 OK):
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "01JABCD1234567890ABCDEFGH",
    "username": "testuser",
    "email": "test@example.com",
    "display_name": "Test User",
    "role": "User",
    "status": "Active",
    "created_at": 1697529600
  }
}
```

### 4. 获取当前用户信息

**GET** `/api/auth/me`

获取当前登录用户的信息。需要认证。

**请求头**:
```
Authorization: Bearer <access_token>
```

**响应** (200 OK):
```json
{
  "id": "01JABCD1234567890ABCDEFGH",
  "username": "testuser",
  "email": "test@example.com",
  "display_name": "Test User",
  "role": "User",
  "status": "Active",
  "created_at": 1697529600
}
```

### 5. 修改密码

**PUT** `/api/auth/password`

修改当前用户的密码。需要认证。

**请求头**:
```
Authorization: Bearer <access_token>
```

**请求体**:
```json
{
  "old_password": "SecurePass123!",
  "new_password": "NewSecurePass456!"
}
```

**响应** (200 OK):
```json
{
  "message": "密码修改成功"
}
```

## 使用示例

### cURL 示例

#### 1. 注册用户

```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "SecurePass123!",
    "display_name": "Test User"
  }'
```

#### 2. 登录

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "SecurePass123!"
  }'
```

#### 3. 获取用户信息

```bash
curl -X GET http://localhost:8080/api/auth/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

#### 4. 修改密码

```bash
curl -X PUT http://localhost:8080/api/auth/password \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "SecurePass123!",
    "new_password": "NewSecurePass456!"
  }'
```

#### 5. 刷新Token

```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "YOUR_REFRESH_TOKEN"
  }'
```

### Python 示例

```python
import requests

BASE_URL = "http://localhost:8080/api/auth"

# 1. 注册
response = requests.post(f"{BASE_URL}/register", json={
    "username": "testuser",
    "email": "test@example.com",
    "password": "SecurePass123!",
    "display_name": "Test User"
})
print("注册:", response.json())

# 2. 登录
response = requests.post(f"{BASE_URL}/login", json={
    "username": "testuser",
    "password": "SecurePass123!"
})
data = response.json()
access_token = data["access_token"]
print("登录成功，Token:", access_token[:50] + "...")

# 3. 获取用户信息
headers = {"Authorization": f"Bearer {access_token}"}
response = requests.get(f"{BASE_URL}/me", headers=headers)
print("用户信息:", response.json())

# 4. 修改密码
response = requests.put(f"{BASE_URL}/password",
    headers=headers,
    json={
        "old_password": "SecurePass123!",
        "new_password": "NewSecurePass456!"
    }
)
print("密码修改:", response.json())

# 5. 刷新Token
response = requests.post(f"{BASE_URL}/refresh", json={
    "refresh_token": data["refresh_token"]
})
print("Token刷新:", response.json())
```

### JavaScript (Node.js) 示例

```javascript
const axios = require('axios');

const BASE_URL = 'http://localhost:8080/api/auth';

async function testAuth() {
  try {
    // 1. 注册
    const registerRes = await axios.post(`${BASE_URL}/register`, {
      username: 'testuser',
      email: 'test@example.com',
      password: 'SecurePass123!',
      display_name: 'Test User'
    });
    console.log('注册:', registerRes.data);

    // 2. 登录
    const loginRes = await axios.post(`${BASE_URL}/login`, {
      username: 'testuser',
      password: 'SecurePass123!'
    });
    const { access_token, refresh_token } = loginRes.data;
    console.log('登录成功');

    // 3. 获取用户信息
    const meRes = await axios.get(`${BASE_URL}/me`, {
      headers: { Authorization: `Bearer ${access_token}` }
    });
    console.log('用户信息:', meRes.data);

    // 4. 修改密码
    const passwordRes = await axios.put(`${BASE_URL}/password`, {
      old_password: 'SecurePass123!',
      new_password: 'NewSecurePass456!'
    }, {
      headers: { Authorization: `Bearer ${access_token}` }
    });
    console.log('密码修改:', passwordRes.data);

    // 5. 刷新Token
    const refreshRes = await axios.post(`${BASE_URL}/refresh`, {
      refresh_token: refresh_token
    });
    console.log('Token刷新成功');

  } catch (error) {
    console.error('错误:', error.response?.data || error.message);
  }
}

testAuth();
```

## 错误处理

### 常见错误代码

| 状态码 | 说明 | 解决方法 |
|-------|------|---------|
| 400 | 请求格式错误 | 检查请求体格式和必填字段 |
| 401 | 未授权 | 提供有效的 Bearer Token |
| 403 | 权限不足 | 确认用户角色权限 |
| 409 | 冲突（如用户名已存在） | 更换用户名或邮箱 |
| 503 | 认证服务未启用 | 设置 ENABLE_AUTH 环境变量 |

### 错误响应格式

```json
{
  "error": "错误描述信息"
}
```

## 安全建议

### 1. 密码安全

- ✅ 使用强密码（至少8字符，包含大小写字母和数字）
- ✅ 定期更换密码
- ✅ 不要在多个服务使用相同密码
- ✅ 立即修改默认管理员密码

### 2. Token 管理

- ✅ 安全存储访问令牌（不要在代码中硬编码）
- ✅ 使用 HTTPS 传输（生产环境必须）
- ✅ Token 过期后使用刷新令牌获取新令牌
- ✅ 退出登录时清除本地存储的 Token

### 3. 环境配置

- ✅ 使用强随机JWT_SECRET（生产环境必须）
- ✅ 定期备份认证数据库
- ✅ 限制管理员账户数量
- ✅ 启用审计日志（ENABLE_AUDIT=1）

## 数据库管理

### 数据库位置

默认路径：`./data/auth.db`

可通过环境变量配置：
```bash
export AUTH_DB_PATH=/path/to/your/auth.db
```

### 备份数据库

```bash
# 停止服务器
# 复制数据库文件
cp ./data/auth.db ./data/auth.db.backup

# 或使用 Sled 导出（需要实现）
```

### 重置管理员密码

如果忘记管理员密码，可以删除数据库文件重新初始化：

```bash
rm -rf ./data/auth.db
# 重启服务器，将自动创建新的默认管理员
```

## 高级配置

### 自定义 JWT 配置

在代码中修改 `src/auth/jwt.rs`：

```rust
impl JwtConfig {
    pub fn new(secret: String) -> Self {
        Self {
            secret,
            access_token_exp: 7200,    // 2小时
            refresh_token_exp: 1209600, // 14天
        }
    }
}
```

### 自定义密码策略

在代码中修改 `src/auth/password.rs`：

```rust
impl PasswordHandler {
    pub fn validate_password_strength(password: &str) -> PasswordStrength {
        // 修改密码强度验证逻辑
    }
}
```

## 故障排查

### 问题：认证功能未启用

**错误信息**: "认证功能未启用"

**解决方案**:
```bash
export ENABLE_AUTH=1
```

### 问题：Token 验证失败

**可能原因**:
1. Token 已过期
2. JWT_SECRET 不匹配
3. Token 格式错误

**解决方案**:
1. 使用刷新令牌获取新的访问令牌
2. 确保服务器重启后 JWT_SECRET 保持一致
3. 检查 Authorization 头格式：`Bearer <token>`

### 问题：密码强度不足

**错误信息**: "密码强度不足"

**解决方案**:
确保密码满足以下要求：
- 至少8个字符
- 包含大写字母
- 包含小写字母
- 包含数字
- （推荐）包含特殊字符

## 性能优化

### 1. Token 缓存

考虑在内存中缓存已验证的 Token，减少数据库查询：

```rust
// 使用 moka 或 dashmap 实现 Token 缓存
```

### 2. 密码哈希并行化

Argon2 已经使用了并行化，无需额外优化。

### 3. 数据库索引

Sled 自动为键建立索引，用户名和邮箱查询已优化。

## 下一步计划

- [ ] OAuth2 第三方登录集成
- [ ] 双因素认证（2FA）
- [ ] 会话管理和在线用户统计
- [ ] IP 白名单/黑名单
- [ ] 登录失败锁定机制
- [ ] 密码重置功能（邮件）
- [ ] 用户权限细粒度控制

## 相关文档

- [Silent Framework 文档](https://github.com/silent-rs/silent)
- [JWT 标准](https://jwt.io/)
- [Argon2 规范](https://github.com/P-H-C/phc-winner-argon2)
- [OWASP 认证指南](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

## 技术支持

如有问题，请提交 Issue 到项目仓库。
