# Silent NAS 认证功能文档

## 目录

- [快速开始](#快速开始)
- [用户管理](#用户管理)
- [API 使用指南](#api-使用指南)
- [安全配置](#安全配置)
- [故障排查](#故障排查)
- [技术实现](#技术实现)

---

## 快速开始

### 1. 启用认证功能

设置环境变量启用认证：

```bash
export ENABLE_AUTH=1
export AUTH_DB_PATH=./data/auth.db  # 可选
export JWT_SECRET=your-secret-key    # 可选，建议生产环境设置
```

启动服务器：

```bash
cargo run
```

### 2. 首次登录

系统自动创建的默认管理员：

- **用户名**: `admin`
- **密码**: `Admin123!@#`
- **角色**: Admin

**重要**: 首次登录后立即修改密码！

### 3. 快速测试

登录示例：

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin123!@#"}'
```

---

## 用户管理

### 管理员操作

#### 1. 修改管理员密码

首次登录后，立即修改默认密码：

```bash
# 1. 先登录获取 Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin123!@#"}' \
  | jq -r '.access_token')

# 2. 修改密码
curl -X PUT http://localhost:8080/api/auth/password \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "Admin123!@#",
    "new_password": "YourNewSecurePassword!123"
  }'
```

#### 2. 创建新管理员账户

通过代码创建额外的管理员（需要修改代码）：

```rust
// 在需要的地方添加此代码
use crate::auth::{AuthManager, RegisterRequest, UserRole};

let auth_manager = AuthManager::new("./data/auth.db")?;

let admin_req = RegisterRequest {
    username: "admin2".to_string(),
    email: "admin2@example.com".to_string(),
    password: "SecurePass123!".to_string(),
    display_name: Some("Admin User 2".to_string()),
};

// 注册用户
let mut user = auth_manager.register(admin_req)?;

// 提升为管理员
user.role = UserRole::Admin;
auth_manager.storage.update_user(&user)?;
```

或通过数据库直接修改（高级用户）：

```bash
# 使用 sled 工具查看和修改用户
# 注意：需要先停止服务器

# 安装 sled 工具（如果有的话）
# 或者编写脚本读取数据库
```

#### 3. 创建普通用户

```bash
# 使用 Token 注册新用户
TOKEN="your-admin-token"

curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user1",
    "email": "user1@example.com",
    "password": "SecurePass123!",
    "display_name": "Regular User"
  }'
```

**注意**: 当前版本所有用户都可以注册。如果需要限制注册，需要在代码中添加管理员检查。

### 用户角色

| 角色 | 权限 | 说明 |
|------|------|------|
| **Admin** | 全部权限 | 系统管理员，可以管理所有用户和资源 |
| **User** | 标准权限 | 普通用户，可以管理自己的文件 |
| **ReadOnly** | 只读权限 | 只能查看，不能修改 |

### 用户状态

| 状态 | 说明 | 操作 |
|------|------|------|
| **Active** | 正常活跃 | 可以正常登录使用 |
| **Suspended** | 已暂停 | 暂时无法登录 |
| **Deleted** | 已删除 | 标记为删除，不可登录 |

---

## API 使用指南

### 端点概览

| 端点 | 方法 | 说明 | 需要认证 |
|------|------|------|----------|
| `/api/auth/register` | POST | 注册新用户 | ❌ |
| `/api/auth/login` | POST | 用户登录 | ❌ |
| `/api/auth/refresh` | POST | 刷新Token | ❌ |
| `/api/auth/me` | GET | 获取当前用户 | ✅ |
| `/api/auth/password` | PUT | 修改密码 | ✅ |

### 1. 用户注册

**请求**:

```bash
POST /api/auth/register
Content-Type: application/json

{
  "username": "newuser",
  "email": "user@example.com",
  "password": "SecurePass123!",
  "display_name": "New User"
}
```

**响应** (201 Created):

```json
{
  "id": "01JABCD1234567890ABCDEFGH",
  "username": "newuser",
  "email": "user@example.com",
  "display_name": "New User",
  "role": "User",
  "status": "Active",
  "created_at": 1697529600
}
```

**密码要求**:
- 最少 8 个字符
- 至少 1 个大写字母
- 至少 1 个小写字母
- 至少 1 个数字
- 建议包含特殊字符

### 2. 用户登录

**请求**:

```bash
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "Admin123!@#"
}
```

**响应** (200 OK):

```json
{
  "access_token": "eyJhbGci...",
  "refresh_token": "eyJhbGci...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": {
    "id": "01JABCD...",
    "username": "admin",
    "email": "admin@example.com",
    "display_name": "Administrator",
    "role": "Admin",
    "status": "Active",
    "created_at": 1697529600
  }
}
```

### 3. 刷新 Token

当访问令牌过期（1小时后），使用刷新令牌获取新的访问令牌。

**请求**:

```bash
POST /api/auth/refresh
Content-Type: application/json

{
  "refresh_token": "eyJhbGci..."
}
```

**响应** (200 OK):

```json
{
  "access_token": "eyJhbGci...",  // 新的访问令牌
  "refresh_token": "eyJhbGci...",  // 新的刷新令牌
  "token_type": "Bearer",
  "expires_in": 3600,
  "user": { ... }
}
```

**Token 生命周期**:
- **访问令牌**: 1 小时
- **刷新令牌**: 7 天

### 4. 获取当前用户信息

**请求**:

```bash
GET /api/auth/me
Authorization: Bearer eyJhbGci...
```

**响应** (200 OK):

```json
{
  "id": "01JABCD...",
  "username": "admin",
  "email": "admin@example.com",
  "display_name": "Administrator",
  "role": "Admin",
  "status": "Active",
  "created_at": 1697529600
}
```

### 5. 修改密码

**请求**:

```bash
PUT /api/auth/password
Authorization: Bearer eyJhbGci...
Content-Type: application/json

{
  "old_password": "OldPass123!",
  "new_password": "NewSecurePass456!"
}
```

**响应** (200 OK):

```json
{
  "message": "密码修改成功"
}
```

### 使用示例

#### cURL 完整流程

```bash
#!/bin/bash

# 1. 登录
LOGIN_RESP=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin123!@#"}')

# 提取 Token
ACCESS_TOKEN=$(echo $LOGIN_RESP | jq -r '.access_token')
REFRESH_TOKEN=$(echo $LOGIN_RESP | jq -r '.refresh_token')

echo "Access Token: $ACCESS_TOKEN"

# 2. 获取用户信息
curl -X GET http://localhost:8080/api/auth/me \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# 3. 修改密码
curl -X PUT http://localhost:8080/api/auth/password \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "Admin123!@#",
    "new_password": "NewSecure123!@#"
  }'

# 4. Token 过期后刷新
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d "{\"refresh_token\":\"$REFRESH_TOKEN\"}"
```

#### Python 示例

```python
import requests

BASE_URL = "http://localhost:8080/api/auth"

class AuthClient:
    def __init__(self, base_url):
        self.base_url = base_url
        self.access_token = None
        self.refresh_token = None

    def login(self, username, password):
        """用户登录"""
        response = requests.post(
            f"{self.base_url}/login",
            json={"username": username, "password": password}
        )
        response.raise_for_status()
        data = response.json()
        self.access_token = data["access_token"]
        self.refresh_token = data["refresh_token"]
        return data

    def get_user_info(self):
        """获取当前用户信息"""
        response = requests.get(
            f"{self.base_url}/me",
            headers={"Authorization": f"Bearer {self.access_token}"}
        )
        response.raise_for_status()
        return response.json()

    def change_password(self, old_password, new_password):
        """修改密码"""
        response = requests.put(
            f"{self.base_url}/password",
            headers={"Authorization": f"Bearer {self.access_token}"},
            json={
                "old_password": old_password,
                "new_password": new_password
            }
        )
        response.raise_for_status()
        return response.json()

    def refresh(self):
        """刷新 Token"""
        response = requests.post(
            f"{self.base_url}/refresh",
            json={"refresh_token": self.refresh_token}
        )
        response.raise_for_status()
        data = response.json()
        self.access_token = data["access_token"]
        self.refresh_token = data["refresh_token"]
        return data

# 使用示例
client = AuthClient(BASE_URL)

# 登录
login_data = client.login("admin", "Admin123!@#")
print(f"登录成功: {login_data['user']['username']}")

# 获取用户信息
user = client.get_user_info()
print(f"当前用户: {user}")

# 修改密码
result = client.change_password("Admin123!@#", "NewPassword123!")
print(f"密码修改: {result['message']}")

# 刷新 Token
client.refresh()
print("Token 已刷新")
```

---

## 安全配置

### 1. JWT 密钥设置

**生产环境必须设置**强随机密钥：

```bash
# 生成随机密钥（32字节）
export JWT_SECRET=$(openssl rand -base64 32)

# 或手动设置
export JWT_SECRET="your-very-strong-random-secret-key-here"
```

### 2. 数据库安全

```bash
# 设置数据库路径
export AUTH_DB_PATH=/secure/path/auth.db

# 限制文件权限
chmod 600 /secure/path/auth.db
chown app-user:app-group /secure/path/auth.db
```

### 3. HTTPS 配置

**生产环境必须使用 HTTPS**！

认证 Token 通过 HTTP 传输时容易被拦截。建议配置：

- 使用反向代理（Nginx/Caddy）启用 HTTPS
- 申请 SSL/TLS 证书（Let's Encrypt）
- 强制 HTTPS 重定向

Nginx 配置示例：

```nginx
server {
    listen 443 ssl http2;
    server_name nas.example.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. 密码策略

当前密码强度要求：

- **弱密码**: < 8字符或单一类型
- **中等密码**: 8-11字符，2种类型
- **强密码**: 12+字符，3种以上类型（推荐）

建议配置：

```bash
# 环境变量（如果支持）
export MIN_PASSWORD_LENGTH=12
export REQUIRE_SPECIAL_CHARS=true
```

### 5. 安全建议

| 建议 | 说明 |
|------|------|
| ✅ 立即修改默认密码 | admin 账户使用强密码 |
| ✅ 使用 HTTPS | 保护 Token 传输安全 |
| ✅ 定期轮换密钥 | JWT_SECRET 定期更换 |
| ✅ 限制登录尝试 | 防止暴力破解（待实现） |
| ✅ 审计日志 | 启用 ENABLE_AUDIT=1 |
| ✅ 备份数据库 | 定期备份 auth.db |

---

## 故障排查

### 常见问题

#### 1. 认证功能未启用

**错误**: "认证功能未启用"

**解决**:

```bash
export ENABLE_AUTH=1
# 重启服务器
```

#### 2. Token 验证失败

**错误**: "Invalid token" / "Token expired"

**原因**:
- Token 已过期（1小时）
- JWT_SECRET 不匹配（服务器重启后密钥改变）

**解决**:

```bash
# 1. 使用刷新令牌获取新 Token
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"YOUR_REFRESH_TOKEN"}'

# 2. 设置固定的 JWT_SECRET
export JWT_SECRET="fixed-secret-key"
```

#### 3. 密码强度不足

**错误**: "密码强度不足"

**要求**:
- 至少 8 个字符
- 包含大写字母
- 包含小写字母
- 包含数字
- 建议包含特殊字符

**示例强密码**:
- `SecurePass123!`
- `MyStr0ng@Password`
- `Admin#2024$Secure`

#### 4. 用户名已存在

**错误**: "用户名已存在"

**解决**: 使用不同的用户名

#### 5. 数据库锁定

**错误**: "Database locked"

**原因**: 多个进程同时访问数据库

**解决**:

```bash
# 停止所有实例
pkill silent-nas

# 重启单个实例
cargo run
```

#### 6. 忘记管理员密码

**解决方案**:

```bash
# 方法1: 删除数据库（丢失所有用户）
rm -rf ./data/auth.db
# 重启服务器，使用默认 admin/Admin123!@#

# 方法2: 通过代码重置密码（高级）
# 编写脚本直接修改数据库中的密码哈希
```

### 调试技巧

#### 启用详细日志

```bash
export RUST_LOG=debug
cargo run
```

#### 检查数据库状态

```bash
# 查看数据库文件
ls -lh ./data/auth.db

# 查看数据库大小
du -h ./data/auth.db
```

#### 测试 Token

```bash
# 使用 jwt.io 解码 Token
# 访问 https://jwt.io/ 粘贴 Token 查看内容
```

---

## 技术实现

### 架构概览

```
┌─────────────────────────────────────────────┐
│           HTTP API Handlers                 │
│  (register/login/refresh/me/password)       │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│          AuthManager (核心)                 │
│  - 用户注册/登录                            │
│  - Token 生成/验证                          │
│  - 密码管理                                 │
└─────┬─────────┬─────────┬───────────────────┘
      │         │         │
      ▼         ▼         ▼
┌──────────┐ ┌────────┐ ┌──────────────┐
│   JWT    │ │Password│ │UserStorage   │
│ Handler  │ │Handler │ │(Sled DB)     │
│          │ │(Argon2)│ │              │
└──────────┘ └────────┘ └──────────────┘
```

### 核心组件

| 组件 | 文件 | 说明 |
|------|------|------|
| **Models** | `auth/models.rs` | 数据模型和请求/响应 |
| **JWT** | `auth/jwt.rs` | Token 生成和验证 |
| **Password** | `auth/password.rs` | 密码哈希和验证 |
| **Storage** | `auth/storage.rs` | 用户持久化存储 |
| **Manager** | `auth/mod.rs` | 认证管理器 |
| **Handlers** | `http/auth_handlers.rs` | HTTP API 端点 |

### 数据存储

**Sled 数据库结构**:

```
auth.db/
├── users/           # 主用户表 (user_id -> User JSON)
├── username_index/  # 用户名索引 (username -> user_id)
└── email_index/     # 邮箱索引 (email -> user_id)
```

### 安全算法

- **密码哈希**: Argon2id（OWASP 推荐）
- **JWT 签名**: HS256
- **ID 生成**: SCRU128（时间排序 + 唯一）

### 性能指标

| 操作 | 平均耗时 |
|------|----------|
| 密码哈希 | ~100ms |
| 密码验证 | ~100ms |
| Token 生成 | <1ms |
| Token 验证 | <1ms |
| 数据库查询 | <1ms |

### 测试覆盖率

```
auth/jwt.rs:       94.19% ✅
auth/models.rs:    90.00% ✅
auth/password.rs:  93.47% ✅
auth/storage.rs:   81.09% ✅
auth/mod.rs:       73.13% ✅

总计: 52 个单元测试
```

---

## 最佳实践

### 开发环境

```bash
# 1. 快速启动（使用默认配置）
export ENABLE_AUTH=1
cargo run

# 2. 使用默认管理员登录
# admin / Admin123!@#

# 3. 立即修改密码
```

### 生产环境

```bash
# 1. 设置强密钥
export JWT_SECRET=$(openssl rand -base64 32)

# 2. 配置数据库路径
export AUTH_DB_PATH=/var/lib/silent-nas/auth.db

# 3. 启用审计日志
export ENABLE_AUDIT=1

# 4. 使用 HTTPS 反向代理
# 配置 Nginx/Caddy

# 5. 定期备份
cp /var/lib/silent-nas/auth.db /backup/auth.db.$(date +%Y%m%d)

# 6. 监控日志
tail -f /var/log/silent-nas/app.log
```

### 集成到应用

#### 保护 API 端点

```rust
// 示例：在现有端点添加认证
use crate::auth::AuthManager;
use silent::prelude::*;

pub async fn protected_endpoint(
    req: Request,
    CfgExtractor(state): CfgExtractor<AppState>,
) -> silent::Result<String> {
    // 1. 获取认证管理器
    let auth_manager = state.auth_manager.as_ref()
        .ok_or_else(|| SilentError::business_error(
            StatusCode::SERVICE_UNAVAILABLE,
            "认证功能未启用"
        ))?;

    // 2. 提取 Token
    let token = req.headers()
        .get("Authorization")
        .and_then(|v| v.to_str().ok())
        .and_then(|v| v.strip_prefix("Bearer "))
        .ok_or_else(|| SilentError::business_error(
            StatusCode::UNAUTHORIZED,
            "缺少认证 Token"
        ))?;

    // 3. 验证 Token
    let user = auth_manager.verify_token(token)
        .map_err(|_| SilentError::business_error(
            StatusCode::UNAUTHORIZED,
            "Token 无效"
        ))?;

    // 4. 检查权限（可选）
    if user.role != UserRole::Admin {
        return Err(SilentError::business_error(
            StatusCode::FORBIDDEN,
            "需要管理员权限"
        ));
    }

    // 5. 处理请求
    Ok(format!("Hello, {}!", user.username))
}
```

---

## 附录

### 环境变量参考

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `ENABLE_AUTH` | 启用认证功能 | - |
| `AUTH_DB_PATH` | 数据库路径 | `./data/auth.db` |
| `JWT_SECRET` | JWT 签名密钥 | 自动生成 |
| `ENABLE_AUDIT` | 启用审计日志 | - |

### 错误代码

| HTTP 状态码 | 说明 |
|------------|------|
| 200 | 成功 |
| 201 | 创建成功（注册） |
| 400 | 请求错误（格式、验证失败） |
| 401 | 未授权（Token 无效/过期） |
| 403 | 权限不足 |
| 409 | 冲突（用户名已存在） |
| 503 | 服务不可用（认证未启用） |

### 相关资源

- [Silent Framework](https://github.com/silent-rs/silent)
- [JWT 标准](https://jwt.io/)
- [Argon2](https://github.com/P-H-C/phc-winner-argon2)
- [OWASP 认证指南](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)

---

**版本**: v1.0.0
**更新日期**: 2025-10-17
**维护者**: Silent NAS Team
