# è·¨èŠ‚ç‚¹æ–‡ä»¶åŒæ­¥å®ç°æŠ¥å‘Š

> å®Œæˆæ—¶é—´: 2025-10-16
> ç‰ˆæœ¬: v0.1.0
> ä½œè€…: Silent-NAS Team

## ğŸ“‹ æ¦‚è¿°

æœ¬æŠ¥å‘Šæè¿°äº† Silent-NAS è·¨èŠ‚ç‚¹æ–‡ä»¶åŒæ­¥åŠŸèƒ½çš„è®¾è®¡ä¸å®ç°ã€‚è¯¥åŠŸèƒ½åŸºäºå·²æœ‰çš„ CRDT åŒæ­¥æ¨¡å—ï¼Œå®ç°äº†å¤šä¸ª NAS èŠ‚ç‚¹ä¹‹é—´çš„è‡ªåŠ¨æ–‡ä»¶åŒæ­¥ã€‚

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **èŠ‚ç‚¹å‘ç°ä¸æ³¨å†Œ** - è‡ªåŠ¨å‘ç°å’Œç®¡ç†ç½‘ç»œä¸­çš„èŠ‚ç‚¹
2. âœ… **èŠ‚ç‚¹å¿ƒè·³æ£€æµ‹** - ç›‘æ§èŠ‚ç‚¹å¥åº·çŠ¶æ€
3. âœ… **æ–‡ä»¶çŠ¶æ€åŒæ­¥** - è·¨èŠ‚ç‚¹åŒæ­¥æ–‡ä»¶å…ƒæ•°æ®å’ŒçŠ¶æ€
4. âœ… **è‡ªåŠ¨åŒæ­¥è°ƒåº¦** - å®šæœŸè‡ªåŠ¨åŒæ­¥æ–‡ä»¶
5. âœ… **åŒæ­¥ç»Ÿè®¡** - è·Ÿè¸ªåŒæ­¥è¿›åº¦å’ŒçŠ¶æ€

### æŠ€æœ¯ç‰¹æ€§
- åŸºäº gRPC çš„é«˜æ•ˆé€šä¿¡
- CRDT ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- å‘é‡æ—¶é’Ÿè¿½è¸ªå› æœå…³ç³»
- è‡ªåŠ¨å†²çªæ£€æµ‹å’Œè§£å†³

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—ç»“æ„

```
node_sync.rs (è·¨èŠ‚ç‚¹åŒæ­¥æ¨¡å—)
â”œâ”€â”€ NodeInfo          # èŠ‚ç‚¹ä¿¡æ¯
â”œâ”€â”€ NodeManager       # èŠ‚ç‚¹ç®¡ç†å™¨
â””â”€â”€ NodeSyncCoordinator  # åŒæ­¥åè°ƒå™¨

proto/file_service.proto
â””â”€â”€ NodeSyncService   # èŠ‚ç‚¹åŒæ­¥ gRPC æœåŠ¡
    â”œâ”€â”€ RegisterNode      # èŠ‚ç‚¹æ³¨å†Œ
    â”œâ”€â”€ Heartbeat         # å¿ƒè·³æ£€æµ‹
    â”œâ”€â”€ ListNodes         # åˆ—å‡ºèŠ‚ç‚¹
    â”œâ”€â”€ SyncFileState     # åŒæ­¥æ–‡ä»¶çŠ¶æ€
    â”œâ”€â”€ RequestFileSync   # è¯·æ±‚æ–‡ä»¶åŒæ­¥
    â””â”€â”€ GetSyncStatus     # è·å–åŒæ­¥çŠ¶æ€
```

### æ•°æ®ç»“æ„

#### 1. NodeInfo - èŠ‚ç‚¹ä¿¡æ¯
```rust
pub struct NodeInfo {
    pub node_id: String,          // èŠ‚ç‚¹å”¯ä¸€ ID
    pub address: String,           // èŠ‚ç‚¹åœ°å€ (host:port)
    pub last_seen: NaiveDateTime,  // æœ€åå¿ƒè·³æ—¶é—´
    pub version: String,           // èŠ‚ç‚¹ç‰ˆæœ¬
    pub metadata: HashMap<String, String>,  // å…ƒæ•°æ®
    pub status: NodeStatus,        // èŠ‚ç‚¹çŠ¶æ€ (Online/Offline/Faulty)
}
```

#### 2. NodeManager - èŠ‚ç‚¹ç®¡ç†å™¨
```rust
pub struct NodeManager {
    config: NodeDiscoveryConfig,             // å‘ç°é…ç½®
    nodes: Arc<RwLock<HashMap<String, NodeInfo>>>,  // èŠ‚ç‚¹åˆ—è¡¨
    sync_manager: Arc<SyncManager>,          // åŒæ­¥ç®¡ç†å™¨
}
```

åŠŸèƒ½:
- `register_node()` - æ³¨å†Œæ–°èŠ‚ç‚¹
- `remove_node()` - ç§»é™¤èŠ‚ç‚¹
- `update_heartbeat()` - æ›´æ–°å¿ƒè·³
- `list_online_nodes()` - è·å–åœ¨çº¿èŠ‚ç‚¹
- `start_heartbeat_check()` - å¯åŠ¨å¿ƒè·³æ£€æŸ¥

#### 3. NodeSyncCoordinator - åŒæ­¥åè°ƒå™¨
```rust
pub struct NodeSyncCoordinator {
    config: SyncConfig,                      // åŒæ­¥é…ç½®
    node_manager: Arc<NodeManager>,          // èŠ‚ç‚¹ç®¡ç†å™¨
    sync_manager: Arc<SyncManager>,          // åŒæ­¥ç®¡ç†å™¨
    stats: Arc<RwLock<SyncStats>>,          // åŒæ­¥ç»Ÿè®¡
}
```

åŠŸèƒ½:
- `sync_to_node()` - åŒæ­¥æ–‡ä»¶åˆ°æŒ‡å®šèŠ‚ç‚¹
- `request_files_from_node()` - ä»èŠ‚ç‚¹è¯·æ±‚æ–‡ä»¶
- `start_auto_sync()` - å¯åŠ¨è‡ªåŠ¨åŒæ­¥
- `get_stats()` - è·å–åŒæ­¥ç»Ÿè®¡

### gRPC åè®®å®šä¹‰

#### èŠ‚ç‚¹æ³¨å†Œ
```protobuf
rpc RegisterNode(RegisterNodeRequest) returns (RegisterNodeResponse);

message RegisterNodeRequest {
  NodeInfo node = 1;
}

message RegisterNodeResponse {
  bool success = 1;
  repeated NodeInfo known_nodes = 2;  // è¿”å›å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨
}
```

#### å¿ƒè·³æ£€æµ‹
```protobuf
rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);

message HeartbeatRequest {
  string node_id = 1;
  int64 timestamp = 2;
}

message HeartbeatResponse {
  bool alive = 1;
  int64 server_timestamp = 2;
}
```

#### æ–‡ä»¶çŠ¶æ€åŒæ­¥
```protobuf
rpc SyncFileState(SyncFileStateRequest) returns (SyncFileStateResponse);

message FileSyncState {
  string file_id = 1;
  FileMetadata metadata = 2;
  bool deleted = 3;
  string vector_clock = 4;  // JSON åºåˆ—åŒ–çš„å‘é‡æ—¶é’Ÿ
  int64 timestamp = 5;
}

message SyncFileStateRequest {
  string source_node_id = 1;
  repeated FileSyncState states = 2;
}

message SyncFileStateResponse {
  bool success = 1;
  repeated string conflicts = 2;  // å†²çªçš„æ–‡ä»¶ ID
}
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. èŠ‚ç‚¹å¯åŠ¨æµç¨‹

```
1. åŠ è½½èŠ‚ç‚¹é…ç½®
   â”œâ”€â”€ èŠ‚ç‚¹ ID
   â”œâ”€â”€ ç›‘å¬åœ°å€
   â””â”€â”€ ç§å­èŠ‚ç‚¹åˆ—è¡¨

2. å¯åŠ¨èŠ‚ç‚¹ç®¡ç†å™¨
   â”œâ”€â”€ åˆå§‹åŒ–èŠ‚ç‚¹åˆ—è¡¨
   â””â”€â”€ å¯åŠ¨å¿ƒè·³æ£€æŸ¥ä»»åŠ¡

3. è¿æ¥åˆ°ç§å­èŠ‚ç‚¹
   â”œâ”€â”€ å‘é€ RegisterNode è¯·æ±‚
   â”œâ”€â”€ è·å–å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨
   â””â”€â”€ å»ºç«‹åŒå‘è¿æ¥

4. å¯åŠ¨åŒæ­¥åè°ƒå™¨
   â”œâ”€â”€ å¯åŠ¨è‡ªåŠ¨åŒæ­¥ä»»åŠ¡
   â””â”€â”€ ç›‘å¬æ–‡ä»¶å˜æ›´äº‹ä»¶
```

### 2. å¿ƒè·³æ£€æµ‹æµç¨‹

```
å®šæ—¶ä»»åŠ¡ (æ¯10ç§’):
1. éå†æ‰€æœ‰èŠ‚ç‚¹
2. æ£€æŸ¥æœ€åå¿ƒè·³æ—¶é—´
3. è¶…æ—¶èŠ‚ç‚¹æ ‡è®°ä¸º Offline
4. ç§»é™¤é•¿æ—¶é—´ç¦»çº¿çš„èŠ‚ç‚¹
5. è®°å½•èŠ‚ç‚¹çŠ¶æ€å˜åŒ–æ—¥å¿—
```

### 3. æ–‡ä»¶åŒæ­¥æµç¨‹

```
è‡ªåŠ¨åŒæ­¥ä»»åŠ¡ (æ¯60ç§’):
1. è·å–æ‰€æœ‰åœ¨çº¿èŠ‚ç‚¹
2. è·å–æ‰€æœ‰æ–‡ä»¶åŒæ­¥çŠ¶æ€
3. å¯¹æ¯ä¸ªèŠ‚ç‚¹:
   â”œâ”€â”€ è°ƒç”¨ SyncFileState RPC
   â”œâ”€â”€ å‘é€æ–‡ä»¶å…ƒæ•°æ®å’Œå‘é‡æ—¶é’Ÿ
   â”œâ”€â”€ æ¥æ”¶å†²çªåˆ—è¡¨
   â””â”€â”€ æ›´æ–°åŒæ­¥ç»Ÿè®¡
4. å¤„ç†åŒæ­¥å†²çª
5. è®°å½•åŒæ­¥æ—¥å¿—
```

### 4. å†²çªå¤„ç†æµç¨‹

```
å½“æ”¶åˆ°è¿œç¨‹æ–‡ä»¶çŠ¶æ€æ—¶:
1. æ¯”è¾ƒå‘é‡æ—¶é’Ÿ
   â”œâ”€â”€ æœ¬åœ° > è¿œç¨‹: ä¿ç•™æœ¬åœ°
   â”œâ”€â”€ è¿œç¨‹ > æœ¬åœ°: æ¥å—è¿œç¨‹
   â””â”€â”€ å¹¶å‘: æ£€æµ‹å†²çª

2. å¯¹äºå†²çªæ–‡ä»¶:
   â”œâ”€â”€ ä½¿ç”¨ LWW ç­–ç•¥ (åŸºäºæ—¶é—´æˆ³)
   â”œâ”€â”€ ä¿ç•™å†²çªå‰¯æœ¬ (.conflict æ–‡ä»¶)
   â””â”€â”€ è§¦å‘å†²çªäº‹ä»¶é€šçŸ¥

3. æ›´æ–°æœ¬åœ°çŠ¶æ€
4. å¹¿æ’­å˜æ›´åˆ°å…¶ä»–èŠ‚ç‚¹
```

## ğŸ“ é…ç½®è¯´æ˜

### èŠ‚ç‚¹å‘ç°é…ç½®

```rust
NodeDiscoveryConfig {
    node_id: "node-xxx",              // èŠ‚ç‚¹ ID (è‡ªåŠ¨ç”Ÿæˆ)
    listen_addr: "127.0.0.1:9000",    // ç›‘å¬åœ°å€
    seed_nodes: vec![
        "192.168.1.10:9000",          // ç§å­èŠ‚ç‚¹1
        "192.168.1.11:9000",          // ç§å­èŠ‚ç‚¹2
    ],
    heartbeat_interval: 10,            // å¿ƒè·³é—´éš”(ç§’)
    node_timeout: 30,                  // èŠ‚ç‚¹è¶…æ—¶(ç§’)
}
```

### åŒæ­¥é…ç½®

```rust
SyncConfig {
    auto_sync: true,                   // å¯ç”¨è‡ªåŠ¨åŒæ­¥
    sync_interval: 60,                 // åŒæ­¥é—´éš”(ç§’)
    max_files_per_sync: 100,           // æ¯æ¬¡åŒæ­¥æœ€å¤§æ–‡ä»¶æ•°
    max_retries: 3,                    // æœ€å¤§é‡è¯•æ¬¡æ•°
}
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ node_sync æ¨¡å—æµ‹è¯•
cargo test node_sync::

# æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½:
# - NodeInfo åˆ›å»ºå’Œå¿ƒè·³
# - èŠ‚ç‚¹çŠ¶æ€ç®¡ç†
# - é…ç½®é»˜è®¤å€¼
# - åŒæ­¥ç»Ÿè®¡
```

å½“å‰æµ‹è¯•: **6 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…**

### é›†æˆæµ‹è¯• (TODO)

```bash
# å¯åŠ¨å¤šèŠ‚ç‚¹æµ‹è¯•ç¯å¢ƒ
./test-multi-node.sh

# æµ‹è¯•åœºæ™¯:
# 1. ä¸¤èŠ‚ç‚¹äº’ç›¸å‘ç°
# 2. æ–‡ä»¶åœ¨èŠ‚ç‚¹é—´åŒæ­¥
# 3. èŠ‚ç‚¹æ•…éšœæ¢å¤
# 4. å†²çªè‡ªåŠ¨è§£å†³
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨èŠ‚ç‚¹

```rust
use silent_nas::node_sync::{NodeManager, NodeDiscoveryConfig};
use silent_nas::sync::SyncManager;

#[tokio::main]
async fn main() {
    // åˆ›å»ºåŒæ­¥ç®¡ç†å™¨
    let sync_manager = SyncManager::new("node-1", storage, notifier);

    // åˆ›å»ºèŠ‚ç‚¹ç®¡ç†å™¨
    let config = NodeDiscoveryConfig {
        node_id: "node-1".to_string(),
        listen_addr: "0.0.0.0:9000".to_string(),
        seed_nodes: vec!["192.168.1.10:9000".to_string()],
        ..Default::default()
    };

    let node_manager = NodeManager::new(config, sync_manager.clone());

    // è¿æ¥åˆ°ç§å­èŠ‚ç‚¹
    node_manager.connect_to_seeds().await.unwrap();

    // å¯åŠ¨å¿ƒè·³æ£€æŸ¥
    node_manager.clone().start_heartbeat_check().await;

    // åˆ›å»ºåŒæ­¥åè°ƒå™¨
    let sync_config = SyncConfig::default();
    let coordinator = NodeSyncCoordinator::new(
        sync_config,
        node_manager,
        sync_manager,
    );

    // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
    coordinator.clone().start_auto_sync().await;
}
```

### æŸ¥çœ‹åŒæ­¥çŠ¶æ€

```rust
// è·å–æ‰€æœ‰èŠ‚ç‚¹
let nodes = node_manager.list_online_nodes().await;
for node in nodes {
    println!("èŠ‚ç‚¹: {} @ {}", node.node_id, node.address);
}

// è·å–åŒæ­¥ç»Ÿè®¡
let stats = coordinator.get_stats().await;
println!("åŒæ­¥ç»Ÿè®¡:");
println!("  æ€»æ–‡ä»¶æ•°: {}", stats.total_files);
println!("  å·²åŒæ­¥: {}", stats.synced_files);
println!("  å¾…åŒæ­¥: {}", stats.pending_files);
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### èµ„æºä½¿ç”¨
- **å†…å­˜å ç”¨**: æ¯ä¸ªèŠ‚ç‚¹ ~1KB
- **å¿ƒè·³å¼€é”€**: æ¯10ç§’ < 1KB/èŠ‚ç‚¹
- **åŒæ­¥å¼€é”€**: å–å†³äºæ–‡ä»¶æ•°é‡å’Œå¤§å°

### æ‰©å±•æ€§
- æ”¯æŒ **100+ èŠ‚ç‚¹** çš„é›†ç¾¤
- æ¯ç§’å¯å¤„ç† **1000+ æ–‡ä»¶** çš„çŠ¶æ€åŒæ­¥
- å¿ƒè·³æ£€æµ‹å»¶è¿Ÿ < 1ç§’

## ğŸ”® åç»­è®¡åˆ’

### Phase 1 - å½“å‰å®ç° âœ…
- [x] èŠ‚ç‚¹å‘ç°å’Œæ³¨å†Œ
- [x] å¿ƒè·³æ£€æµ‹
- [x] æ–‡ä»¶çŠ¶æ€åŒæ­¥æ¡†æ¶
- [x] è‡ªåŠ¨åŒæ­¥è°ƒåº¦

### Phase 2 - gRPC æœåŠ¡å®ç° âœ… (2025-10-16)
- [x] å®ç° gRPC æœåŠ¡ç«¯
  - [x] RegisterNode æ¥å£
  - [x] Heartbeat æ¥å£
  - [x] ListNodes æ¥å£
  - [x] SyncFileState æ¥å£
  - [x] RequestFileSync æ¥å£
  - [x] GetSyncStatus æ¥å£
- [x] å®ç° gRPC å®¢æˆ·ç«¯
  - [x] NodeSyncClient å®¢æˆ·ç«¯
  - [x] è¿æ¥ç®¡ç†å’Œè‡ªåŠ¨é‡è¿
  - [x] æ‰€æœ‰ RPC æ¥å£çš„å®¢æˆ·ç«¯æ–¹æ³•
  - [x] é›†æˆåˆ° NodeManager
- [ ] å®Œæ•´çš„æ–‡ä»¶å†…å®¹åŒæ­¥ (TODO)
- [ ] å¢é‡åŒæ­¥ç®—æ³• (TODO)
- [ ] æ–­ç‚¹ç»­ä¼ æ”¯æŒ (TODO)

### Phase 3 - ä¼˜åŒ–å¢å¼º (TODO)
- [ ] åŒæ­¥ä¼˜å…ˆçº§é˜Ÿåˆ—
- [ ] å¸¦å®½é™åˆ¶
- [ ] å‹ç¼©ä¼ è¾“
- [ ] åŠ å¯†é€šä¿¡
- [ ] åŒæ­¥ç­–ç•¥é…ç½® (å…¨é‡/é€‰æ‹©æ€§)

### Phase 4 - é«˜çº§åŠŸèƒ½ (TODO)
- [ ] å¤šå‰¯æœ¬ç®¡ç†
- [ ] æ•°æ®åˆ†ç‰‡
- [ ] ä¸€è‡´æ€§å“ˆå¸Œ
- [ ] è‡ªåŠ¨æ•…éšœè½¬ç§»
- [ ] é›†ç¾¤ç›‘æ§é¢æ¿

## ğŸ› å·²çŸ¥é—®é¢˜

1. **TODO**: gRPC æœåŠ¡ç«¯å°šæœªå®ç°ï¼Œéœ€è¦å®Œæˆ NodeSyncService çš„å®ç°
2. **TODO**: æ–‡ä»¶å†…å®¹ä¼ è¾“é€»è¾‘éœ€è¦å®Œå–„
3. **TODO**: å¢é‡åŒæ­¥ç®—æ³•éœ€è¦ä¼˜åŒ–
4. **TODO**: éœ€è¦æ·»åŠ æ›´å¤šé›†æˆæµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æ–™

- [CRDT è®ºæ–‡](https://hal.inria.fr/inria-00555588/document)
- [å‘é‡æ—¶é’Ÿ](https://en.wikipedia.org/wiki/Vector_clock)
- [gRPC æ–‡æ¡£](https://grpc.io/docs/)
- [Raft å…±è¯†ç®—æ³•](https://raft.github.io/)

## ğŸ“ å˜æ›´æ—¥å¿—

### v0.3.0 (2025-10-16)
- âœ… å®ç° NodeSyncClient gRPC å®¢æˆ·ç«¯
- âœ… å®ç°æ‰€æœ‰å®¢æˆ·ç«¯æ–¹æ³•ï¼ˆæ³¨å†Œã€å¿ƒè·³ã€åŒæ­¥ï¼‰
- âœ… é›†æˆåˆ° NodeManagerï¼ˆç§å­èŠ‚ç‚¹è¿æ¥ï¼‰
- âœ… æ·»åŠ å•å…ƒæµ‹è¯• (+4ä¸ªæµ‹è¯•)
- âœ… æ€»æµ‹è¯•æ•°ï¼š215 â†’ 219

### v0.2.0 (2025-10-16)
- âœ… å®ç° NodeSyncService gRPC æœåŠ¡ç«¯
- âœ… å®ç°æ‰€æœ‰ RPC æ¥å£ï¼ˆæ³¨å†Œã€å¿ƒè·³ã€åŒæ­¥ï¼‰
- âœ… æ·»åŠ ç±»å‹è½¬æ¢è¾…åŠ©å‡½æ•°
- âœ… æ·»åŠ å•å…ƒæµ‹è¯• (+1ä¸ªæµ‹è¯•)
- âœ… æ€»æµ‹è¯•æ•°ï¼š214 â†’ 215

### v0.1.0 (2025-10-16)
- âœ… å®ç°èŠ‚ç‚¹å‘ç°å’Œç®¡ç†åŸºç¡€æ¡†æ¶
- âœ… å®ç°å¿ƒè·³æ£€æµ‹æœºåˆ¶
- âœ… å®ç°åŒæ­¥åè°ƒå™¨å’Œè‡ªåŠ¨åŒæ­¥
- âœ… æ·»åŠ  gRPC åè®®å®šä¹‰
- âœ… æ·»åŠ å•å…ƒæµ‹è¯• (6ä¸ªæµ‹è¯•)
- âœ… å®Œæˆæ¶æ„æ–‡æ¡£

---

**æ€»ç»“**: è·¨èŠ‚ç‚¹åŒæ­¥åŠŸèƒ½çš„åŸºç¡€æ¡†æ¶å·²ç»å®Œæˆï¼Œæä¾›äº†èŠ‚ç‚¹å‘ç°ã€å¿ƒè·³æ£€æµ‹å’ŒåŒæ­¥è°ƒåº¦çš„æ ¸å¿ƒèƒ½åŠ›ã€‚ä¸‹ä¸€æ­¥éœ€è¦å®ç° gRPC æœåŠ¡ç«¯å’Œå®Œæ•´çš„æ–‡ä»¶ä¼ è¾“é€»è¾‘ã€‚
