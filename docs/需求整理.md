# Silent-NAS 需求整理文档

## 项目定位
Silent-NAS 是 Silent Odyssey 第六阶段的实验项目，作为纯服务端 NAS 系统实现，验证 Silent 框架在分布式存储场景下的能力。

## 核心原则
- **服务端专注**：本项目仅实现服务端功能，客户端使用现有成熟产品
- **协议兼容**：通过标准协议（HTTP、gRPC、WebDAV、S3）兼容主流客户端
- **高性能传输**：基于 QUIC/WebTransport 实现高速文件传输
- **最终一致性**：通过 CRDT 和 NATS 保证分布式文件一致性

## 功能需求

### 第一阶段：核心传输与控制（当前阶段）

#### FR-1.1 文件存储管理
- **需求**：实现本地文件系统的存储与管理
- **功能点**：
  - 文件上传、下载、删除
  - 文件列表查询
  - 文件元数据管理（大小、修改时间、哈希值）
  - SHA-256 文件校验
- **状态**：✅ 已实现

#### FR-1.2 HTTP/gRPC 接口
- **需求**：提供基础的文件控制与元数据接口
- **功能点**：
  - HTTP REST API：文件 CRUD 操作
  - gRPC 接口：高性能文件元数据查询
  - 文件列表与删除操作
  - 健康检查接口
- **状态**：✅ 已实现

#### FR-1.3 QUIC 文件传输
- **需求**：基于 QUIC 协议实现高速文件传输
- **功能点**：
  - QUIC 服务端实现
  - 双向流通信
  - 自签名证书支持
  - 基础文件上传/下载协议
- **状态**：✅ 已实现

#### FR-1.4 NATS 事件推送
- **需求**：文件变更事件的实时推送
- **功能点**：
  - 连接 NATS 服务器
  - 发布文件变更事件（创建、修改、删除）
  - 事件格式定义（JSON）
  - 主题分类（created/modified/deleted）
- **状态**：✅ 已实现

### 第二阶段：协议兼容层（后续）

#### FR-2.1 WebDAV 服务端实现
- **需求**：实现 WebDAV 协议服务端（RFC 4918）
- **功能点**：
  - `OPTIONS`：支持的方法查询
  - `PROPFIND`：文件/目录属性查询（支持 Depth 0/1）
  - `GET`：文件下载
  - `PUT`：文件上传
  - `DELETE`：文件/目录删除
  - `MKCOL`：目录创建
  - `MOVE`：文件/目录移动
  - `COPY`：文件/目录复制
  - 支持 URL 编码/解码
  - 支持 MIME 类型检测
  - 支持文件时间戳
- **状态**：✅ 已实现

#### FR-2.2 S3 兼容 API
- **需求**：实现 S3 API 子集
- **功能点**：
  - `PutObject`：上传对象
  - `GetObject`：下载对象
  - `DeleteObject`：删除对象
  - `ListObjects`：列表查询（V1和V2）
  - `HeadObject`：元数据查询
  - `PutBucket`：创建Bucket（伪实现）
  - `DeleteBucket`：删除Bucket（伪实现）
  - `HeadBucket`：检查Bucket是否存在
- **状态**：✅ 已实现

### 第三阶段：分布式特性（后续）

#### FR-3.1 CRDT 元数据同步
- **需求**：基于 CRDT 的多节点文件同步
- **功能点**：
  - 文件版本向量管理
  - 冲突检测与自动合并
  - 节点间同步协议
  - LWW-Register 元数据同步
  - 向量时钟因果追踪
- **状态**：✅ 已实现（2025-10-15）

#### FR-3.2 基于事件的内容拉取
- **需求**：在收到远程变更事件后，自动拉取实际文件内容并落库
- **功能点**：
  - NATS 事件中携带源节点对外 HTTP 地址（如 `http://node1:8080`）
  - 监听端校验本地是否存在文件或哈希是否一致
  - 不一致时通过 `GET {source}/api/files/{id}` 拉取内容
  - 成功写入后仅更新本地，不二次广播，避免事件风暴
- **状态**：✅ 已实现（2025-10-16）

#### FR-3.3 增量同步（按块/差异）
- **需求**：实现基于块的文件差异检测和增量同步，减少网络传输
- **功能点**：
  - 文件分块签名计算（SHA256强哈希 + Adler-32弱哈希）
  - 块级差异检测算法
  - 差异块传输（仅传输变化的块）
  - 差异块应用和文件重组
  - HTTP API支持（`GET /api/sync/signature/{id}` 和 `POST /api/sync/delta/{id}`）
  - 自动回退到全量下载（失败时）
  - 传输节省统计
- **状态**：✅ 已实现（2025-10-17）

#### FR-3.4 用户认证与授权
- **需求**：完整的JWT认证系统和基于角色的访问控制
- **功能点**：
  - JWT Token认证（访问令牌1小时，刷新令牌7天）
  - Argon2密码哈希（OWASP推荐算法）
  - 用户角色系统（Admin/User/ReadOnly）
  - 用户状态管理（Active/Suspended/Deleted）
  - Sled嵌入式数据库存储
  - 密码强度验证（Weak/Medium/Strong）
  - 认证API端点：
    - `POST /api/auth/register` - 用户注册
    - `POST /api/auth/login` - 用户登录
    - `POST /api/auth/refresh` - 刷新Token
    - `GET /api/auth/me` - 获取当前用户
    - `PUT /api/auth/password` - 修改密码
  - 默认管理员自动初始化
  - 认证中间件保护API端点
  - 配置文件支持（config.toml [auth]段）
  - 环境变量可选启用（ENABLE_AUTH）
- **测试覆盖**：
  - 176个单元测试全部通过
  - JWT生成和验证：94.19%覆盖率
  - 密码处理：93.47%覆盖率
  - 用户存储：81.09%覆盖率
  - 整体覆盖率：86.38%
- **文档**：
  - 完整的用户文档（docs/认证功能文档.md，828行）
  - 完成度报告（docs/feat-authentication-enhancement-完成度报告.md）
- **状态**：✅ 已完成（2025-10-20）

## 非功能需求

### NFR-1 性能要求
- 文件上传速度：≥100MB/s（QUIC）
- 文件下载速度：≥100MB/s（QUIC）
- HTTP API 响应时间：≤100ms（P95）
- 支持并发连接：≥1000

### NFR-2 可靠性要求
- 文件完整性：SHA-256 校验
- 断点续传：支持中断恢复
- 事件推送：至少一次投递保证

### NFR-3 可扩展性要求
- 支持单机 TB 级存储
- 支持多节点水平扩展（后续）
- 支持多协议接入

## 技术选型

### 核心依赖
- **Web 框架**：Silent（本地路径）
- **异步运行时**：Tokio
- **QUIC 实现**：Quinn
- **gRPC**：Tonic
- **消息队列**：async-nats
- **序列化**：Serde
- **ID 生成**：scru128
- **时间处理**：chrono（使用本地时间）

### 数据结构
```rust
// 文件元数据
struct FileMetadata {
    id: String,              // scru128 生成
    name: String,
    path: String,
    size: u64,
    hash: String,            // SHA-256
    created_at: NaiveDateTime,  // 本地时间
    modified_at: NaiveDateTime,
}

// 文件变更事件
struct FileEvent {
    event_id: String,        // scru128 生成
    event_type: EventType,   // Created/Modified/Deleted
    file_id: String,
    timestamp: NaiveDateTime,
    metadata: FileMetadata,
}
```

## 接口定义

### HTTP REST API
```
POST   /api/files           - 上传文件
GET    /api/files/:id       - 下载文件
DELETE /api/files/:id       - 删除文件
GET    /api/files           - 列表查询
GET    /api/files/:id/meta  - 获取元数据
GET    /health              - 健康检查
```

### gRPC 接口
```protobuf
service FileService {
  rpc GetFile(FileRequest) returns (FileResponse);
  rpc ListFiles(ListRequest) returns (ListResponse);
  rpc GetMetadata(MetadataRequest) returns (MetadataResponse);
  rpc DeleteFile(DeleteRequest) returns (DeleteResponse);
}
```

### NATS 事件主题与负载
```
silent.nas.files.created
silent.nas.files.modified
silent.nas.files.deleted
```

事件负载（JSON）：
```
{
  "event_id": "scru128",
  "event_type": "created|modified|deleted",
  "file_id": "scru128",
  "timestamp": "本地时间字符串",
  "metadata": { /* FileMetadata */ },
  "source_node_id": "可选，发布者节点ID",
  "source_http_addr": "可选，发布者 HTTP 基址，如 http://node1:8080"
}
```

## 目录结构
```
src/
├── main.rs          # 启动入口，初始化所有服务
├── config.rs        # 配置管理（端口、路径、NATS 地址等）
├── storage.rs       # 文件系统与分块管理
├── transfer.rs      # QUIC/WebTransport 文件传输逻辑
├── rpc.rs           # gRPC 控制接口
├── notify.rs        # NATS 文件事件推送
├── models.rs        # 数据模型定义
└── error.rs         # 错误处理
```

## 部署要求

### 环境依赖
- Rust 1.83+（edition 2024）

### 第四阶段：版本管理与高级特性（后续）

#### FR-4.1 文件版本管理
- **需求**：完整的文件版本控制系统
- **功能点**：
  - 版本元数据存储（version_id, file_id, created_at, size, hash）
  - 版本内容管理（全量存储）
  - 版本历史查询
  - 版本回退与恢复
  - 版本删除与清理
  - 版本统计信息
  - HTTP API 完整实现
- **状态**：✅ 已完成（2025-10-15）

#### FR-4.2 元数据搜索引擎
- **需求**：实现基于全文搜索的文件元数据检索功能
- **功能点**：
  - 基于 Tantivy 的全文搜索引擎
  - 文件名、路径、ID 的索引与搜索
  - 分页查询支持（limit/offset）
  - 批量索引和索引重建
  - 文件上传时自动索引
  - 文件删除时自动移除索引
  - 定期索引提交（30秒）
  - 搜索统计信息
  - HTTP API 实现：
    - `GET /api/search?q=<query>&limit=20&offset=0` - 搜索文件
    - `GET /api/search/stats` - 获取搜索统计
- **测试覆盖**：
  - 搜索引擎创建和初始化
  - 索引文件和搜索功能
  - 批量索引处理
  - 搜索结果分页
  - 索引重建
  - 特殊字符和空查询处理
- **性能指标**：
  - 区域覆盖率：91.45%
  - 行覆盖率：93.93%
- **状态**：✅ 已完成（2025-10-17）

#### FR-4.3 S3/WebDAV 版本控制扩展
- **需求**：为 S3 和 WebDAV 协议添加版本控制支持
- **功能点**：
  - S3 版本控制 API（GetBucketVersioning, PutBucketVersioning, ListObjectVersions）
  - WebDAV 版本扩展（VERSION-CONTROL, REPORT 方法）
- **状态**：✅ 已完成（2025-10-17）

#### FR-4.4 性能监控系统
- **需求**：实现完整的Prometheus metrics导出和性能监控
- **功能点**：
  - Prometheus metrics导出
    - HTTP指标：requests_total, request_duration, requests_in_flight
    - 文件指标：operations_total, bytes_transferred, count_total
    - 搜索指标：queries_total, query_duration, results_total
    - 同步指标：operations_total, bytes_transferred, conflicts_total
    - 缓存指标：hit_rate, size_bytes, entries
  - 高性能缓存系统（基于moka）
    - MetadataCache：元数据缓存（1000条，TTL 1h）
    - ContentCache：文件内容缓存（100条，100MB，TTL 10min）
    - SearchCache：搜索结果缓存（500条，TTL 5min）
  - 健康检查增强
    - `GET /api/health` - 存活检查
    - `GET /api/health/readiness` - 就绪检查
    - `GET /api/health/status` - 详细状态
  - API端点：`GET /api/metrics`
- **状态**：✅ 已完成（2025-10-17）

#### FR-4.5 审计日志系统
- **需求**：实现完整的审计日志功能
- **功能点**：
  - 10种审计事件类型（文件、版本、搜索、同步、认证等）
  - 结构化JSON日志输出
  - 内存缓存最近1000条事件
  - 按操作类型和资源ID筛选
  - 统计信息（总数、成功/失败、分类计数）
  - API端点：
    - `GET /api/audit/logs` - 查询审计日志
    - `GET /api/audit/stats` - 审计统计信息
  - 环境变量启用（ENABLE_AUDIT）
- **状态**：✅ 已完成（2025-10-17）

## 变更记录
- 2025-10-20 09:00:00 +0800：完成用户认证与授权系统（FR-3.4）PR准备，新增认证中间件保护API端点、配置文件支持、完成度报告；176个单元测试全部通过，整体覆盖率86.38%；创建PR模板和PR描述文档；准备合并到main分支。
- 2025-10-17 22:00:00 +0800：完成用户认证与授权系统（FR-3.4）核心功能，新增 `src/auth/` 模块（models/jwt/password/storage/mod），实现基于JWT的完整认证系统；支持Argon2密码哈希、用户角色管理、Sled数据库存储；新增5个认证API端点（register/login/refresh/me/password）；52个单元测试全部通过，覆盖率82-94%；新增完整用户文档（docs/认证功能文档.md，828行）；通过环境变量ENABLE_AUTH可选启用。
- 2025-10-17 20:00:00 +0800：完成性能监控系统（FR-4.4）和审计日志系统（FR-4.5），新增 `src/metrics.rs` 和 `src/audit.rs` 模块；实现Prometheus metrics导出、高性能缓存系统（基于moka）、健康检查增强；HTTP模块重构为9个子模块提升可维护性；173个单元测试全部通过。
- 2025-10-17 19:37:00 +0800：完成元数据搜索引擎功能（FR-4.2），新增 `src/search.rs` 模块，实现基于 Tantivy 的全文搜索引擎；支持文件名、路径、ID 的索引与搜索；集成到 HTTP API（`/api/search` 和 `/api/search/stats`）；文件上传时自动索引，删除时自动移除；测试覆盖率达到 91.45%（区域）和 93.93%（行）；HTTP 模块重构为萃取器模式；测试数量从 277 增加到 302 个，全部通过。
- 2025-10-17 14:05:00 +0800：更新文档以反映实际代码状态，确认文件版本管理系统（FR-4.1）已完成，包括完整的 HTTP API 实现和测试覆盖；增量同步模块已重构为 `src/sync/incremental/` 子模块，包含核心算法、处理器和 API；所有功能已集成到 main.rs 并正常运行。
- 2025-10-17 10:52:00 +0800：完成增量同步功能（FR-3.3），新增 `src/sync/incremental/` 模块，实现基于块的文件差异检测和增量同步；支持SHA256强哈希和Adler-32弱哈希的双重签名；新增HTTP API端点 `GET /api/sync/signature/{id}` 和 `POST /api/sync/delta/{id}`；在EventListener中集成增量同步，优先使用增量传输，失败时自动回退到全量下载；所有测试通过，`cargo check` 和 `cargo clippy` 均通过。
- 2025-10-15 20:40:00 +0800：完成 CRDT 文件同步功能（FR-3.1），新增 `src/sync/crdt.rs` 模块，实现基于 LWW-Register 的元数据同步和向量时钟冲突检测；完成文件版本管理系统（FR-4.1），新增 `src/version.rs` 模块，实现完整的版本控制功能。
- 2025-10-15 16:22:51 +0800：将 S3 Object 相关接口归档至 `src/s3/handlers/object/` 子目录，拆分为 `single.rs`、`list.rs`、`batch.rs`、`helpers.rs` 四个模块，提升可读性与可维护性；更新 `src/s3/handlers/mod.rs` 以引入 `object` 子模块。
- 2025-10-15 16:28:48 +0800：迁移 S3 分片上传接口至 `src/s3/handlers/object/multipart.rs` 并移除 `src/s3/multipart.rs`，在 `src/s3/mod.rs` 删除 `mod multipart;` 声明；`cargo check` 与 `cargo clippy` 均通过。
- NATS 服务器（外部）
- 文件存储目录（可配置）

### 配置项
```toml
[server]
http_port = 8080
grpc_port = 50051
quic_port = 4433

[storage]
root_path = "./storage"
chunk_size = 4194304  # 4MB

[nats]
url = "nats://127.0.0.1:4222"
```

## 验证计划

### 单元测试
- 文件存储模块测试
- 元数据管理测试
- 事件发布测试

### 集成测试
- HTTP API 端到端测试
- gRPC 接口测试
- QUIC 传输测试
- NATS 事件推送测试

### 性能测试
- 大文件上传/下载性能
- 并发连接压力测试
- 内存占用测试

## 里程碑

### M1 - 基础框架搭建（第1周）
- [x] 项目初始化
- [ ] 依赖配置
- [ ] 目录结构创建
- [ ] 基础数据模型定义

### M2 - 核心功能实现（第2-3周）
- [ ] 文件存储模块
- [ ] HTTP/gRPC 接口
- [ ] QUIC 传输实现
- [ ] NATS 事件推送

### M3 - 测试与优化（第4周）
- [ ] 单元测试完成
- [ ] 集成测试完成
- [ ] 性能优化
- [ ] 文档完善

## 风险与约束

### 技术风险
- QUIC 协议复杂性较高，需要深入学习
- 大文件传输的内存管理需要优化
- NATS 连接稳定性需要保证

### 约束条件
- 第一阶段仅实现单节点模式
- 暂不考虑数据持久化到数据库
- 暂不实现用户认证功能

## 第五阶段：接下来要开发的内容

### 高优先级 (P0)

#### FR-5.1 认证与授权增强
- **需求**：完善多用户系统和权限细粒度控制
- **功能点**：
  - 用户管理API
    - 管理员查看所有用户
    - 管理员修改用户角色/状态
    - 管理员重置用户密码
  - 登录限制与安全
    - 失败次数限制
    - IP黑名单
    - 临时锁定机制
  - Token黑名单
    - 注销功能
    - Token撤销列表
  - 审计集成
    - 登录/注销审计
    - 权限变更审计
    - 敏感操作审计
  - 权限细粒度控制
    - 基于路径的ACL
    - 用户组管理
    - 共享链接（只读/读写）
    - 用户配额管理
- **预计工期**：2-3周
- **依赖**：FR-3.4认证系统 ✅
- **状态**：🚧 待开发

#### FR-5.2 S3 高级功能扩展
- **需求**：完善S3兼容性，支持更多高级特性
- **功能点**：
  - 对象标签（Object Tagging）
    - `PutObjectTagging`
    - `GetObjectTagging`
    - `DeleteObjectTagging`
  - 访问控制列表（ACL）
    - `PutBucketAcl`
    - `GetBucketAcl`
    - `PutObjectAcl`
    - `GetObjectAcl`
  - 生命周期管理
    - `PutBucketLifecycle`
    - `GetBucketLifecycle`
    - 自动过期删除任务
  - Presigned URL支持
    - 生成临时访问URL
    - URL签名验证
    - 过期时间控制
  - CORS配置
    - `PutBucketCors`
    - `GetBucketCors`
    - 跨域请求处理
- **预计工期**：2周
- **依赖**：当前S3实现 ✅
- **验证方式**：AWS CLI和boto3完整测试
- **状态**：🚧 待开发

### 中优先级 (P1)

#### FR-5.3 WebDAV 高级功能
- **需求**：完善WebDAV协议支持，提升客户端兼容性
- **功能点**：
  - 文件锁定支持
    - `LOCK`方法实现
    - `UNLOCK`方法实现
    - 锁定超时管理
    - 锁定冲突处理
  - 属性扩展
    - 自定义属性支持
    - `PROPPATCH`完善
  - 范围请求优化
    - 支持`Range`头部（断点续传）
    - 多范围请求支持
  - 大文件优化
    - 分块上传改进
    - 上传进度跟踪
  - DeltaV协议完整实现
    - `VERSION-CONTROL`方法完整实现
    - `REPORT`方法实现版本历史查询
    - `CHECKOUT`/`CHECKIN`工作区管理
    - `UNCHECKOUT`放弃修改
- **预计工期**：1-2周
- **依赖**：webdav.rs ✅
- **验证方式**：Cyberduck、rclone完整功能测试
- **状态**：🚧 待开发

#### FR-5.4 版本存储优化
- **需求**：优化版本存储空间占用
- **功能点**：
  - 增量存储：使用差异算法减少存储空间占用
  - 压缩策略：对历史版本进行自动压缩
  - 冷热分离：旧版本迁移到低成本存储
  - 重复数据删除：跨文件的块级去重
  - 版本使用统计：各bucket/目录的版本数量和大小
  - 存储成本分析：版本数据占用的存储空间报告
  - 版本访问日志：记录版本查看和恢复操作
  - 告警机制：版本数量或存储超限告警
- **预计工期**：1-2周
- **依赖**：FR-4.1版本管理 ✅
- **状态**：🚧 待开发

### 低优先级 (P2)

#### FR-5.5 跨节点同步完善
- **需求**：完善多节点文件同步功能
- **功能点**：
  - 选择性同步（白名单/黑名单）
  - 同步队列管理
  - 同步性能优化
  - 冲突解决策略完善
  - 节点健康监控
- **预计工期**：2-3周
- **依赖**：FR-3.1 CRDT同步 ✅
- **状态**：🚧 待开发

#### FR-5.6 分布式存储与副本
- **需求**：实现数据分片和多副本容错
- **功能点**：
  - 数据分片策略（一致性哈希）
  - 分片元数据管理
  - 多副本存储
  - 副本同步
  - 副本恢复
  - 容错机制
    - 节点故障检测
    - 自动故障转移
    - 数据恢复
- **预计工期**：4-6周
- **依赖**：FR-5.5跨节点同步
- **状态**：🚧 待开发

#### FR-5.7 NFS/SMB 协议支持
- **需求**：支持传统网络文件系统协议
- **功能点**：
  - NFS服务端实现
    - NFSv3协议支持
    - Mount服务
  - SMB服务端实现
    - SMB 2/3协议支持
    - CIFS兼容
  - 协议转换层
    - 统一文件系统接口
    - 权限映射
- **预计工期**：4-6周
- **复杂度**：高
- **状态**：🚧 待开发

## 后续规划
- Phase 5: 认证增强与S3/WebDAV高级功能
- Phase 6: 分布式存储与副本恢复
- Phase 7: NFS/SMB协议支持
