# Silent-NAS 需求整理文档

## 项目定位
Silent-NAS 是 Silent Odyssey 第六阶段的实验项目，作为纯服务端 NAS 系统实现，验证 Silent 框架在分布式存储场景下的能力。

## 核心原则
- **服务端专注**：本项目仅实现服务端功能，客户端使用现有成熟产品
- **协议兼容**：通过标准协议（HTTP、gRPC、WebDAV、S3）兼容主流客户端
- **高性能传输**：基于 QUIC/WebTransport 实现高速文件传输
- **最终一致性**：通过 CRDT 和 NATS 保证分布式文件一致性

## 功能需求

### 第一阶段：核心传输与控制（当前阶段）

#### FR-1.1 文件存储管理
- **需求**：实现本地文件系统的存储与管理
- **功能点**：
  - 文件上传、下载、删除、重命名
  - 目录创建、删除、列表
  - 文件元数据管理（大小、修改时间、哈希值）
  - 文件分块管理（支持大文件）
- **状态**：✅ 需要实现

#### FR-1.2 HTTP/gRPC 接口
- **需求**：提供基础的文件控制与元数据接口
- **功能点**：
  - HTTP REST API：文件 CRUD 操作
  - gRPC 接口：高性能文件元数据查询
  - 文件列表与搜索
  - 健康检查接口
- **状态**：✅ 需要实现

#### FR-1.3 QUIC/WebTransport 文件传输
- **需求**：基于 QUIC 协议实现高速文件传输
- **功能点**：
  - QUIC 服务端实现
  - 文件上传（支持断点续传）
  - 文件下载（支持范围请求）
  - 传输性能监控
- **状态**：✅ 需要实现

#### FR-1.4 NATS 事件推送
- **需求**：文件变更事件的实时推送
- **功能点**：
  - 连接 NATS 服务器
  - 发布文件变更事件（创建、修改、删除）
  - 事件格式定义（JSON）
  - 错误重试机制
- **状态**：✅ 需要实现

### 第二阶段：协议兼容层（后续）

#### FR-2.1 WebDAV 服务端实现
- **需求**：实现 WebDAV 协议服务端（RFC 4918）
- **功能点**：
  - `PROPFIND`：列表查询
  - `PUT`：文件上传
  - `GET`：文件下载
  - `DELETE`：文件删除
  - `MKCOL`：目录创建
  - `MOVE/COPY`：文件移动/复制
- **状态**：🚧 规划中

#### FR-2.2 S3 兼容 API
- **需求**：实现 S3 API 子集
- **功能点**：
  - `PutObject`：上传对象
  - `GetObject`：下载对象
  - `DeleteObject`：删除对象
  - `ListObjects`：列表查询
  - `HeadObject`：元数据查询
- **状态**：🚧 规划中

### 第三阶段：分布式特性（后续）

#### FR-3.1 CRDT 文件同步
- **需求**：基于 CRDT 的多节点文件同步
- **功能点**：
  - 文件版本向量管理
  - 冲突检测与自动合并
  - 节点间同步协议
- **状态**：🚧 规划中

#### FR-3.2 用户鉴权与访问控制
- **需求**：多用户隔离与权限管理
- **功能点**：
  - JWT 令牌认证
  - 基于角色的访问控制（RBAC）
  - 文件级权限控制
- **状态**：🚧 规划中

## 非功能需求

### NFR-1 性能要求
- 文件上传速度：≥100MB/s（QUIC）
- 文件下载速度：≥100MB/s（QUIC）
- HTTP API 响应时间：≤100ms（P95）
- 支持并发连接：≥1000

### NFR-2 可靠性要求
- 文件完整性：SHA-256 校验
- 断点续传：支持中断恢复
- 事件推送：至少一次投递保证

### NFR-3 可扩展性要求
- 支持单机 TB 级存储
- 支持多节点水平扩展（后续）
- 支持多协议接入

## 技术选型

### 核心依赖
- **Web 框架**：Silent（本地路径）
- **异步运行时**：Tokio
- **QUIC 实现**：Quinn
- **gRPC**：Tonic
- **消息队列**：async-nats
- **序列化**：Serde
- **ID 生成**：scru128
- **时间处理**：chrono（使用本地时间）

### 数据结构
```rust
// 文件元数据
struct FileMetadata {
    id: String,              // scru128 生成
    name: String,
    path: String,
    size: u64,
    hash: String,            // SHA-256
    created_at: NaiveDateTime,  // 本地时间
    modified_at: NaiveDateTime,
}

// 文件变更事件
struct FileEvent {
    event_id: String,        // scru128 生成
    event_type: EventType,   // Created/Modified/Deleted
    file_id: String,
    timestamp: NaiveDateTime,
    metadata: FileMetadata,
}
```

## 接口定义

### HTTP REST API
```
POST   /api/files           - 上传文件
GET    /api/files/:id       - 下载文件
DELETE /api/files/:id       - 删除文件
GET    /api/files           - 列表查询
GET    /api/files/:id/meta  - 获取元数据
GET    /health              - 健康检查
```

### gRPC 接口
```protobuf
service FileService {
  rpc GetFile(FileRequest) returns (FileResponse);
  rpc ListFiles(ListRequest) returns (ListResponse);
  rpc GetMetadata(MetadataRequest) returns (MetadataResponse);
  rpc DeleteFile(DeleteRequest) returns (DeleteResponse);
}
```

### NATS 事件主题
```
silent.nas.files.created
silent.nas.files.modified
silent.nas.files.deleted
```

## 目录结构
```
src/
├── main.rs          # 启动入口，初始化所有服务
├── config.rs        # 配置管理（端口、路径、NATS 地址等）
├── storage.rs       # 文件系统与分块管理
├── transfer.rs      # QUIC/WebTransport 文件传输逻辑
├── rpc.rs           # gRPC 控制接口
├── notify.rs        # NATS 文件事件推送
├── models.rs        # 数据模型定义
└── error.rs         # 错误处理
```

## 部署要求

### 环境依赖
- Rust 1.83+（edition 2024）
- NATS 服务器（外部）
- 文件存储目录（可配置）

### 配置项
```toml
[server]
http_port = 8080
grpc_port = 50051
quic_port = 4433

[storage]
root_path = "./storage"
chunk_size = 4194304  # 4MB

[nats]
url = "nats://127.0.0.1:4222"
```

## 验证计划

### 单元测试
- 文件存储模块测试
- 元数据管理测试
- 事件发布测试

### 集成测试
- HTTP API 端到端测试
- gRPC 接口测试
- QUIC 传输测试
- NATS 事件推送测试

### 性能测试
- 大文件上传/下载性能
- 并发连接压力测试
- 内存占用测试

## 里程碑

### M1 - 基础框架搭建（第1周）
- [x] 项目初始化
- [ ] 依赖配置
- [ ] 目录结构创建
- [ ] 基础数据模型定义

### M2 - 核心功能实现（第2-3周）
- [ ] 文件存储模块
- [ ] HTTP/gRPC 接口
- [ ] QUIC 传输实现
- [ ] NATS 事件推送

### M3 - 测试与优化（第4周）
- [ ] 单元测试完成
- [ ] 集成测试完成
- [ ] 性能优化
- [ ] 文档完善

## 风险与约束

### 技术风险
- QUIC 协议复杂性较高，需要深入学习
- 大文件传输的内存管理需要优化
- NATS 连接稳定性需要保证

### 约束条件
- 第一阶段仅实现单节点模式
- 暂不考虑数据持久化到数据库
- 暂不实现用户认证功能

## 后续规划
- Phase 2: WebDAV/S3 协议实现
- Phase 3: CRDT 同步与多节点支持
- Phase 4: 用户认证与权限控制
- Phase 5: 分布式存储与副本恢复
