# Silent-NAS 需求整理文档

## 项目定位
Silent-NAS 是 Silent Odyssey 第六阶段的实验项目，作为纯服务端 NAS 系统实现，验证 Silent 框架在分布式存储场景下的能力。

## 核心原则
- **服务端专注**：本项目仅实现服务端功能，客户端使用现有成熟产品
- **协议兼容**：通过标准协议（HTTP、gRPC、WebDAV、S3）兼容主流客户端
- **高性能传输**：基于 QUIC/WebTransport 实现高速文件传输
- **最终一致性**：通过 CRDT 和 NATS 保证分布式文件一致性

## 功能需求

### 第一阶段：核心传输与控制（当前阶段）

#### FR-1.1 文件存储管理
- **需求**：实现本地文件系统的存储与管理
- **功能点**：
  - 文件上传、下载、删除
  - 文件列表查询
  - 文件元数据管理（大小、修改时间、哈希值）
  - SHA-256 文件校验
- **状态**：✅ 已实现

#### FR-1.2 HTTP/gRPC 接口
- **需求**：提供基础的文件控制与元数据接口
- **功能点**：
  - HTTP REST API：文件 CRUD 操作
  - gRPC 接口：高性能文件元数据查询
  - 文件列表与删除操作
  - 健康检查接口
- **状态**：✅ 已实现

#### FR-1.3 QUIC 文件传输
- **需求**：基于 QUIC 协议实现高速文件传输
- **功能点**：
  - QUIC 服务端实现
  - 双向流通信
  - 自签名证书支持
  - 基础文件上传/下载协议
- **状态**：✅ 已实现

#### FR-1.4 NATS 事件推送
- **需求**：文件变更事件的实时推送
- **功能点**：
  - 连接 NATS 服务器
  - 发布文件变更事件（创建、修改、删除）
  - 事件格式定义（JSON）
  - 主题分类（created/modified/deleted）
- **状态**：✅ 已实现

### 第二阶段：协议兼容层（后续）

#### FR-2.1 WebDAV 服务端实现
- **需求**：实现 WebDAV 协议服务端（RFC 4918）
- **功能点**：
  - `OPTIONS`：支持的方法查询
  - `PROPFIND`：文件/目录属性查询（支持 Depth 0/1）
  - `GET`：文件下载
  - `PUT`：文件上传
  - `DELETE`：文件/目录删除
  - `MKCOL`：目录创建
  - `MOVE`：文件/目录移动
  - `COPY`：文件/目录复制
  - 支持 URL 编码/解码
  - 支持 MIME 类型检测
  - 支持文件时间戳
- **状态**：✅ 已实现

#### FR-2.2 S3 兼容 API
- **需求**：实现 S3 API 子集
- **功能点**：
  - `PutObject`：上传对象
  - `GetObject`：下载对象
  - `DeleteObject`：删除对象
  - `ListObjects`：列表查询（V1和V2）
  - `HeadObject`：元数据查询
  - `PutBucket`：创建Bucket（伪实现）
  - `DeleteBucket`：删除Bucket（伪实现）
  - `HeadBucket`：检查Bucket是否存在
- **状态**：✅ 已实现

### 第三阶段：分布式特性（后续）

#### FR-3.1 CRDT 元数据同步
- **需求**：基于 CRDT 的多节点文件同步
- **功能点**：
  - 文件版本向量管理
  - 冲突检测与自动合并
  - 节点间同步协议
  - LWW-Register 元数据同步
  - 向量时钟因果追踪
- **状态**：✅ 已实现（2025-10-15）

#### FR-3.2 基于事件的内容拉取
- **需求**：在收到远程变更事件后，自动拉取实际文件内容并落库
- **功能点**：
  - NATS 事件中携带源节点对外 HTTP 地址（如 `http://node1:8080`）
  - 监听端校验本地是否存在文件或哈希是否一致
  - 不一致时通过 `GET {source}/api/files/{id}` 拉取内容
  - 成功写入后仅更新本地，不二次广播，避免事件风暴
- **状态**：✅ 已实现（2025-10-16）

#### FR-3.3 增量同步（按块/差异）
- **需求**：实现基于块的文件差异检测和增量同步，减少网络传输
- **功能点**：
  - 文件分块签名计算（SHA256强哈希 + Adler-32弱哈希）
  - 块级差异检测算法
  - 差异块传输（仅传输变化的块）
  - 差异块应用和文件重组
  - HTTP API支持（`GET /api/sync/signature/{id}` 和 `POST /api/sync/delta/{id}`）
  - 自动回退到全量下载（失败时）
  - 传输节省统计
- **状态**：✅ 已实现（2025-10-17）

#### FR-3.2 用户鉴权与访问控制
- **需求**：多用户隔离与权限管理
- **功能点**：
  - 用户管理（添加、验证）
  - 基于角色的访问控制（Admin/User/ReadOnly）
  - 密码哈希存储（SHA-256）
  - 权限检查机制
- **状态**：✅ 已实现（基础版本）

## 非功能需求

### NFR-1 性能要求
- 文件上传速度：≥100MB/s（QUIC）
- 文件下载速度：≥100MB/s（QUIC）
- HTTP API 响应时间：≤100ms（P95）
- 支持并发连接：≥1000

### NFR-2 可靠性要求
- 文件完整性：SHA-256 校验
- 断点续传：支持中断恢复
- 事件推送：至少一次投递保证

### NFR-3 可扩展性要求
- 支持单机 TB 级存储
- 支持多节点水平扩展（后续）
- 支持多协议接入

## 技术选型

### 核心依赖
- **Web 框架**：Silent（本地路径）
- **异步运行时**：Tokio
- **QUIC 实现**：Quinn
- **gRPC**：Tonic
- **消息队列**：async-nats
- **序列化**：Serde
- **ID 生成**：scru128
- **时间处理**：chrono（使用本地时间）

### 数据结构
```rust
// 文件元数据
struct FileMetadata {
    id: String,              // scru128 生成
    name: String,
    path: String,
    size: u64,
    hash: String,            // SHA-256
    created_at: NaiveDateTime,  // 本地时间
    modified_at: NaiveDateTime,
}

// 文件变更事件
struct FileEvent {
    event_id: String,        // scru128 生成
    event_type: EventType,   // Created/Modified/Deleted
    file_id: String,
    timestamp: NaiveDateTime,
    metadata: FileMetadata,
}
```

## 接口定义

### HTTP REST API
```
POST   /api/files           - 上传文件
GET    /api/files/:id       - 下载文件
DELETE /api/files/:id       - 删除文件
GET    /api/files           - 列表查询
GET    /api/files/:id/meta  - 获取元数据
GET    /health              - 健康检查
```

### gRPC 接口
```protobuf
service FileService {
  rpc GetFile(FileRequest) returns (FileResponse);
  rpc ListFiles(ListRequest) returns (ListResponse);
  rpc GetMetadata(MetadataRequest) returns (MetadataResponse);
  rpc DeleteFile(DeleteRequest) returns (DeleteResponse);
}
```

### NATS 事件主题与负载
```
silent.nas.files.created
silent.nas.files.modified
silent.nas.files.deleted
```

事件负载（JSON）：
```
{
  "event_id": "scru128",
  "event_type": "created|modified|deleted",
  "file_id": "scru128",
  "timestamp": "本地时间字符串",
  "metadata": { /* FileMetadata */ },
  "source_node_id": "可选，发布者节点ID",
  "source_http_addr": "可选，发布者 HTTP 基址，如 http://node1:8080"
}
```

## 目录结构
```
src/
├── main.rs          # 启动入口，初始化所有服务
├── config.rs        # 配置管理（端口、路径、NATS 地址等）
├── storage.rs       # 文件系统与分块管理
├── transfer.rs      # QUIC/WebTransport 文件传输逻辑
├── rpc.rs           # gRPC 控制接口
├── notify.rs        # NATS 文件事件推送
├── models.rs        # 数据模型定义
└── error.rs         # 错误处理
```

## 部署要求

### 环境依赖
- Rust 1.83+（edition 2024）

### 第四阶段：版本管理与高级特性（后续）

#### FR-4.1 文件版本管理
- **需求**：完整的文件版本控制系统
- **功能点**：
  - 版本元数据存储（version_id, file_id, created_at, size, hash）
  - 版本内容管理（全量存储）
  - 版本历史查询
  - 版本回退与恢复
  - 版本删除与清理
  - 版本统计信息
  - HTTP API 完整实现
- **状态**：✅ 已完成（2025-10-15）

#### FR-4.2 S3/WebDAV 版本控制扩展
- **需求**：为 S3 和 WebDAV 协议添加版本控制支持
- **功能点**：
  - S3 版本控制 API（GetBucketVersioning, PutBucketVersioning, ListObjectVersions）
  - WebDAV 版本扩展（VERSION-CONTROL, REPORT 方法）
- **状态**：❌ 未开始

## 变更记录
- 2025-10-17 14:05:00 +0800：更新文档以反映实际代码状态，确认文件版本管理系统（FR-4.1）已完成，包括完整的 HTTP API 实现和测试覆盖；增量同步模块已重构为 `src/sync/incremental/` 子模块，包含核心算法、处理器和 API；所有功能已集成到 main.rs 并正常运行。
- 2025-10-17 10:52:00 +0800：完成增量同步功能（FR-3.3），新增 `src/sync/incremental/` 模块，实现基于块的文件差异检测和增量同步；支持SHA256强哈希和Adler-32弱哈希的双重签名；新增HTTP API端点 `GET /api/sync/signature/{id}` 和 `POST /api/sync/delta/{id}`；在EventListener中集成增量同步，优先使用增量传输，失败时自动回退到全量下载；所有测试通过，`cargo check` 和 `cargo clippy` 均通过。
- 2025-10-15 20:40:00 +0800：完成 CRDT 文件同步功能（FR-3.1），新增 `src/sync/crdt.rs` 模块，实现基于 LWW-Register 的元数据同步和向量时钟冲突检测；完成文件版本管理系统（FR-4.1），新增 `src/version.rs` 模块，实现完整的版本控制功能。
- 2025-10-15 16:22:51 +0800：将 S3 Object 相关接口归档至 `src/s3/handlers/object/` 子目录，拆分为 `single.rs`、`list.rs`、`batch.rs`、`helpers.rs` 四个模块，提升可读性与可维护性；更新 `src/s3/handlers/mod.rs` 以引入 `object` 子模块。
- 2025-10-15 16:28:48 +0800：迁移 S3 分片上传接口至 `src/s3/handlers/object/multipart.rs` 并移除 `src/s3/multipart.rs`，在 `src/s3/mod.rs` 删除 `mod multipart;` 声明；`cargo check` 与 `cargo clippy` 均通过。
- NATS 服务器（外部）
- 文件存储目录（可配置）

### 配置项
```toml
[server]
http_port = 8080
grpc_port = 50051
quic_port = 4433

[storage]
root_path = "./storage"
chunk_size = 4194304  # 4MB

[nats]
url = "nats://127.0.0.1:4222"
```

## 验证计划

### 单元测试
- 文件存储模块测试
- 元数据管理测试
- 事件发布测试

### 集成测试
- HTTP API 端到端测试
- gRPC 接口测试
- QUIC 传输测试
- NATS 事件推送测试

### 性能测试
- 大文件上传/下载性能
- 并发连接压力测试
- 内存占用测试

## 里程碑

### M1 - 基础框架搭建（第1周）
- [x] 项目初始化
- [ ] 依赖配置
- [ ] 目录结构创建
- [ ] 基础数据模型定义

### M2 - 核心功能实现（第2-3周）
- [ ] 文件存储模块
- [ ] HTTP/gRPC 接口
- [ ] QUIC 传输实现
- [ ] NATS 事件推送

### M3 - 测试与优化（第4周）
- [ ] 单元测试完成
- [ ] 集成测试完成
- [ ] 性能优化
- [ ] 文档完善

## 风险与约束

### 技术风险
- QUIC 协议复杂性较高，需要深入学习
- 大文件传输的内存管理需要优化
- NATS 连接稳定性需要保证

### 约束条件
- 第一阶段仅实现单节点模式
- 暂不考虑数据持久化到数据库
- 暂不实现用户认证功能

## 后续规划
- Phase 2: WebDAV/S3 协议实现
- Phase 3: CRDT 同步与多节点支持
- Phase 4: 用户认证与权限控制
- Phase 5: 分布式存储与副本恢复
